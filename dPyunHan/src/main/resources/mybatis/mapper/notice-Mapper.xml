<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mapper.NoticeMapper">

	<select id="list" parameterType="map" resultType="noticeVO">
		SELECT *
		FROM
		(
		SELECT
		ROW_NUMBER() OVER(ORDER BY n.notice_sn
		<choose>
	        <when test="sortOrder != null and sortOrder == 'asc'">ASC</when>
	        <otherwise>DESC</otherwise>
	    </choose>
		 ) AS rnum
		, n.notice_sn
		, n.notice_sj
		, n.notice_cn
		, n.notice_writng_dt
		, n.emp_id
		, n.file_group_sn
		, n.wnmpy_notice
		, e.nm
		FROM notice n
		LEFT OUTER JOIN emp e ON n.emp_id = e.emp_id
		WHERE n.wnmpy_notice = 0
		<if test="keyword != null and keyword != ''">
			<if test="searchField != null and searchField.length > 0">
			AND (
		<foreach collection="searchField" item="field" separator=" OR ">
			<if test="field == 'noticeSj'">
				n.notice_sj LIKE '%' || #{keyword} || '%'
			</if>
			<if test="field == 'noticeCn'">
				n.notice_cn LIKE '%' || #{keyword} || '%'
			</if>
			<if test="field == 'nm'">
				e.nm LIKE '%' || #{keyword} || '%'
			</if>
		</foreach>
			)
			</if>
		</if>
<!-- 날짜 범위 검색 추가 -->
		<if test="startDate != null and startDate != ''">
				AND TRUNC(n.notice_writng_dt) &gt;= TO_DATE(#{startDate}, 'YYYY-MM-DD')
		</if>
		<if test="endDate != null and endDate != ''">
				AND TRUNC(n.notice_writng_dt) &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
		</if>
		)
		WHERE rnum BETWEEN (#{currentPage} * #{size}) - (#{size} - 1) AND (#{currentPage} * #{size})
	</select>

	<select id="getTotal" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM notice n
		LEFT OUTER JOIN emp e ON n.emp_id = e.emp_id
		WHERE n.wnmpy_notice = 0
		<if test="keyword != null and keyword != ''">
			<if test="searchField != null and searchField.length > 0">
				AND (
		   		<foreach collection="searchField" item="field" separator=" OR ">
	      			  <if test="field == 'noticeSj'">n.notice_sj LIKE '%' || #{keyword} || '%'</if>
	      			  <if test="field == 'noticeCn'">n.notice_cn LIKE '%' || #{keyword} || '%'</if>
	        		  <if test="field == 'nm'">e.nm LIKE '%' || #{keyword} || '%'</if>
	     		 </foreach>
				)
			</if>
		</if>
		<!-- 상태 검색 추가 -->
	<if test="status != null and status != ''">
	  <choose>
	    <when test="status == '1'">AND n.wnmpy_notice = 0</when>
	    <when test="status == '0'">AND n.wnmpy_notice = 1</when>
	  </choose>
	</if>
	
	<!-- 날짜 범위 검색 추가 -->
	<if test="startDate != null and startDate != ''">
		AND TRUNC(n.notice_writng_dt) &gt;= TO_DATE(#{startDate}, 'YYYY-MM-DD')
	</if>
	<if test="endDate != null and endDate != ''">
		AND TRUNC(n.notice_writng_dt) &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
	</if>
	</select>
	
	<!-- 상세 -->
	<select id="findById" parameterType="int" resultType="noticeVO">
		SELECT 
		    ROW_NUMBER() OVER(ORDER BY notice_sn DESC) AS rnum
		  ,	n.notice_sn
		  , n.notice_sj
		  , n.notice_cn
		  , n.notice_writng_dt
		  , n.emp_id
		  , n.file_group_sn
		  , n.wnmpy_notice
		  , e.nm
		FROM notice n
		LEFT OUTER JOIN emp e ON n.emp_id = e.emp_id
		WHERE n.notice_sn = #{noticeSn} 	
	</select>
	
	<select id="getFileDetailVOList" parameterType="long" resultType="fileDetailVO">
		select *
			from file_detail
			where file_group_sn = #{fileGroupSn}
	</select>
	
	<select id="findAll" resultType="NoticeVO">
    SELECT * 
    	FROM notice 
    WHERE wnmpy_notice = 0
    ORDER BY notice_sn DESC
	</select>
	
</mapper>