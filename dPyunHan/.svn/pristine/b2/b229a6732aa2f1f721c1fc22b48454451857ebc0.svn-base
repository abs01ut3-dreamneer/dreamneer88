document.addEventListener("DOMContentLoaded", function() {
    // 폼 찾기
    (function initSearchAjax() {
        const searchForm = document.querySelector('.manage-wrapper form');
        document.querySelector('form[action="/rqest/rqest"]');
        if (!searchForm) return;
        const ymInput = searchForm.querySelector('input[name="ym"]');
        const searchBtn = searchForm.querySelector('#searchBtn');
        // 결과를 넣을 컨테이너가 없으면 폼 아래에 자동 생성
        const resultDiv = document.getElementById("rqestResult");
        if (!resultDiv) return;
        // 폼 제출 막고 fetch
        searchForm.addEventListener("submit", function(e) {
            e.preventDefault();
            doSearch();
        });

        if (searchBtn) {
            searchBtn.addEventListener("click", function(e) {
                e.preventDefault();
                doSearch();
            });
        }
        async function doSearch() {
            const ym = ymInput ? ymInput.value : "";
            if (!ym) {
                alert("조회할 연월을 선택하세요.");
                return;
            }
            try {
                // JSON
                const res = await fetch(`/rqest/listAjax?ym=${ym}`);
                if (!res.ok) {
                    resultDiv.innerHTML = "<p>조회 중 오류가 발생했습니다.</p>";
                    return;
                }
                const rqestList = await res.json();
                if (!rqestList || rqestList.length === 0) {
                    resultDiv.innerHTML = "<p>해당 월의 관리비 내역이 없습니다.</p>";
                    return;
                }
                let html = '<table class="table table-bordered mt-3">';
                html += '<thead><tr><th>#</th><th>납부월</th><th>금액</th><th>상태</th><th>상세보기</th></tr></thead><tbody>';
                rqestList.forEach((r, idx) => {
                    const statusTxt = r.status || (r.paySttusNm || "미납");
                    const isPaid = (statusTxt === "납부완료") || (r.paySttus === "PAID");
                    const amountN = Number(r.managectTotAmount ?? r.totalAmount ?? r.rqestAmount ?? r.amount ?? 0);
                    const amount = amountN.toLocaleString() + "원";
                    const ymTxt = r.rqestYm ?? r.ym ?? r.yearMonth ?? "";

                    html += `
      <tr class="rqest-card">
        <td></td>
        <td>${ymTxt}</td>
        <td>${amount}</td>
        <td class="rqest-info">
          <span class="${isPaid ? 'status-paid' : 'status-unpaid'}">${isPaid ? '납부완료' : '미납'}</span>
        </td>
        <td>
          <a href="/rqest/rqest?ym=${ymTxt}&hshldId=${hshldId}" class="btn btn-secondary">상세보기</a>
        </td>
      </tr> 
      <tr>
        <td colspan="6">
          <div id="detail-${r.rqestSn}" style="display:none;"></div>
        </td>
      </tr>
    `;
                });

                html += "</tbody></table>";
                resultDiv.innerHTML = html;
                if (window.attachRqestEvents) {
                    window.attachRqestEvents(resultDiv);
                }
            } catch (e) {
                console.error(e);
            }
        }
    })();

    document.addEventListener("click", async function(e) {
        const target = e.target.closest(".payBtn");
        if (target) {
            e.preventDefault();

            const rqestSn = target.dataset.sn;
            const amount = Number(target.dataset.amount);
            const ym = target.dataset.ym;

        }
    });
});