<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<%@ include file="../include/header.jsp"%>

<!DOCTYPE html>
<html>
<head>
    <title>방문 차량 예약</title>
    <style>
        body { background: #f5f5f5; font-family: Arial, sans-serif; }
        .container { max-width: 800px; margin: 50px auto; padding: 20px; }
        h2 { text-align: center; margin-bottom: 30px; }
        .card { background: #fff; border-radius: 12px; padding: 25px 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; overflow: visible; }
        .card p { margin: 8px 0; line-height: 1.6; font-size: 1em; }
        .card span { color: #007bff; font-weight: bold; }
        .btn-primary { padding: 10px 25px; font-size: 1em; font-weight: 600; border: none; border-radius: 8px; background: #007bff; color: #fff; cursor: pointer; transition: 0.3s; z-index: 10; }
        .btn-primary:hover { background: #0056b3; }
        .button-group { display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .button-group button { flex: 1; min-width: 140px; z-index: 10; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); overflow-y: auto; }
        .modal-content { background: #fff; width: 500px; max-width: 90%; margin: 80px auto; padding: 25px 30px; border-radius: 10px; position: relative; }
        .close { position: absolute; right: 15px; top: 10px; font-size: 22px; cursor: pointer; }
        input[type="text"], input[type="datetime-local"], input[type="month"] { width: 100%; padding: 8px; margin: 6px 0; border: 1px solid #ccc; border-radius: 5px; }

        #historyModal .modal-content { width: 700px; max-width: 95%; }
        .history-list { display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; padding: 5px; }
        .history-card { background: #fff; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 15px 20px; display: flex; flex-direction: column; gap: 6px; font-size: 0.9em; transition: 0.2s; }
        .history-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .history-vehicle { font-size: 1em; font-weight: 600; color: #007bff; }
        .history-datetime { color: #555; }
        .history-info { font-size: 0.85em; color: #666; }
        .success-msg { color: green; text-align: center; margin: 10px 0; display:none; }
        .filter-group { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>
<div class="container">
    <h2>방문 차량 예약</h2>
    <div class="card">
        <p>세대별 월 예약 가능 시간은 <span>120시간</span> 입니다.</p>
        <p>매월 1일 사용시간이 초기화 됩니다.</p>
        <hr>
        <p>이번달 방문 예약 가능 주차시간은 <span id="remainingTime">${remainingTime}</span> 시간 남았습니다.</p>
        <p>누적 사용시간 : <span id="accmltTime">${accmltTime}</span>시간</p>

        <p id="reserveSuccess" class="success-msg">예약이 완료되었습니다!</p>

        <div class="button-group">
            <button id="openReserveModalBtn" class="btn-primary">방문 차량 예약하기</button>
            <button id="openHistoryModalBtn" class="btn-primary">예약 내역 보기</button>
        </div>
    </div>
</div>

<!-- 예약 모달 -->
<div id="reserveModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h4 style="text-align:center; margin-bottom:10px;">방문 차량 예약</h4>
        <form id="reserveForm">
            <label>차량 번호</label>
            <input type="text" name="vhcleNo" placeholder="예: 12가3456" required>

            <label>입차 시간</label>
            <input type="datetime-local" name="startDt" step="3600" required>

            <label>출차 시간</label>
            <input type="datetime-local" name="endDt" step="3600" required>

            <button type="submit" class="btn-primary" style="margin-top:10px;">예약 완료</button>
        </form>
    </div>
</div>

<!-- 예약 내역 모달 -->
<div id="historyModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeHistoryModal">&times;</span>
        <h4 style="text-align:center; margin-bottom:10px;">방문 차량 예약 내역</h4>

        <!-- 월별 필터 -->
        <div class="filter-group">
            <label for="monthSelect"></label>
            <input type="month" id="monthSelect">
            <button id="filterMonthBtn" class="btn-primary">조회</button>
        </div>

        <div class="history-list" id="historyList">
            <c:forEach var="visit" items="${history}">
                <div class="history-card" data-month="<fmt:formatDate value='${visit.parkngBeginDt}' pattern='yyyy-MM'/>">
                    <div class="history-vehicle">차량번호: ${visit.vhcleNo}</div>
                    <div class="history-datetime">
                        입차: <fmt:formatDate value="${visit.parkngBeginDt}" pattern="yyyy.MM.dd HH:mm" /><br>
                        출차: <fmt:formatDate value="${visit.parkngEndDt}" pattern="yyyy.MM.dd HH:mm" />
                    </div>
                    <div class="history-info">
                        예약신청: <fmt:formatDate value="${visit.visitReqstDt}" pattern="yyyy.MM.dd HH:mm" />
                    </div>
                </div>
            </c:forEach>
            <c:if test="${empty history}">
                <p style="text-align:center; color:#888;">등록된 예약 내역이 없습니다.</p>
            </c:if>
        </div>
    </div>
</div>

<script>
    const reserveModal = document.getElementById("reserveModal");
    const historyModal = document.getElementById("historyModal");
    const openReserveBtn = document.getElementById("openReserveModalBtn");
    const openHistoryBtn = document.getElementById("openHistoryModalBtn");
    const closeReserveBtn = reserveModal.querySelector(".close");
    const closeHistoryBtn = document.getElementById("closeHistoryModal");

    const remainingTimeSpan = document.getElementById("remainingTime");
    const accmltTimeSpan = document.getElementById("accmltTime");
    const reserveSuccessMsg = document.getElementById("reserveSuccess");

    // 모달 열기/닫기
    openReserveBtn.onclick = () => reserveModal.style.display = "block";
    closeReserveBtn.onclick = () => reserveModal.style.display = "none";
    openHistoryBtn.onclick = () => historyModal.style.display = "block";
    closeHistoryBtn.onclick = () => historyModal.style.display = "none";

    window.onclick = (e) => {
        if(e.target === reserveModal) reserveModal.style.display = "none";
        if(e.target === historyModal) historyModal.style.display = "none";
    };

    // 예약 폼 AJAX 처리
    document.getElementById("reserveForm").onsubmit = function(e){
        e.preventDefault();
        const formData = new FormData(this);

        fetch('${pageContext.request.contextPath}/visit/reserve', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                remainingTimeSpan.textContent = data.remainingTime;
                accmltTimeSpan.textContent = data.accmltTime;
                reserveSuccessMsg.style.display = "block";
                reserveModal.style.display = "none";
                setTimeout(() => location.reload(), 1000);
            } else {
                alert("예약에 실패했습니다. 다시 시도해주세요.");
            }
        })
        .catch(err => console.error(err));
    };

    // 월별 필터링
    const filterBtn = document.getElementById("filterMonthBtn");
    const monthInput = document.getElementById("monthSelect");
    const historyList = document.getElementById("historyList");

    filterBtn.onclick = () => {
        const selectedMonth = monthInput.value; // "YYYY-MM"
        if(!selectedMonth) return alert("월을 선택하세요.");

        const cards = historyList.querySelectorAll(".history-card");
        let hasData = false;

        cards.forEach(card => {
            if(card.dataset.month === selectedMonth) {
                card.style.display = "flex";
                hasData = true;
            } else {
                card.style.display = "none";
            }
        });

        if(!hasData) {
            historyList.innerHTML = '<p style="text-align:center; color:#888;">등록된 예약 내역이 없습니다.</p>';
        }
    };
</script>

<%@ include file="../include/footer.jsp"%>
</body>
</html>
