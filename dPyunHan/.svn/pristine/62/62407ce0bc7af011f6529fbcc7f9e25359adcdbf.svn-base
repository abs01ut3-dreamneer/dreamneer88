// visitVhcle.js ì „ì²´ ì½”ë“œ

// ëª¨ë‹¬ ê´€ë ¨ ìš”ì†Œ
const historyModal = document.getElementById("historyModal");
const openHistoryBtn = document.getElementById("openHistoryModalBtn");
const closeHistoryBtn = document.getElementById("closeHistoryModal");

// ëª¨ë‹¬ ì—´ê¸°
if (openHistoryBtn && historyModal) {
    openHistoryBtn.onclick = () => {
        historyModal.style.display = "block";
        const filterBtn = document.getElementById("filterBtn");
        if (filterBtn) filterBtn.click();
    };
}

// ëª¨ë‹¬ ë‹«ê¸°
if (closeHistoryBtn && historyModal) {
    closeHistoryBtn.onclick = () => historyModal.style.display = "none";
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
window.onclick = (e) => {
    if (e.target === historyModal) historyModal.style.display = "none";
};

// ------------------------------
// ê³µí†µ: ë‚¨ì€ì‹œê°„/ëˆ„ì ì‹œê°„ ê°±ì‹  í•¨ìˆ˜
// ------------------------------
function updateRemainAccmltTime() {
    fetch(`${prc}/visit/reserveData`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById("remainingTime").textContent = data.remainingTime + " ì‹œê°„";
                document.getElementById("accmltTime").textContent = data.accmltTime + " ì‹œê°„";
            }
        })
        .catch(err => console.error("ì‹œê°„ ê°±ì‹  ì˜¤ë¥˜:", err));
}

// ------------------------------
// DOMContentLoaded
// ------------------------------
document.addEventListener("DOMContentLoaded", function() {

    const remainingTimeSpan = document.getElementById("remainingTime");
    const accmltTimeSpan = document.getElementById("accmltTime");
    const reserveForm = document.getElementById("reserveForm");
    const reserveModalEl = document.getElementById("reserveModal");
    const reserveModal = reserveModalEl ? bootstrap.Modal.getOrCreateInstance(reserveModalEl) : null;

    // íŽ˜ì´ì§€ ë¡œë“œ ì‹œ ë‚¨ì€ì‹œê°„/ëˆ„ì ì‹œê°„ ì´ˆê¸° ë¶ˆëŸ¬ì˜¤ê¸°
    updateRemainAccmltTime();

    // ------------------------------
    // ðŸ”¥ ì˜ˆì•½ í¼ ì œì¶œ (alert â†’ Swal êµì²´)
    // ------------------------------
    if (reserveForm) {
        reserveForm.onsubmit = function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch(`${prc}/visit/reserve`, {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {

                    // Swal â†’ ë‹«ížŒ ë’¤ ì‹œê°„ ê°±ì‹  + ëª¨ë‹¬ ë‹«ê¸°
                    Swal.fire({
                        icon: "success",
                        title: "ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!",
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        updateRemainAccmltTime();

                        if (reserveModal) {
                            reserveModal.hide();
                        }

                        reserveForm.reset();
                    });

                } else {
                    Swal.fire({
                        icon: "error",
                        title: "ì˜ˆì•½ ì‹¤íŒ¨",
                        text: data.message || "ì˜ˆì•½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
                    });
                }
            })
            .catch(err => {
                console.error(err);
                Swal.fire({
                    icon: "error",
                    title: "ì„œë²„ ì˜¤ë¥˜",
                    text: "ìž ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
                });
            });
        };
    }

});

// ------------------------------
// URL íŒŒë¼ë¯¸í„°ë¡œ ëª¨ë‹¬ ìžë™ì˜¤í”ˆ
// ------------------------------
document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const open = params.get("open");

    if (open === "visitVhcle") {
        showModal("reserveModal");

        const url = new URL(window.location.href);
        url.searchParams.delete("open");
        window.history.replaceState({}, "", url.toString());
    }
});
