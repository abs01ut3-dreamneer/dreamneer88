<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<!DOCTYPE html>
<html>
<head>
<title>게시판 관리</title>
<style>
    .radio-group {
        display: flex;
        gap: 40px;
        margin-top: 10px;
    }
</style>
<script>
document.addEventListener("DOMContentLoaded", function(){

    // 게시판 목록 로드
    loadBbsGroupList();

    // 게시판 생성 처리
    document.querySelector("#postBbsGroup").addEventListener("click", function(){
        
        const bbsNm = document.querySelector("#bbsNm").value;
        const answerAt = document.querySelector("input[name='answerAt']:checked");
        const atchFileAt = document.querySelector("input[name='atchFileAt']:checked");
        
        if(!bbsNm || bbsNm.trim() === ""){
            alert("게시판 이름을 입력하세요");
            return;
        }
        
        if(!answerAt){
            alert("댓글 작성 여부를 선택하세요");
            return;
        }
        
        if(!atchFileAt){
            alert("파일 첨부 여부를 선택하세요");
            return;
        }
        
        // 전송 데이터
        let data = {
            "bbsNm": bbsNm,
            "answerAt": answerAt.value,
            "atchFileAt": atchFileAt.value
        };
        
        console.log("전송 데이터:", data);
        
        // fetch 요청
        fetch("/bbs/postBbsGroup", {
            method: "POST",
            headers: {"Content-Type": "application/json;charset=UTF-8"},
            body: JSON.stringify(data)
        })
        .then(response => {
            if(!response.ok){
                throw new Error("서버 응답 오류");
            }
            return response.json();
        })
        .then(result => {
            console.log("result:", result);
            alert("게시판이 생성되었습니다.");
            
            // 폼 초기화
            document.querySelector("#bbsNm").value = "";
            document.querySelectorAll("input[name='answerAt']").forEach(radio => radio.checked = false);
            document.querySelectorAll("input[name='atchFileAt']").forEach(radio => radio.checked = false);
            
            // 모달 닫기
            $('#createBbsModal').modal('hide');
            
            // 목록 새로고침
            loadBbsGroupList();
        })
        .catch(error => {
            console.error("error:", error);
            alert("Fetch 요청 오류 발생: " + error);
        });
    });

    // 취소 버튼
    document.querySelector("#btnCancel").addEventListener("click", function(){
        // 폼 초기화
        document.querySelector("#bbsNm").value = "";
        document.querySelectorAll("input[name='answerAt']").forEach(radio => radio.checked = false);
        document.querySelectorAll("input[name='atchFileAt']").forEach(radio => radio.checked = false);
    });

    // 모달이 닫힐 때 폼 초기화
    $('#createBbsModal').on('hidden.bs.modal', function () {
        document.querySelector("#bbsNm").value = "";
        document.querySelectorAll("input[name='answerAt']").forEach(radio => radio.checked = false);
        document.querySelectorAll("input[name='atchFileAt']").forEach(radio => radio.checked = false);
    });

})

// 게시판 목록 로드 함수
function loadBbsGroupList(){
    fetch("/bbs/bbsGroupList/data", {
        method:"GET"
    })
    .then(response=>{
        if(!response.ok){
            throw new Error("서버 응답 오류")
        }
        return response.json();
    })
    .then(data=>{
        console.log("게시판 목록:", data);
        displayBbsGroupList(data);
    })
    .catch(error=>{
        console.error("목록 로드 오류:",error);
    })
}

// 게시판 목록 표시 함수
function displayBbsGroupList(bbsGroupList){
    const tbody = document.querySelector("#bbsGroupListBody");
    tbody.innerHTML = "";

    if(bbsGroupList.length === 0){
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center;">등록된 게시판이 없습니다.</td>
            </tr>
        `;
        return;
    }

    bbsGroupList.forEach(bbsGroup => {
        console.log("bbsGroup: ", bbsGroup);
        console.log("bbsGroup.bbsGroupSn: ", bbsGroup.bbsGroupSn);
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>\${bbsGroup.bbsGroupSn}</td>
            <td><a href="/bbs/board/\${bbsGroup.bbsGroupSn}">\${bbsGroup.bbsNm}</a></td>
            <td>\${bbsGroup.answerAt == 1 ? '가능' : '불가'}</td>
            <td>\${bbsGroup.atchFileAt == 1 ? '가능' : '불가'}</td>
        `;
        tbody.appendChild(tr);
    });
}

</script>
</head>
<body>

<%@ include file="../include/header.jsp"%>

<div class="jumbotron">
    <div class="container">
       <h1 class="display-3">게시판 목록</h1>       
    </div>
</div>

<!-- /// body 시작 /// -->
<div class="container">
    
    <!-- 게시판 생성 버튼 -->
    <div style="margin-bottom: 20px;">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createBbsModal">
            게시판 생성
        </button>
    </div>

    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="width: 30px">#</th>
                            <th>게시판 이름</th>
                            <th>댓글 작성 여부</th>
                            <th>파일 첨부 여부</th>
                        </tr>
                    </thead>
                    <tbody id="bbsGroupListBody">
                        <!-- 게시판 목록이 동적으로 로드 -->
                    </tbody>
                </table>
            </div>
            <div class="card-footer clearfix">
                ${articlePage.pagingArea}
            </div>
        </div>
    </div>
</div>

<!-- 게시판 생성 모달 -->
<div class="modal fade" id="createBbsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">새 게시판 생성</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="bbsNm">게시판 이름</label>
                    <input type="text" id="bbsNm" name="bbsNm" class="form-control" placeholder="게시판 이름을 입력하세요">
                </div>
                
                <div class="radio-group">
                    <div class="form-group">
                        <label>댓글 작성 여부</label><br>
                        <div>
                            <input type="radio" id="answerAtOk" name="answerAt" value="1">
                            <label for="answerAtOk">댓글 작성 가능</label>
                        </div>
                        <div>
                            <input type="radio" id="answerAtNo" name="answerAt" value="2">
                            <label for="answerAtNo">댓글 작성 불가</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>파일 첨부 여부</label><br>
                        <div>
                            <input type="radio" id="atchFileAtOk" name="atchFileAt" value="1">
                            <label for="atchFileAtOk">파일 첨부 가능</label>
                        </div>
                        <div>
                            <input type="radio" id="atchFileAtNo" name="atchFileAt" value="2">
                            <label for="atchFileAtNo">파일 첨부 불가</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnCancel" class="btn btn-secondary" data-dismiss="modal">취소</button>
                <button type="button" id="postBbsGroup" class="btn btn-primary">생성</button>
            </div>
        </div>
    </div>
</div>

<!-- /// body 끝 /// -->

<%@ include file="../include/footer.jsp"%>

</body>
</html>