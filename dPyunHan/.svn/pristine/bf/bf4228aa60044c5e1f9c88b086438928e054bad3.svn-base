<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<!DOCTYPE html>
<html>
<head>
<title>게시글 수정</title>
<script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
<script type="text/javascript">
/* ckeditor 사용해봄 */
let editor;

document.addEventListener("DOMContentLoaded", function(){

	const bbsDetailNo = ${bbs.bbsDetailNo};

	console.log("fileDetailNo : ", ${bbs.bbsDetailNo});
	
    // CKEditor 초기화
    ClassicEditor
        .create(document.querySelector('#cn'))
        .then(newEditor => {
            editor = newEditor;
            // 기존 내용 설정
            editor.setData(`${bbs.cn}`);
        })
        .catch(error => {
            console.error('Editor error:', error);
        });


	document.querySelector("#updateBtn").addEventListener("click",function(){

		const sj = document.querySelector("#sj").value;
		const cn = editor.getData();

		console.log("sj :", sj);
		console.log("cn :", cn);
		
		if(!sj || sj.trim() === "") {
			alert("제목을 입력하세요.");
			return;
		}
		
		if(!cn || cn.trim() === "") {
			alert("내용을 입력하세요.");
			return;
		}

		// 전송 데이터
		let data = {
			"bbsDetailNo" : bbsDetailNo,
			"sj" : sj,
			"cn" : cn
		};

		//fetch 요청
		fetch("/bbs/update",{
			method: "POST",
			headers: {"Content-Type": "application/json;charset=UTF-8"},
			body: JSON.stringify(data)
		})
		.then(response=>{
			if(!response.ok){
				throw new Error("서버 응답 오류");
			}
			return response.json();
		})
		.then(result=>{
			if(result.result>0){
				alert("게시글이 수정되었습니다.");
                location.href = "/bbs/detail/" + result.bbsDetailNo;
            } else {
                alert(result.message);
            }
		})
        .catch(error => {
            console.error("error:", error);
            alert("Fetch 요청 오류 발생: " + error);
        });
	})

    document.querySelector("#cancelBtn").addEventListener("click", function(){
        if(confirm("수정을 취소하시겠습니까?")) {
            location.href = "/bbs/detail/${bbs.bbsDetailNo}";
        }
    });
});

</script>
</head>
<body>


<%@ include file="../include/header.jsp"%>

<!-- /// 타이틀 시작 /// -->
 <div class="d-sm-flex align-items-center justify-content-between mb-4">
     <h1 class="h3 mb-0 text-gray-800">게시글 수정</h1>
 </div>
 <!-- /// 타이틀 끝 /// -->

<!-- /// body 시작 /// -->
	<div class="card card-primary">
		<div class="card-header">
			<h3 class="card-title">게시글 수정</h3>
		</div>
		<!-- /.card-header -->
		<!-- form start -->
		<form action="register" method="post">
			<div class="card-body">
				<div class="form-group">
					<label for="cn">제목</label>
					<input type="text" class="form-control" id="sj"	name="sj" value="${bbs.sj}">
				</div>
				<div class="form-group">
					<label for="sj">내용</label>
					<textarea class="form-control" id="cn" name="cn"></textarea>
				</div>
				<div class="form-group">
					<label for="exampleInputFile">파일 첨부</label>
					<div class="input-group">
						<div class="custom-file">
							<input type="file" class="custom-file-input"
								id="exampleInputFile"> <label class="custom-file-label"
								for="exampleInputFile">Choose file</label>
						</div>
						<div class="input-group-append">
							<span class="input-group-text">Upload</span>
						</div>
					</div>
				</div>
			</div>
			<!-- /.card-body -->

		    <div class="card-footer">
		        <button type="button" id="updateBtn" class="btn btn-primary">수정</button>
		        <button type="button" id="cancelBtn" class="btn btn-secondary">취소</button>
		    </div>
		</form>
	</div>


	<!-- /// body 끝 /// -->

<%@ include file="../include/footer.jsp"%>

</body>
</html>