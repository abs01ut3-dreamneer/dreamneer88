<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="/css/filter.css">
<title>민원 리스트</title>
</head>
<body>

<%@ include file="../include/header.jsp"%>

<div class="d-sm-flex align-items-center justify-content-between mb-4">
	<h1 class="h3 mb-0 text-gray-800">민원 리스트</h1>
</div>

<form action="/" method="get" class="filter-form">
	<div class="filter-card">
		<div class="filter-card-header">
			<h3 class="filter-card-title">검색 필터</h3>
			<button type="button" class="filter-btn-toggle"
				onclick="toggleFilter()">
				<span class="filter-toggle-text">설정</span> <i
					class="fas fa-chevron-down"></i>
			</button>
		</div>

		<div class="filter-card-body collapsed" id="filterBody">
			<!-- Row 1 -->
			<div class="filter-row">

				<!-- 검색 필드 셀 -->
				<div class="filter-cell">
					<div class="filter-cell-label">검색 필드</div>
					<div class="filter-cell-content">
						<div class="filter-control-inline">
							<label class="filter-checkbox"> <input type="checkbox"
								name="searchField" value="noticeSj" /> <span>번호</span>
							</label> <label class="filter-checkbox"> <input type="checkbox"
								name="searchField" value="noticeCn" /> <span>내용</span>
							</label> <label class="filter-checkbox"> <input type="checkbox"
								name="searchField" value="nm" /> <span>직원명</span>
							</label>
						</div>
					</div>
				</div>

				<!-- 정렬 셀 -->
				<div class="filter-cell">
					<div class="filter-cell-label">정렬</div>
					<div class="filter-cell-content">
						<div class="filter-control-inline">
							<label class="filter-radio"> <input type="radio"
								name="sortOrder" value="desc" checked /> <span>최신순</span>
							</label> <label class="filter-radio"> <input type="radio"
								name="sortOrder" value="asc" /> <span>오래된순</span>
							</label>
						</div>
					</div>
				</div>

				<!-- 상태 셀 -->
				<div class="filter-cell">
					<div class="filter-cell-label">상태</div>
					<div class="filter-cell-content">
						<select name="status" class="filter-control">
							<option value="">전체</option>
							<option value="1">활성</option>
							<option value="0">비활성</option>
						</select>
					</div>
				</div>

				<!-- 날짜 범위 셀 -->
				<div class="filter-cell">
					<div class="filter-cell-label">날짜 범위</div>
					<div class="filter-cell-content">
						<div class="filter-input-group">
							<input type="date" name="startDate" class="filter-control"
								value="${param.startDate}" /> <span
								class="filter-input-group-text">~</span> <input type="date"
								name="endDate" class="filter-control" value="${param.endDate}" />
						</div>
					</div>
				</div>

			</div>
		</div>

		<div class="filter-search-footer">
			<div class="filter-search-wrapper">
				<input type="text" name="keyword" class="filter-input"
					placeholder="검색어..." value="${keyword}" />
			</div>
			<button type="submit" class="filter-btn filter-btn-primary">검색</button>
			<a href="/" class="filter-btn filter-btn-secondary">초기화</a>
		</div>
	</div>
</form>

<div class="d-flex justify-content-end mb-3">
	<button type="button" class="btn btn-primary"
		onclick="cvplRegisterModal()">민원 등록</button>
</div>

<script>
function toggleFilter() {
	const filterBody = document.getElementById('filterBody');
	const toggleBtn = document.querySelector('.filter-btn-toggle i');
	
	filterBody.classList.toggle('collapsed');
	toggleBtn.classList.toggle('rotated');
}
</script>




	<table class="table table-striped table-bordered">
		<thead>
			<tr>
				<th>민원번호</th>
				<th>회원명</th>
				<th>민원제목</th>
				<th>신청일시</th>
				<th>부서명</th>
				<th>처리현황</th>
			</tr>
		</thead>
		<tbody id="cvplListTbody">
			<c:forEach var="cvplVO" items="${articlePage.content}">
				<tr onclick="cvplDetailModal(${cvplVO.cvplSn})"
					style="cursor: pointer;">
					<td>${cvplVO.cvplSn}</td>
					<td>${cvplVO.mberNm}</td>
					<td>${cvplVO.cvplSj}</td>
					<td><fmt:formatDate value="${cvplVO.reqstDt}"
							pattern="yyyy-MM-dd HH:mm:ss" /></td>
					<td>${cvplVO.deptVO.deptNm}</td>
					<td>
						<!-- 처리현황 상태값 --> <c:set var="rceptSttus"
							value="${cvplVO.cvplManageVO.cvplRceptVO.rceptSttus}" /> <c:choose>
							<c:when test="${empty rceptSttus}">
         	 				처리대기
        					</c:when>
							<c:when test="${rceptSttus == 1}">
         					처리중
        					</c:when>
							<c:when test="${rceptSttus == 2}">
        				    처리완료
       						</c:when>
							<c:otherwise>
         					오류
       						</c:otherwise>
						</c:choose>
					</td>

					<%-- 필요할까? 리스트의 파일여부가 
    			<td>${cvplVO.fileGroupSn > 0 ? "있음" : "없음"}</td>
    			  <p>${cvplVO.fileGroupSn}</p> --%>
				</tr>
			</c:forEach>
		</tbody>
	</table>

	<!-- 페이지네이션 UI -->
	<div class="card-footer clearfix">${articlePage.pagingArea}</div>

	<!-- ===== 상세보기 모달 시작 ===== -->

	<div class="modal" id="detailModal">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header bg-primary text-white">
					<h5 class="modal-title">민원 상세정보</h5>
					<button type="button" class="btn-close btn-close-white"
						data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<table class="table table-striped table-bordered">
						<tr>
							<th>민원번호</th>
							<td>
								<div id="cvplSn"></div> <input type="hidden" id="cvplSnHidden" />
							</td>

						</tr>
						<tr>
							<th>회원명</th>
							<td>
								<div id="mberId"></div>
							</td>
						</tr>
						<tr>
							<th>민원제목</th>
							<td>
								<div id="cvplSj"></div> <input type="text" id="cvplSjInput"
								class="form-control" style="display: none;" />
							</td>
						</tr>
						<tr>
							<th>민원내용</th>
							<td>
								<div id="cvplCn"></div> <textarea id="cvplCnInput"
									class="form-control" style="display: none;"></textarea>
							</td>
						</tr>
						<tr>
							<th>신청일시</th>
							<td><div id="reqstDt"></div></td>
						</tr>
						<tr>
							<th>부서명</th>
							<td>
								<div id="deptNm"></div>
							</td>
						</tr>
						<tr>
							<th>처리상태</th>
							<td><div id="rceptSttus"></div></td>
						</tr>
						<tr>
							<th>첨부파일</th>
							<td><div id="fileDetailVOList"></div></td>
						</tr>
					</table>
				</div>
				<div class="modal-footer">
					<button type="button" id="editBtn" class="btn btn-warning me-2"
						onclick="editMode()">수정</button>
					<button type="button" id="saveBtn" class="btn btn-success me-2"
						onclick="saveCvpl()" style="display: none;">저장</button>
					<button type="button" class="btn-close btn-close-white"
						data-dismiss="modal">닫기</button>
				</div>
			</div>
		</div>
	</div>

	<!-- ===== 상세보기 모달 끝 ===== -->


	<!-- ===== 등록보기 모달 시작 ===== -->
	<form id="registerForm" enctype="multipart/form-data">
		<div class="modal" id="registerModal">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header bg-primary text-white">
						<h5 class="modal-title">민원 등록</h5>
						<button type="button" class="btn-close btn-close-white"
							data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<div class="mb-3">
							<label for="cvplSj">민원 제목</label> <input id="cvplSj" type="text"
								name="cvplSj" required />
						</div>
						<div class="mb-3">
							<label for="cvplCn">민원 내용</label>
							<textarea id="cvplCn" name="cvplCn" required></textarea>
						</div>
						<div class="mb-3">
							<label for="deptCode">부서명</label> <select id="deptCode"
								name="deptCode" required>

							</select>
						</div>
						<div class="mb-3">
							<label>첨부파일</label> <input type="file" id="multipartFiles"
								name="multipartFiles" multiple />
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary me-2"
							onclick="cvplRegister()">등록</button>
						<button type="button" class="btn btn-primary" data-dismiss="modal">
							닫기</button>
					</div>
				</div>
			</div>
		</div>
	</form>
	<!-- ===== 등록보기 모달 끝 ===== -->




<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(){

	// 페이지 로드시 특정 민원 모달 자동 띄우기
    const cvplSn = "${cvplSnForDetail}";
	if (cvplSn !== "") {
        // 리스트 숨기지 않고 모달만 표시
		console.log("자동 상세 호출 cvplSn:", cvplSn);
		cvplDetailModal(cvplSn);
	}
	
	<!-- ===== 리스트 리로드 함수 script 시작 ===== -->
	window.listAjax = function(){
		fetch("/cvpl/listAjax",{
			method:"post",
			body: new URLSearchParams({ currentPage: 1, keyword: '', size: 10 })
		})
		.then(resp =>{
			return resp.json();
		})
		.then(data =>{
			console.log("data", data);
			
			 // 나중에 이거 함수 따로 빼도됨 공부해보고 빼자
		    const tbody = document.querySelector("#cvplListTbody");
		    tbody.innerHTML = '';
		    
		    //데이터 확인을 위한 정상적으로 없으면 
		    //데이터가 있으면 forEach실행
		    if(!data.articlePage.content || data.articlePage.content.length === 0) {
		      tbody.innerHTML = '<tr><td colspan="7">데이터가 없습니다</td></tr>';
		      return;
		    } 
		    
		    data.articlePage.content.forEach(item => {
		      const tr = document.createElement("tr");
		      tr.onclick = () => cvplDetailModal(item.cvplSn);
		      tr.innerHTML = `
		        <td>\${item.cvplSn}</td>
		        <td>\${item.mberNm}</td>
		        <td>\${item.cvplSj}</td>
		        <td>\${new Date(item.reqstDt).toLocaleString()}</td>
		        <td>\${item.deptVO.deptNm}</td>
		        <td>\${getStatus(item.cvplManageVO?.cvplRceptVO?.rceptSttus)}</td>
		      `;
		      tbody.appendChild(tr);
		    });
		  })
		  .catch(error => console.log("리로드 에러:", error));
		}
	
	<!-- ===== 상세보기 모달 script 시작 ===== -->
	window.cvplDetailModal = function(cvplSn){
		
		let data ={
				"cvplSn" : cvplSn
		}
		
		fetch("/cvpl/cvplDetailModal", {
			method: "post",
			headers: {
				"Content-type":"application/json;charset=UTF-8"
			},
			body: JSON.stringify(data)
			
		})
		.then(resp => {
			return resp.json();
		})
		.then(data => {
			const cvpl = data.cvplVO;
			const fileDetailVOList = data.fileDetailVOList;	
			
			console.log("data : ",data);
			console.log("fileDetailVOList: ",fileDetailVOList);	
		      
			
			  document.querySelector("#cvplSn").textContent = cvpl.cvplSn;
		      document.querySelector("#mberId").textContent = cvpl.mberNm;
		      document.querySelector("#cvplSj").textContent = cvpl.cvplSj;
		      document.querySelector("#cvplCn").textContent = cvpl.cvplCn;
		      document.querySelector("#reqstDt").textContent = new Date(cvpl.reqstDt).toLocaleString();
		      document.querySelector("#deptNm").textContent = cvpl.deptVO.deptNm;
		      document.querySelector("#rceptSttus").textContent = getStatus(cvpl.cvplManageVO?.cvplRceptVO?.rceptSttus);
	 
	          //수정용
	          document.querySelector("#cvplSnHidden").value = cvpl.cvplSn;
	          document.querySelector("#cvplSj").textContent = cvpl.cvplSj;
	          document.querySelector("#cvplSjInput").value = cvpl.cvplSj;
	          
	          document.querySelector("#cvplCn").textContent = cvpl.cvplCn;
	          document.querySelector("#cvplCnInput").value = cvpl.cvplCn;
		      
	          // 파일 처리
	          let filesHtml = '';
	          if (fileDetailVOList && fileDetailVOList.length > 0) {
	            filesHtml = fileDetailVOList.map(fileDetailVO => `<img src="/upload\${fileDetailVO.fileStrelc}" style="height: 100px; margin: 5px;">`).join('');
	          } else {
	            filesHtml = '<p>첨부된 파일이 없습니다.</p>';
	          }
	          document.querySelector("#fileDetailVOList").innerHTML = filesHtml;
	          
	          
	          // 모달 띄우기
	          new bootstrap.Modal(document.querySelector('#detailModal')).show();
	          
	        })
	        .catch(error => console.log('에러:', error));
	      };
	      
	      // 상태 변환 함수
	      window.getStatus = function(status) {
	        if (!status) return '처리대기';
	        if (status == 1) return '처리중';
	        if (status == 2) return '처리완료';
	        return '오류';
	      };
	      
	// ===== 상세보기 모달 script 끝 =====
	
	
	// ===== 등록보기 모달 시작 ===== 
		
	window.cvplRegisterModal = function(){
		
		fetch("/cvpl/cvplRegisterModal",{
			method: "GET"	
		})
			.then(resp => {
				return resp.json();
			})
			.then(data => {
				
				let deptOptions = `<option value="">선택하세요</option>`;
				data.deptVOList.forEach(dept =>{
					deptOptions += `<option value="\${dept.deptCode}">\${dept.deptNm}</option>`;
					console.log("deptOptions", deptOptions);
				});
				document.querySelector("#deptCode").innerHTML = deptOptions;
				
				new bootstrap.Modal(document.querySelector("#registerModal")).show();
				
		})
		.catch(error => console.log(error));
	}
			
	// ===== 등록보기 모달 끝 =====
		
		
	// ===== 등록 슛  =====
		
		window.cvplRegister = function(){
		
		const form = document.querySelector("#registerForm");
		const formData = new FormData(form);
		
		fetch("/cvpl/cvplRegister",{
			method : "POST",
			body: formData
		})
		.then(resp => resp.json())
		.then(data => {
			listAjax(); // 리로드 함수 호출 
			form.reset();
			
			//모달창 닫기 
			document.querySelector('#registerModal').style.display = 'none';
      		document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
      		document.body.classList.remove('modal-open');
		})
		.catch(error => console.log(error));
	}
		
	// ===== 등록 끝 ===== 
		
    
	// ===== 수정 시작 ===== 필요한가 ? 잘 모르겠음
			

			
	window.saveCvpl = function() {
 			const cvplVO = {
  			    		 cvplSn: document.querySelector("#cvplSnHidden").value,
   					 cvplSj: document.querySelector("#cvplSjInput").value,
   					 cvplCn: document.querySelector("#cvplCnInput").value
						 };
 
 			console.log("저장할 데이터:", cvplVO);
 
 			fetch("/cvpl/update", {
   				method: "POST",
  					headers: {
  						"Content-type": "application/json;charset=UTF-8"
  					},
  					body: JSON.stringify(cvplVO)
 			})
 			.then(resp => resp.json())
 			.then(data => {
 			 console.log("수정 결과:", data); 
   				
     		 listAjax();  // 리스트 새로고침
     
     		 
     		document.querySelector("#cvplSj").style.display = 'block';
     	    document.querySelector("#cvplCn").style.display = 'block';
     	    document.querySelector("#cvplSjInput").style.display = 'none';
     	    document.querySelector("#cvplCnInput").style.display = 'none';
     	    document.querySelector("#editBtn").style.display = 'block';
     	    document.querySelector("#saveBtn").style.display = 'none';
     	    
    		 // 모달 닫기
     		document.querySelector('#detailModal').style.display = 'none';
     		document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
     		document.body.classList.remove('modal-open');
  
 			})
			.catch(error => console.log("수정 에러:", error));
	}
	
	window.editMode = function() {
		  // 입력 필드 보이기
		  document.querySelector("#cvplSj").style.display = 'none';
		  document.querySelector("#cvplCn").style.display = 'none';
		  
		  document.querySelector("#cvplSjInput").style.display = 'block';
		  document.querySelector("#cvplCnInput").style.display = 'block';
			  
		  // 버튼
		  document.querySelector("#editBtn").style.display = 'none';
		  document.querySelector("#saveBtn").style.display = 'block';
		}
	// ===== 수정 끝 ===== 
 });
</script>

	<%@ include file="../include/footer.jsp"%>

</body>
</html>