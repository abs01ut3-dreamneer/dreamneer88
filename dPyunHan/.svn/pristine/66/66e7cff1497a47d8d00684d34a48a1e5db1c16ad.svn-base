<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<!DOCTYPE html>
<html lang="ko">
<!-- /// header 시작  -->
<!-- 지웅씨의 swal가져오기 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<%@ include file="../include/header.jsp"%>

<!-- /// 타이틀 시작 /// -->
 <!-- /// 타이틀 끝 /// -->
 
 <!-- /// body 시작 /// -->
<script>
//상세띄우기
document.body.addEventListener("click", (e) => {
	  const a = e.target.closest("a.open-vote");
	  if (!a) return;
	  e.preventDefault();

	  const voteMtrSn = a.dataset.sn;
	  if (!voteMtrSn) return;

	  // 모달 먼저 열고 로딩 표시
	  $('#goVoteModal').modal('show');
	  setIemTbody(`<tr><td colspan="5" class="text-center text-muted py-3">
	    <div class="spinner-border text-primary" role="status"><span >Loading...</span></div>
	  </td></tr>`);
	  
	  fetch("/vote/memVoteList", {
	    method: "POST",
	    headers: { "Content-Type": "application/json" },
	    body: JSON.stringify({ voteMtrSn: voteMtrSn })
	  })
	  .then(res => res.json())
	  .then(data => {
	    const vo = data?.voteMtrVO;
	    if (!vo) {
	      setIemTbody(`데이터가 없습니다.`);
	      return;
	    }
	    renderModal(vo);
	  })
	  .catch(() => {
	    setIemTbody(`불러오기에 실패했습니다.`);
	  });
	});


 // 상세 불러오기
function renderModal(iem) {
  const beginDt = (iem.voteBeginDt).toString().substring(0,10);
  const endDt   = (iem.voteEndDt).toString().substring(0,10);

  
  document.getElementById("md-voteMtrSn").value = iem.voteMtrSn;
  document.getElementById("md-empId").value = iem.empId;
  document.getElementById("md-mtrSj").value = iem.mtrSj;
  document.getElementById("md-voteTime").value = `\${beginDt}부터 ~ \${endDt}까지`;
  document.getElementById("md-mtrCn").value = iem.mtrCn;
  document.getElementById("md-voteMtrSn-hidden").value = iem.voteMtrSn;
 //data배열에 넣기
  const list = Array.isArray(iem.voteIemVOList) ? iem.voteIemVOList : [];
  if (list.length == 0) {
    setIemTbody(`등록된 항목이 없습니다.`);
    return;
  }
  const rows = list.map(i => `
    <tr>
      <td>\${i.voteIemNo}</td>
      <td>\${i.iemNm}</td>
      <td>\${i.iemCn}</td>
      <td><input type="radio" name="voteIemNo" value="\${i.voteIemNo}" required></td>
      <td>\${i.cnt}</td>
    </tr>
  `).join("");
  setIemTbody(rows);
}

function setIemTbody(html){ document.getElementById("md-iem-tbody").innerHTML = html; 
}


document.addEventListener("DOMContentLoaded", function() {
// 모달 안의 투표 버튼
var voteForm = document.getElementById("frmVote");

// form이 바로 submit되지 않게 막기
voteForm.addEventListener("submit", function(e) {
  e.preventDefault(); // 기본 제출 막기

  // 선택된 항목이 있는지 확인
  var checked = voteForm.querySelector("input[name='voteIemNo']:checked");
  if (!checked) {
    Swal.fire({
      icon: "warning",
      title: "투표 항목을 선택해주세요.",
      timer: 1500,
      showConfirmButton: false
    });
    return;
  }

  // SweetAlert확인창 띄우기
  Swal.fire({
    title: "이 항목에 투표하시겠습니까?",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "예",
    cancelButtonText: "아니오"
  }).then(function(result) {
    if (result.isConfirmed) {
      // 확인 눌렀을 때 실제 폼 제출
      voteForm.submit();

      // 선택 사항: 잠깐 로딩 메시지
      Swal.fire({
        title: "투표 중입니다...",
        icon: "info",
        showConfirmButton: false,
        timer: 1200
      });
    }
  });
});
});
</script>

		<section class="content" style="margin: 20px">
			<div class="container-fluid">
				<div class="row mb-2">
					<div class="col-sm-12">
					<!-- 20251103추가 검색필터들 추가 -->
						<div id="example1_filter" class="dataTables_filter" style="float: right;">
						  <form id="frm" name="frm" action="/vote/memVoteList" method="get" class="form-inline">
						    <!-- 검색 시 currentPage = 1 초기화 -->
						    <input type="hidden" name="currentPage" value="1" />
						
						    <!-- 키워드 -->
						    <label class="mr-2 mb-0">
						      <input type="search" name="keyword"
						             class="form-control form-control-sm"
						             placeholder="검색어(제목/내용)"
						             value="${fn:escapeXml(param.keyword)}"
						             aria-controls="example1" />
						    </label>
						
						    <!-- 기간 period-->
						    <label class="mr-2 mb-0">
						      <input type="date" name="periodFrom"
						             class="form-control form-control-sm"
						             value="${param.periodFrom}" />
						    </label>
						    <span class="mr-2">~</span>
						    <label class="mr-2 mb-0">
						      <input type="date" name="periodTo"
						             class="form-control form-control-sm"
						             value="${param.periodTo}" />
						    </label>
						
						    <!-- 진행중/대기/마감 -->
						    <label class="mr-2 mb-0">
						      <select name="stat" class="form-control form-control-sm">
						        <option value="" ${empty param.stat ? 'selected' : ''}>전체</option>
						        <option value="진행중" ${param.stat eq '진행중' ? 'selected' : ''}>진행중</option>
						        <option value="예정"   ${param.stat eq '대기'   ? 'selected' : ''}>예정</option>
						        <option value="마감"   ${param.stat eq '마감'   ? 'selected' : ''}>마감</option>
						      </select>
						    </label>
						
						    <!-- 검색 버튼 -->
						    <button type="submit" class="btn btn-info btn-sm mr-2">검색</button>
						
						    <!-- 초기화 -->
						    <a href="/vote/memVoteList" class="btn btn-default btn-sm">초기화</a>
						  </form>
						</div>
					<!-- 20251103추가 검색필터들 추가끝 -->
					</div>
				</div>
			<div class="container">
				<h3 class="class="card-title">투표 목록</h3>
			</div>
				<div class="row">
					<div class="col-md-12">
						<!-- 카드 시작 -->
						<div class="card">
							<div class="card-body">
								<table style="border-collapse: collapse; border: none; width: 100%;">
									<thead>
										<tr>
											<th style="width:10%; text-align: center;">글번호</th>
											<th>제목</th>	
											<th style="width: 10%; text-align: center;">투표 시작시간</th>
											<th style="width: 10%; text-align: center;">투표 마감시간</th>
											<th style="width: 10%; text-align: center;">투표인원</th>
											<th style="width: 10%; text-align: center;">상태</th>
										</tr>
									</thead>
									<tbody>

										<c:forEach var="p" items="${articlePage.content}" varStatus="stat">
											<tr>
												<!-- 모달열기 href="#" data-toggle="modal" data-target="#goVoteModal"  , 모달의div id가 goVoteModal-->
												<td style="text-align: center;"><a href="#" class="open-vote" data-sn="${p.voteMtrSn}" >[${p.voteMtrSn}]</a></td>
												<td><a href="#" class="open-vote" data-sn="${p.voteMtrSn}">${p.mtrSj}${p.isVoted}
																													  <c:choose>
																													    <c:when test="${p.isVoted eq '참여'}">
																													      <span class="badge badge-info">참여완료</span>
																													    </c:when>
																													    <c:otherwise>
																													      <span class="badge badge-light text-muted">미참여</span>
																													    </c:otherwise>
																													  </c:choose></a></td>
												<td style="text-align: center;">
													${fn:substring(p.voteBeginDt, 0, 10)}
												</td>
												<td style="text-align: center;">
													${fn:substring(p.voteEndDt, 0, 10)}
												</td>
												<td style="text-align: center;">
													<c:out value="${p.votedNum}" />
												</td>
												<td style="text-align: center;">
												
													<c:choose>
													  <c:when test="${p.stat eq '진행중'}">
													    <span class="badge badge-success">${p.stat}</span>
													  </c:when>
													  <c:when test="${p.stat eq '예정'}">
													    <span class="badge badge-secondary">${p.stat}</span>
													  </c:when>
													  <c:when test="${p.stat eq '마감'}">
													    <span class="badge badge-warning">${p.stat}</span>
													  </c:when>
													  <c:otherwise>
													    <span class="badge badge-light">${p.stat}</span>
													  </c:otherwise>
													</c:choose>
														
														</td>
											</tr>
										</c:forEach>
									</tbody>
								</table>
							</div>
<!-- 						<div style="text-align: right;"><a href="/vote/addVotePage" class="btn btn-info btn-sm" >등록하기</a></div> -->

							<div class="card-footer clearfix">${articlePage.pagingArea}</div>
						</div>
						<!-- 카드 끝 -->
					</div>
				</div>
			</div>
		</section>



<!-- modal시작 -->
<div class="modal fade" id="goVoteModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">
        No.<span id="md-voteMtrSn">-</span> &nbsp;|&nbsp; 작성자ID: <span id="md-empId">-</span>
      </h5>
      <button type="button" class="close" data-dismiss="modal"><span>X</span></button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <input type="text" id="md-mtrSj" class="form-control" readonly>
      </div>
      <div class="form-group">
        <table style="width:100%; border:none;">
          <tr>
            <th style="border:none; text-align:left;">투표 기간</th>
            <td style="border:none;"><input type="text" id="md-voteTime" class="form-control" readonly></td>
          </tr>
        </table>
      </div>
      <div class="form-group">
        <textarea id="md-mtrCn" class="form-control" rows="6" style="resize:none;" readonly></textarea>
      </div>

      <h6 class="mb-2">투표 항목</h6>
      <form id="frmVote" method="post" action="/vote/haveAVote">
        <input type="hidden" name="voteMtrSn" id="md-voteMtrSn-hidden">
        <table class="table table-sm">
          <thead>
            <tr>
              <th style="width:10%;">No</th>
              <th style="width:25%;">투표항목</th>
              <th style="width:45%;">내용</th>
              <th style="width:10%;">투표</th>
              <th style="width:10%;">투표수</th>
            </tr>
          </thead>
          <tbody id="md-iem-tbody"></tbody>
        </table>
        <button type="submit" class="btn btn-info btn-sm"><i class="far fa-envelope"></i> 투표하기</button>
      </form>
    </div>

    <div class="modal-footer">
<!--       <a href="/vote/voteMtr" class="btn btn-default"><i class="fas fa-times"></i> 뒤로가기</a> -->
    </div>
  </div></div>
</div>

</div><!-- 모달끝 -->

    <!-- /// footer 시작 /// -->
    </div>
    
    
	<%@ include	file="../include/footer.jsp"%> 
	<!-- /// footer 끝 /// -->