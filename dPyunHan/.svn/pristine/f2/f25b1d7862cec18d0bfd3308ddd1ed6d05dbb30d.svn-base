<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<!-- /// header 시작  -->


<%@ include file="../include/headerContents.jsp"%>

<!-- /// 타이틀 시작 /// -->
<!-- /// 타이틀 끝 /// -->

<!-- /// body 시작 /// -->



<script>
//상세띄우기
document.body.addEventListener("click", (e) => {
	  const a = e.target.closest("a.open-vote");
	  if (!a) return;
	  e.preventDefault();

	  const voteMtrSn = a.dataset.sn;
	  if (!voteMtrSn) return;

	  // 모달 먼저 열고 로딩 표시
	  const modalEl = document.getElementById('goVoteModal');
	  const modal   = new bootstrap.Modal(modalEl);
	  modal.show();
	  setIemTbody(`<tr><td colspan="5" class="text-center text-muted py-3">
	    <div class="spinner-border text-primary" role="status"><span >Loading...</span></div>
	  </td></tr>`);
	  
	  fetch("/vote/memVoteList", {
	    method: "POST",
	    headers: { "Content-Type": "application/json" },
	    body: JSON.stringify({ voteMtrSn: voteMtrSn })
	  })
	  .then(res => res.json())
	  .then(data => {
	    const vo = data?.voteMtrVO;
	    if (!vo) {
	      setIemTbody(`데이터가 없습니다.`);
	      return;
	    }
	    renderModal(vo);
	  })
	  .catch(() => {
	    setIemTbody(`불러오기에 실패했습니다.`);
	  });
	});


 // 상세 불러오기
function renderModal(iem) {
  const beginDt = (iem.voteBeginDt).toString().substring(0,10);
  const endDt   = (iem.voteEndDt).toString().substring(0,10);

  
  document.getElementById("md-voteMtrSn").textContent = iem.voteMtrSn;
  document.getElementById("md-empId").textContent = iem.empId;
  document.getElementById("md-mtrSj").value = iem.mtrSj;
  document.getElementById("md-voteTime").value = `\${beginDt}부터 ~ \${endDt}까지`;
  document.getElementById("md-mtrCn").value = iem.mtrCn;
  document.getElementById("md-voteMtrSn-hidden").value = iem.voteMtrSn;
 //data배열에 넣기
  const list = Array.isArray(iem.voteIemVOList) ? iem.voteIemVOList : [];
  if (list.length == 0) {
    setIemTbody(`등록된 항목이 없습니다.`);
    return;
  }
  const rows = list.map(i => `
    <tr>
      <td>\${i.voteIemNo}</td>
      <td>\${i.iemNm}</td>
      <td>\${i.iemCn}</td>
      <td><input type="radio" name="voteIemNo" value="\${i.voteIemNo}" required></td>
      <td>\${i.cnt}</td>
    </tr>
  `).join("");
  setIemTbody(rows);
}

function setIemTbody(html){ document.getElementById("md-iem-tbody").innerHTML = html; 
}


document.addEventListener("DOMContentLoaded", function() {
// 모달 안의 투표 버튼
var voteForm = document.getElementById("frmVote");

// form이 바로 submit되지 않게 막기
voteForm.addEventListener("submit", function(e) {
  e.preventDefault(); // 기본 제출 막기

  // 선택된 항목이 있는지 확인
  var checked = voteForm.querySelector("input[name='voteIemNo']:checked");
  if (!checked) {
    Swal.fire({
      icon: "warning",
      title: "투표 항목을 선택해주세요.",
      timer: 1500,
      showConfirmButton: false
    });
    return;
  }

  // SweetAlert확인창 띄우기
  Swal.fire({
    title: "이 항목에 투표하시겠습니까?",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "예",
    cancelButtonText: "아니오"
  }).then(function(result) {
    if (result.isConfirmed) {
      // 확인 눌렀을 때 실제 폼 제출
      voteForm.submit();

      // 선택 사항: 잠깐 로딩 메시지
      Swal.fire({
        title: "투표 중입니다...",
        icon: "info",
        showConfirmButton: false,
        timer: 1200
      });
    }
  });
});
});
</script>

<!-- 		<section class="content" style="margin: 20px"> -->
<!-- 			<div class="container-fluid"> -->
<!-- 				<div class="row mb-2"> -->
<!-- 					<div class="col-sm-12"> -->




  <div class="card" style="margin:8px; padding:5px; border:3px solid rgba(100, 140, 164, 0.75); border-radius:14px;">

    <!-- 목록 -->
    <div class="mobile-list" style="margin: 5px;">
      <c:forEach var="p" items="${articlePage.content}" varStatus="stat">

        <c:set var="badgeClass" value="bg-light text-muted"/>
        <c:if test="${p.stat eq '진행중'}"><c:set var="badgeClass" value="bg-success"/></c:if>
        <c:if test="${p.stat eq '예정'}"><c:set var="badgeClass" value="bg-secondary"/></c:if>
        <c:if test="${p.stat eq '마감'}"><c:set var="badgeClass" value="bg-warning text-dark"/></c:if>

        <div class="card mb-2 shadow-sm border-0">
          <div class="card-body py-3 px-3">
            <!-- 제목/상태 -->
            <div class="d-flex justify-content-between align-items-start gap-2">
              <a href="#" class="open-vote text-decoration-none" data-sn="${p.voteMtrSn}">
                <div class="fw-semibold text-truncate" style="max-width: 100%;">[${p.voteMtrSn}] ${p.mtrSj}</div>
              </a>
              <span class="badge ${badgeClass}">${p.stat}</span>
            </div>

            <!-- 기간 -->
            <div class="small text-muted mt-1">
              <i class="bi bi-calendar-check"></i>
              ${fn:substring(p.voteBeginDt, 0, 10)} ~ ${fn:substring(p.voteEndDt, 0, 10)}
            </div>

            <!-- 인원/참여여부 -->
            <div class="d-flex justify-content-between align-items-center mt-2">
              <div class="small">투표인원: <span class="fw-semibold"><c:out value="${p.votedNum}" /></span></div>
              <div>
                <c:choose>
                  <c:when test='${p.isVoted eq "참여"}'><span class="badge bg-info">참여완료</span></c:when>
                  <c:otherwise><span class="badge bg-light text-danger">미참여</span></c:otherwise>
                </c:choose>
              </div>
            </div>
          </div>
        </div>

      </c:forEach>

      <!-- 페이지네이션 -->
      <div class="d-flex justify-content-center">
        ${articlePage.pagingArea}
      </div>
    </div>

<!-- 하단 검색 필터 영역 -->
<div style="border-top:1px solid rgba(0,0,0,.06); padding:12px 10px; background:#fff; border-bottom-left-radius:14px; border-bottom-right-radius:14px;">
  <form id="frm" name="frm" action="/vote/memVoteList" method="get"
        style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:center; margin:0;">
    <input type="hidden" name="currentPage" value="1" />

    <!-- 기간 -->
    <label style="margin:0;">
      <input type="date" name="periodFrom" value="${param.periodFrom}"
             class="form-control form-control-sm" />
    </label>
    <span style="margin:0 .25rem;">~</span>
    <label style="margin:0;">
      <input type="date" name="periodTo" value="${param.periodTo}"
             class="form-control form-control-sm" />
    </label>
    <!-- 상태 -->
    <label style="margin:0;">
      <select name="stat" class="form-control form-control-sm">
        <option value=""  ${empty param.stat ? 'selected' : ''}>전체</option>
        <option value="진행중" ${param.stat eq '진행중' ? 'selected' : ''}>진행중</option>
        <option value="예정"   ${param.stat eq '예정'   ? 'selected' : ''}>예정</option>
        <option value="마감"   ${param.stat eq '마감'   ? 'selected' : ''}>마감</option>
      </select>
    </label>
    <!-- 키워드 -->
    <label style="margin:0;">
      <input type="search" name="keyword" placeholder="검색어(제목/내용)" aria-controls="example1"
             value="${fn:escapeXml(param.keyword)}"
             class="form-control form-control-sm"
             style="min-width:180px;" />
    </label>



    <!-- 버튼들 -->
    <button type="submit" class="btn btn-info btn-sm" style="padding:.25rem .6rem;">검색</button>
    <a href="/vote/memVoteList" class="btn btn-default btn-sm" style="padding:.25rem .6rem;">초기화</a>
  </form>
</div>
<!-- 검색끝 -->




  </div>
</section>





<!-- modal시작 -->
<div class="modal fade" id="goVoteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down modal-lg">
    <div class="modal-content"
         style="border:0; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,.12); overflow:hidden;">
      <!-- 헤더 -->
      <div class="modal-header"
           style="background:rgba(100,140,164,.85); color:#fff; padding:.6rem .9rem;">
        <h5 class="modal-title" style="font-size:1rem; display:flex; gap:.5rem; align-items:center; margin:0;">
          <span>No.<span id="md-voteMtrSn">-</span></span>
          <span class="text-white-50">|</span>
          <small class="fw-normal">작성자ID: <span id="md-empId">-</span></small>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- 본문 -->
      <div class="modal-body" style="padding:.9rem;">
        <!-- 제목 -->
        <div class="mb-2">
          <div style="color:#6b7b86; font-size:.875rem; margin-bottom:.25rem;">제목</div>
          <input type="text" id="md-mtrSj" class="form-control form-control-sm" readonly>
        </div>

        <!-- 기간/비고 (info-block) -->
        <div
          style="display:grid; grid-template-columns:92px 1fr; row-gap:.35rem; column-gap:.75rem;
                 padding:.8rem; border:1px solid rgba(0,0,0,.06); border-radius:10px;
                 background:rgba(100,140,164,.12); margin-bottom:.75rem;">
          <div style="color:#6b7b86; font-size:.875rem; align-self:center;">투표 기간</div>
          <div style="font-weight:600; font-size:.95rem;">
            <input type="text" id="md-voteTime" class="form-control form-control-sm" readonly>
          </div>

          <div style="color:#6b7b86; font-size:.875rem; align-self:start;">내용</div>
          <div style="font-weight:500;">
            <textarea id="md-mtrCn" class="form-control form-control-sm" rows="5" style="resize:none;" readonly></textarea>
          </div>
        </div>

        <!-- 항목 테이블 -->
        <h6 class="mb-2" style="margin:0 0 .5rem 0;">투표 항목</h6>
        <form id="frmVote" method="post" action="/vote/haveAVote">
          <input type="hidden" name="voteMtrSn" id="md-voteMtrSn-hidden">
          <table class="table table-sm table-hover" style="margin-top:.25rem;">
            <thead>
              <tr>
                <th style="width:10%; background:#f6f8fa; border-bottom:1px solid rgba(0,0,0,.06);">No</th>
                <th style="width:25%; background:#f6f8fa; border-bottom:1px solid rgba(0,0,0,.06);">투표항목</th>
                <th style="width:45%; background:#f6f8fa; border-bottom:1px solid rgba(0,0,0,.06);">내용</th>
                <th style="width:10%; background:#f6f8fa; border-bottom:1px solid rgba(0,0,0,.06);">투표</th>
                <th style="width:10%; background:#f6f8fa; border-bottom:1px solid rgba(0,0,0,.06);">투표수</th>
              </tr>
            </thead>
            <tbody id="md-iem-tbody"></tbody>
          </table>

          <div class="d-flex justify-content-end gap-2" style="margin-top:.5rem;">
            <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal"
                    style="padding:.35rem .7rem; border-radius:10px;">닫기</button>
            <button type="submit" class="btn btn-info btn-sm"
                    style="padding:.35rem .7rem; border-radius:10px;">
              <i class="far fa-envelope"></i> 투표하기
            </button>
          </div>
        </form>
      </div>

      <!-- 푸터 (비워둠) -->
      <div class="modal-footer" style="padding:.6rem .9rem; background:#fff;"></div>
    </div>
  </div>
</div>


<!-- /// footer 시작 /// -->
<%@ include file="../include/footerContents.jsp"%>
<!-- /// footer 끝 /// -->