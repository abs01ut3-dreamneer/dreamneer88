<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ include file="../include/header.jsp" %>

<!-- <style>
.manage-wrapper { max-width: 800px; margin: 20px auto; }
.rqest-card-wrapper { display: flex; flex-direction: column; gap: 15px; }
.rqest-card { border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; padding: 15px; }
.rqest-info p { margin: 4px 0; }
.rqest-action { margin-top: 10px; }
.payBtn, .showDetailBtn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
.payBtn { background: #007bff; color: #fff; }
.payBtn:hover { background: #0056b3; }
.showDetailBtn { background: #6c757d; color: #fff; margin-left: 5px; }
.showDetailBtn:hover { background: #5a6268; }
.status-paid { color: green; font-weight: bold; }
.status-unpaid { color: red; font-weight: bold; }
.table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
.table th { background-color: #f7f7f7; }
.detail-wrapper { margin-top: 10px; }
</style>
 -->
<script src="/js/jquery-3.6.0.js"></script>
<script src="https://cdn.portone.io/v2/browser-sdk.js" async defer></script>

<h1>관리비 조회</h1>

<div class="manage-wrapper">
    <form action="/rqest/rqest" method="get">
        <label>조회 연월:</label>
        <input type="month" name="ym" value="${yearMonth}">
        <input type="hidden" name="hshldId" value="${hshldId}" />
        <button type="submit">조회</button>
    </form>

    <c:if test="${empty rqestList}">
        <p>해당 월의 관리비 내역이 없습니다.</p>
    </c:if>

    <c:if test="${not empty rqestList}">
        <div class="rqest-card-wrapper">
            <c:forEach var="rq" items="${rqestList}">
                <div class="rqest-card" id="rq-${rq.rqestSn}">
                    <div class="rqest-info">
                        <p>청구 연월: <strong>${rq.rqestYm}</strong></p>
                        <p>납부 기한: <strong><fmt:formatDate value="${rq.payTmlmt}" pattern="yyyy-MM-dd"/></strong></p>
                        <p>금액: <strong><fmt:formatNumber value="${rq.managectTotAmount}" pattern="#,###"/>원</strong></p>
                        <p>
                            납부 상태:
                            <c:choose>
                                <c:when test="${rq.paySttus == 0 || rq.paySttus == null}">
                                    <span class="status-unpaid">미납</span>
                                </c:when>
                                <c:otherwise>
                                    <span class="status-paid">납부완료</span>
                                </c:otherwise>
                            </c:choose>
                        </p>
                    </div>
                    <div class="rqest-action">
                        <c:if test="${rq.paySttus == 0 || rq.paySttus == null}">
                            <button type="button" class="payBtn" 
                                data-sn="${rq.rqestSn}"
                                data-amount="${rq.managectTotAmount}"
                                data-ym="${rq.rqestYm}">
                                납부하기
                            </button>
                        </c:if>
                        <button type="button" class="showDetailBtn" data-sn="${rq.rqestSn}">
                            상세보기
                        </button>
                    </div>
                    <div class="detail-wrapper" id="detail-${rq.rqestSn}" style="display:none;"></div>
                </div>
            </c:forEach>
        </div>
    </c:if>
</div>

<script>
// 관리비 납부 API
$(function(){
    $(".payBtn").on("click", async function(){
        const $btn = $(this);
        const rqestSn = $btn.data("sn");
        const amount = $btn.data("amount");
        const ym = $btn.data("ym");

        try {
            const payment = await PortOne.requestPayment({
                storeId: "store-d68fc086-e239-4a01-9b2c-388081ff1fc4",
                channelKey: "channel-key-9ba8fabc-3d41-41c4-83a2-e61940b47852",
                paymentId: "PAY_" + new Date().getTime(),
                orderName: "관리비 납부 (" + ym + ")",
                totalAmount: amount,
                currency: "KRW",
                payMethod: "CARD",
                customer: { fullName: "세대번호 " + rqestSn, email: "user@example.com", phoneNumber: "01000000000" },
                customData: { rqestSn: rqestSn }
            });

            if(payment.code !== undefined){
                alert("결제 실패: " + payment.message);
                return;
            }

            // 결제 성공 시 서버 반영
            await $.ajax({
                url: "/rqest/paymentSuccessPortOne",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ paySn: payment.paymentId, rqestSn: rqestSn, payAmount: amount }),
                success: function(){
                    alert("결제가 완료되었습니다!");
                    $btn.closest(".rqest-action").empty();
                    const statusEl = $btn.closest(".rqest-card").find(".rqest-info span");
                    statusEl.removeClass("status-unpaid").addClass("status-paid").text("납부완료");
                },
                error: function(err){
                    alert("서버 검증 중 오류가 발생했습니다.");
                    console.error(err);
                }
            });

        } catch(err){
            console.error(err);
            alert("결제창 호출 중 오류가 발생했습니다.");
        }
    });

    // 상세보기 버튼 AJAX
    $(".showDetailBtn").on("click", async function(){
        const $btn = $(this);
        const rqestSn = $btn.data("sn");
        const $detailWrapper = $("#detail-" + rqestSn);

        if($detailWrapper.is(":visible")){
            $detailWrapper.slideUp();
            return;
        }

        try {
            const detailList = await $.getJSON("/rqest/detail", { rqestSn: rqestSn });

            console.log("AJAX로 받아온 데이터:", detailList);
            
            if(detailList.length === 0){
                $detailWrapper.html("<p>상세항목이 없습니다.</p>").slideDown();
                return;
            }

            let table = '<table class="table table-striped">';
            table += '<thead><tr><th>#</th><th>항목명</th><th>금액</th></tr></thead><tbody>';

            detailList.forEach((d, idx) => {
                table += `<tr>
                    <td>\${idx + 1}</td>
                    <td>\${d.iemNm}</td>
                    <td>\${d.rqestAmount}원</td>
                </tr>`;
            });

            table += '</tbody></table>';
            $detailWrapper.html(table).slideDown();

        } catch(err){
            console.error(err);
            alert("상세항목 조회 중 오류가 발생했습니다.");
        }
    });
});
</script>

<%@ include file="../include/footer.jsp" %>
