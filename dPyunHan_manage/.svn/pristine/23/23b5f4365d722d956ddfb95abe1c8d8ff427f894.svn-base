<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%-- <%@ include file="../include/header.jsp" %>--%>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PDF ë¯¸ë¦¬ë³´ê¸° ë° ì„œëª…</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* --- (ê¸°ì¡´ ìŠ¤íƒ€ì¼) --- */
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
        .viewer-container { position: relative; width: 100%; height: 80vh; }
        .pdf-viewer { width: 100%; height: 100%; border: none; }
        .sign-button {
            position: absolute; bottom: 30px; right: 30px;
            padding: 12px 25px; background-color: #007bff; color: white;
            border: none; border-radius: 5px; font-size: 16px;
            font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        .sign-button:hover { background-color: #0056b3; }

        /* (QR ëª¨ë‹¬ ìŠ¤íƒ€ì¼) */
        .qr-modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);
            z-index: 99; justify-content: center; align-items: center;
        }
        .qr-modal-content {
            background: white; padding: 30px; border-radius: 10px;
            text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #qrcode { width: 200px; height: 200px; margin: 20px auto 0; }

        /* [!!!] 1. (FIX) ëˆ„ë½ë˜ì—ˆë˜ ìŠ¤íƒ€ì¼ ì¶”ê°€ [!!!] */
        #status {
            font-size: 1.1em; color: #555;
            margin: 15px; font-weight: bold;
            text-align: center;
        }
        #pdf-div { /* (ì„œëª… ì™„ë£Œ í›„ ìµœì¢… PDFê°€ í‘œì‹œë  ì˜ì—­) */
            display: none; width: 100%; height: 100vh; margin: 20px auto;
            text-align: center;
        }
        #pdf-frame { width: 100%; height: 80%; border: 1px solid #ccc; }
    </style>
</head>
<body>

<%-- [!!!] 2. (FIX) ëˆ„ë½ë˜ì—ˆë˜ 'status' div ì¶”ê°€ [!!!] --%>
<div id="status">ì„œë²„ ì—°ê²° ì¤‘...</div>

<div class="viewer-container" id="viewer-container">
    <iframe src="<c:url value='${fileVO.fileStrelc}' />" class="pdf-viewer">
        <p>ì´ ë¸Œë¼ìš°ì €ëŠ” PDF ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
    </iframe>

    <button type="button" class="sign-button" onclick="showQrModal()">
        ì‚¬ì¸í•˜ëŸ¬ê°€ê¸°
    </button>
</div>

<div class="qr-modal-overlay" id="qrModal">
    <div class="qr-modal-content">
        <h4>ëª¨ë°”ì¼ ê¸°ê¸°ë¡œ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</h4>
        <p>ëª¨ë°”ì¼ì—ì„œ ì„œëª…ì„ ì™„ë£Œí•˜ë©´ ì´ ì°½ì€ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.</p>
        <div id="qrcode"></div>
        <button onclick="hideQrModal()" style="margin-top: 20px;">ë‹«ê¸°</button>
    </div>
</div>

<%-- [!!!] 3. (FIX) ëˆ„ë½ë˜ì—ˆë˜ 'pdf-div' (ìµœì¢…ë³¸ í‘œì‹œ) div ì¶”ê°€ [!!!] --%>
<div id="pdf-div">
    <h2 style="color: blue;">âœ… ì„œëª…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
    <iframe id="pdf-frame" src=""></iframe>
</div>


<script>
    // --- (ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë°›ì€ ê°’) ---
    const signToken = "${signToken}";
    // [!!!] 1. (ìˆ˜ì •) PCì˜ IP ì£¼ì†Œ í•˜ë“œì½”ë”© [!!!]
    // (cmd -> ipconfig ì—ì„œ ì°¾ì€ 192.168.x.x ì£¼ì†Œ ì…ë ¥)
    const PC_IP_ADDRESS = "192.168.141.46"; // ğŸš¨ğŸš¨ ë³¸ì¸ IPë¡œ ìˆ˜ì • ğŸš¨ğŸš¨
    const SERVER_PORT = "${pageContext.request.serverPort}";
    const CONTEXT_PATH = "${pageContext.request.contextPath}";

    // (JSP ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•  URL - localhost ê°€ëŠ¥)
    const serverUrl = "${pageContext.request.scheme}://${pageContext.request.serverName}:${SERVER_PORT}${CONTEXT_PATH}";

    // (ëª¨ë°”ì¼ -> PC ì ‘ì†ìš© URL)
    const mobileAccessUrl = "http://" + PC_IP_ADDRESS + ":" + SERVER_PORT + CONTEXT_PATH;

    // (ì›¹ì†Œì¼“ ì ‘ì† URL - IP ê¸°ë°˜)
    const wsUrl = "ws://" + PC_IP_ADDRESS + ":" + SERVER_PORT + CONTEXT_PATH + "/ws/sign/" + signToken;


    let qrcode = null;

    // --- (ì›¹ì†Œì¼“ ì—°ê²° ë¡œì§ - ìˆ˜ì •) ---
    // (ì´ì œ localhostê°€ ì•„ë‹Œ IPë¡œ ì ‘ì†)
    console.log("[WS] ì—°ê²° ì‹œë„...", wsUrl);
    const socket = new WebSocket(wsUrl);

    // (ì—°ê²° ì„±ê³µ)
    socket.onopen = (event) => {
        console.log("[WS] ì—°ê²° ì„±ê³µ.");
        // (FIX) ì´ì œ 'status'ê°€ ì¡´ì¬í•˜ë¯€ë¡œ ì •ìƒ ì‘ë™
        document.getElementById('status').textContent = "ì„œë²„ ì—°ê²° ì„±ê³µ. QR ìƒì„± ëŒ€ê¸° ì¤‘...";
    };

    // (ì—°ê²° ì¢…ë£Œ)
    socket.onclose = (event) => {
        console.log("[WS] ì—°ê²° ì¢…ë£Œ.");
        document.getElementById('status').textContent = "ì„œë²„ì™€ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤.";
    };

    // (ì˜¤ë¥˜)
    socket.onerror = (error) => {
        console.error("[WS] ì›¹ì†Œì¼“ ì˜¤ë¥˜ ë°œìƒ!", error);
        document.getElementById('status').textContent = "ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
    };

    // (ë©”ì‹œì§€ ìˆ˜ì‹ )
    socket.onmessage = (event) => {
        console.log("[WS] ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
        try {
            const msg = JSON.parse(event.data);

            if (msg.type === 'signatureCompleted' && msg.url) {
                console.log("[WS] ì„œëª… ì™„ë£Œ ë©”ì‹œì§€ í™•ì¸! PDF ë¡œë“œ:", msg.url);

                hideQrModal();

                // (FIX) ì´ì œ 'pdf-div' ë“±ì´ ì¡´ì¬í•˜ë¯€ë¡œ ì •ìƒ ì‘ë™
                document.getElementById('status').textContent = "";
                // document.getElementById('qrModal').style.display = 'none'; // QR ì˜ì—­ ìˆ¨ê¸°ê¸°
                document.getElementById('viewer-container').style.display = 'none'; // ì›ë³¸ PDF ìˆ¨ê¸°ê¸°
                document.getElementById('pdf-div').style.display = 'block'; // ìµœì¢… PDF ì˜ì—­ í‘œì‹œ
                document.getElementById('pdf-frame').src = msg.url; // iframeì— ìµœì¢… PDF ë¡œë“œ

                socket.close();
            }
        } catch (e) {
            console.error("[WS] ìˆ˜ì‹  ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", e);
        }
    };

    // (QR ëª¨ë‹¬ ì—´ê¸°)
    function showQrModal() {

        // [!!!] ëª¨ë°”ì¼ URLì„ 'mobileAccessUrl' (IP ê¸°ë°˜)ë¡œ ìƒì„± [!!!]
        const mobileSignUrl = `\${mobileAccessUrl}/sign/mobile?token=${signToken}`;

        console.log("ëª¨ë°”ì¼ QR URL:", mobileSignUrl); // (IP ì£¼ì†Œ í™•ì¸)

        const qrDiv = document.getElementById('qrcode');
        qrDiv.innerHTML = "";
        qrcode = new QRCode(qrDiv, { text: mobileSignUrl, width: 200, height: 200 });

        document.getElementById('status').textContent = "QR ìƒì„± ì™„ë£Œ. ìŠ¤ìº” ëŒ€ê¸° ì¤‘...";
        document.getElementById('qrModal').style.display = 'flex';
    }

    // (QR ëª¨ë‹¬ ë‹«ê¸°)
    function hideQrModal() {
        document.getElementById('qrModal').style.display = 'none';
    }
</script>

<%-- <%@ include file="../include/footer.jsp" %>--%>
</body>
</html>