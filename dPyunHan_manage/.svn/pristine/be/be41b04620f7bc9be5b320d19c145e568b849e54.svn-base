<%@ page language="java" contentType="text/html; charset=UTF-8" %>
  <%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
    <%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
      <%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
        <!DOCTYPE html>
        <html>

        <head>
          <title></title>

          <script type="text/javascript">
            document.addEventListener("DOMContentLoaded", function () {
              const checkAll = document.getElementById("checkAll");
              const fileChecks = document.querySelectorAll(".fileCheck");

              checkAll.addEventListener("change", function () {
                fileChecks.forEach(chk => chk.checked = checkAll.checked);
              });

              // 선택 다운로드
              document.getElementById("downloadSelectedBtn").addEventListener("click", function () {
                const selectedFiles = Array.from(document.querySelectorAll(".fileCheck:checked"));

                if (selectedFiles.length === 0) {
                  alert("다운로드할 파일을 선택해주세요.");
                  return;
                }

                const form = document.createElement("form");
                form.method = "POST";
                form.action = "/bidPblanc/downloadSelected";

                selectedFiles.forEach(checkbox => {
                  const listItem = checkbox.closest("a");
                  const fileGroupSn = listItem.getAttribute("data-file-group-sn");
                  const fileNo = listItem.getAttribute("data-file-no");

                  const groupInput = document.createElement("input");
                  groupInput.type = "hidden";
                  groupInput.name = "fileGroupSnList";
                  groupInput.value = fileGroupSn;
                  form.appendChild(groupInput);

                  const noInput = document.createElement("input");
                  noInput.type = "hidden";
                  noInput.name = "fileNoList";
                  noInput.value = fileNo;
                  form.appendChild(noInput);
                });

                document.body.appendChild(form);
                form.submit();
              });

              // 전체 다운로드
              document.getElementById("downloadAllBtn").addEventListener("click", function () {
                const firstFile = document.querySelector("a[data-file-group-sn]");
                if (firstFile) {
                  const fileGroupSn = firstFile.getAttribute("data-file-group-sn");
                  window.location.href = "/bidPblanc/downloadAll?fileGroupSn=" + fileGroupSn;
                }
              });
            });
          </script>
        </head>

        <body>
          <%@ include file="../include/header.jsp" %>
            <!-- /// body /// -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">입찰 공고 상세</h3>
              </div>
              <!-- /.card-header -->
              <div class="card-body">
                <table class="table table-bordered">
                  <tbody>
                    <tr>
                      <th class="bg-light col-2 text-center">입찰번호</th>
                      <td colspan="3">${bidPblancVO.bidPblancSnAsStr}</td>
                    </tr>
                    <tr>
                      <th class="bg-light col-2 text-center">입찰제목</th>
                      <td colspan="3">${bidPblancVO.bidSj}</td>
                    </tr>
                    <tr>
                      <th class="bg-light col-2 text-center">낙찰방법</th>
                      <td class="col-4">${bidPblancVO.scsbMthAsStr}</td>
                      <th class="bg-light col-2 text-center">입찰보증금</th>
                      <td class="col-4">입찰가격의[${bidPblancVO.bidGtnRt}]%이상 제출</td>
                    </tr>
                    <tr>
                      <th class="bg-light col-2 text-center">공고 시작일</th>
                      <td>
                        <fmt:formatDate value="${bidPblancVO.pblancDt}" pattern="yyyy-MM-dd" />
                      </td>
                      <th class="bg-light col-2 text-center">입찰 마감일</th>
                      <td>
                        <fmt:formatDate value="${bidPblancVO.bidClosDtAsDate}" pattern="yyyy-MM-dd" />
                      </td>
                    </tr>
                    <tr>
                      <th class="bg-light col-2 text-center">신용평가등급확인서</th>
                      <td>${bidPblancVO.cdltPresentnAtAsStr}</td>
                      <th class="bg-light col-2 text-center">관리실적증명서</th>
                      <td>${bidPblancVO.acmsltproofPresentnAtAsStr}</td>
                    </tr>
                    <tr>
                      <th class="bg-light col-2 text-center">현장설명</th>
                      <td colspan="3">${bidPblancVO.sptdcAtAsStr}</td>
                    </tr>
                    <tr>
                      <th class="bg-light col-2 text-center">현장설명일시</th>
                      <td>
                        <c:if test="${empty bidPblancVO.sptdcDtAsDate}">
                          해당없음
                        </c:if>
                      </td>
                      <th class="bg-light col-2 text-center">현장설명장소</th>
                      <td>
                        <c:if test="${empty bidPblancVO.sptdcPlace}">
                          해당없음
                        </c:if>
                      </td>
                    </tr>
                    <tr>
                      <th class="bg-light col-2 text-center">내용</th>
                      <td colspan="3">${bidPblancVO.bidCn}</td>
                    </tr>

                    <tr>
                      <th class="bg-light col-2 text-center">첨부파일</th>
                      <td colspan="3">
                        <c:choose>
                          <c:when test="${empty fileDetailVOList}">
                            <p class="text-muted">첨부파일이 없습니다.</p>
                          </c:when>
                          <c:otherwise>
                            <!-- 전체 선택 영역 -->
                            <div class="bg-light p-2 mb-2 d-flex align-items-center">
                              <input type="checkbox" id="checkAll" class="mr-2" />
                              <label for="checkAll" class="mb-0">전체선택</label>
                            </div>

                            <!-- 파일 목록 -->
                            <div class="list-group">
                              <c:forEach var="file" items="${fileDetailVOList}">
                                <a href="/bidPblanc/download?fileGroupSn=${file.fileGroupSn}&fileNo=${file.fileNo}"
                                  class="list-group-item list-group-item-action d-flex align-items-center"
                                  data-file-group-sn="${file.fileGroupSn}" data-file-no="${file.fileNo}"
                                  target="_blank">
                                  <input type="checkbox" class="fileCheck mr-2" value="${file.fileNo}"
                                    onclick="event.stopPropagation();" />
                                  <i class="fa fa-file mr-2"></i>
                                  <span>${file.fileOrginlNm}</span>
                                </a>
                              </c:forEach>
                            </div>
                            <!-- 다운로드 버튼 -->
                            <div class="mt-2">
                              <button id="downloadAllBtn" class="btn btn-success btn-sm">전체 다운로드</button>
                              <button id="downloadSelectedBtn" class="btn btn-warning btn-sm">선택 다운로드</button>
                            </div>
                          </c:otherwise>
                        </c:choose>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- /.card-body -->
              <!-- card-footer-->
               <div class="card-footer d-flex justify-content-center">
                  <a class="btn btn-primary mr-1" href="/bdder/postBdder?bidPblancSn=${bidPblancVO.bidPblancSn}">입찰</button>
                  <a class="btn btn-secondary" href="/bidPblanc/getBidPblancList">목록</a>
                </div>
              <!-- card-footer-->
            </div>
            <!-- /// body /// -->
            <%@ include file="../include/footer.jsp" %>
        </body>

        </html>