<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<%@ include file="../include/header.jsp" %>

<script type="text/javascript" src="/js/jquery-3.6.0.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    #excelPreviewArea {
        margin-top: 20px;
        max-height: 400px;
        overflow: auto;
        border: 1px solid #ccc;
    }
    #excelPreviewArea table {
        border-collapse: collapse;
        width: 100%;
        font-size: 12px;
    }
    #excelPreviewArea th, #excelPreviewArea td {
        border: 1px solid #ddd;
        padding: 5px 8px;
        text-align: left;
    }
    #excelPreviewArea th {
        background-color: #f2f2f2;
    }
</style>


<h2>ğŸ“¤ ê´€ë¦¬ë¹„ ì—‘ì…€ ì—…ë¡œë“œ</h2>

<form action="/managect/upload" method="post" enctype="multipart/form-data">
    <input type="file" name="file" id="excelFile" accept=".xlsx,.xls" required />
    <button type="submit">ì—…ë¡œë“œ</button>
</form>
<button type="button" onclick="back()">ê´€ë¦¬ë¹„ ë‚´ì—­ ì¡°íšŒ</button>
<br/>
<p style="color:blue;">
    ${message}
</p>

<h3>ğŸ“„ ì—‘ì…€ ë¯¸ë¦¬ë³´ê¸°</h3>
<div id="excelPreviewArea">
    <p style="padding:10px; color:#888;">íŒŒì¼ì„ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
</div>


<script>
    // JQueryì˜ $(document).ready(...)ì™€ ë™ì¼í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.
    document.addEventListener("DOMContentLoaded", function() {

        // ë¯¸ë¦¬ ì‚¬ìš©í•  DOM ìš”ì†Œë¥¼ ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.
        var fileInput = document.getElementById("excelFile");
        var previewArea = document.getElementById("excelPreviewArea");

        // íŒŒì¼ ì…ë ¥(id="excelFile")ì— 'change' ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        fileInput.addEventListener("change", function(e) {

            // ì‚¬ìš©ìê°€ ì„ íƒí•œ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
            var file = e.target.files[0];
            if (!file) {
                previewArea.innerHTML = "<p style='padding:10px; color:#888;'>íŒŒì¼ ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>";
                return;
            }

            // JavaScriptì˜ FileReaderë¥¼ ì‚¬ìš©í•´ íŒŒì¼ì„ ì½ìŒ
            var reader = new FileReader();

            reader.onload = function(event) {
                try {
                    var data = new Uint8Array(event.target.result);

                    // 1. SheetJSë¡œ ì—‘ì…€ íŒŒì¼ ì½ê¸°
                    var workbook = XLSX.read(data, { type: 'array' });

                    // 2. ì²« ë²ˆì§¸ ì‹œíŠ¸ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                    var firstSheetName = workbook.SheetNames[0];

                    // 3. ì²« ë²ˆì§¸ ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    var worksheet = workbook.Sheets[firstSheetName];

                    // 4. SheetJS ìœ í‹¸ì„ ì‚¬ìš©í•´ ì‹œíŠ¸ ë°ì´í„°ë¥¼ HTML í…Œì´ë¸”ë¡œ ë³€í™˜
                    var htmlPreview = XLSX.utils.sheet_to_html(worksheet, { editable: false });

                    // 5. id="excelPreviewArea" ì˜ì—­ì— ìƒì„±ëœ HTML í…Œì´ë¸” ì‚½ì…
                    previewArea.innerHTML = htmlPreview;

                    // 6. [!!! ë°”ë‹ë¼ JSë¡œ 17ë²ˆì§¸ ì—´ ìˆ¨ê¸°ê¸° !!!]

                    // 17ë²ˆì§¸ ëª¨ë“  th (í—¤ë”)ë¥¼ ì°¾ì•„ì„œ NodeListë¡œ ê°€ì ¸ì˜´
                    var ths = previewArea.querySelectorAll("table th:nth-child(n+6)");
                    // NodeListë¥¼ ìˆœíšŒí•˜ë©°(forEach) ëª¨ë“  í—¤ë”ë¥¼ ìˆ¨ê¹€
                    ths.forEach(function(th) {
                        th.style.display = 'none';
                    });

                    // 17ë²ˆì§¸ ëª¨ë“  td (ë°ì´í„° ì…€)ë¥¼ ì°¾ì•„ì„œ NodeListë¡œ ê°€ì ¸ì˜´
                    var tds = previewArea.querySelectorAll("table td:nth-child(n+6)");
                    // NodeListë¥¼ ìˆœíšŒí•˜ë©°(forEach) ëª¨ë“  ì…€ì„ ìˆ¨ê¹€
                    tds.forEach(function(td) {
                        td.style.display = 'none';
                    });

                } catch (error) {
                    console.error("ì—‘ì…€ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì¤‘ ì˜¤ë¥˜:", error);
                    previewArea.innerHTML = "<p style='color:red;'>ì—‘ì…€ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.</p>";
                }
            };

            reader.onerror = function(error) {
                console.error("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:", error);
                previewArea.innerHTML = "<p style='color:red;'>íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>";
            };

            // íŒŒì¼ì„ ArrayBuffer (ë°”ì´ë„ˆë¦¬ ë°ì´í„°) í˜•ì‹ìœ¼ë¡œ ì½ê¸° ì‹œì‘
            reader.readAsArrayBuffer(file);
        });
    });

    function back() {
        window.location.href = '/managect/view';
    }
</script>

<%@ include file="../include/footer.jsp" %>