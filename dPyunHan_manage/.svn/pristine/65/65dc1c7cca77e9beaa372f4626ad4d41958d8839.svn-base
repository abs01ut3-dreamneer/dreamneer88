<%@ page language="java" contentType="text/html; charset=UTF-8" %>
	<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
		<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
			<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
				<!DOCTYPE html>
				<html>

				<head>

					<title></title>
				</head>
				<style>
					.drft-table,
					.sanctnln-table {
						width: 100%;
						height: 180px;
						border-collapse: collapse;
						border: 2px solid black;
					}

					.reference-table {
						width: 100%;
						height: auto;
						/* ÎÜíÏù¥ ÏûêÎèô Ï°∞Ï†à */
						border-collapse: collapse;
						border: 2px solid black;
						margin-bottom: 20px;
					}

					.reference-table td {
						border: 2px solid black;
						height: 40px;
						/* Ìïú Ï§ÑÎßå ÌïÑÏöîÌïòÎãà 40px */
						text-align: center;
					}

					.drft-table td,
					.sanctnln-table td {
						border: 2px solid black;
						height: 40px;
						text-align: center;
					}

					.drft-table .header,
					.sanctnln-table .header,
					.reference-table .header {
						font-weight: bold;
					}

					#sanctnlnArea {
						display: flex;
						gap: 30px;
						align-items: flex-start;
					}

					#sanctnlnArea>div:first-child {
						flex: 0 0 auto;
					}

					#sanctnlnArea>div:last-child {
						flex: 1;
						min-width: 500px;
					}

					.drft-table {
						width: 200px;
					}

					.sanctnln-table,
					.reference-table {
						width: 100%;
						margin-bottom: 20px;
					}

					.empVOList {
						margin-left: 20px;
						border-left: 2px solid #ddd;
						padding-left: 10px;
					}

					.empVOList label {
						margin-left: 5px;
					}
				</style>
				<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
				<script type="text/javascript" src="/ckeditor5/ckeditor.js"></script>
				<script type="text/javascript">
					document.addEventListener("DOMContentLoaded", function () {
						
						ClassicEditor
							.create(document.querySelector('#editor'), {
								// ÏóêÎîîÌÑ∞ ÏÑ§Ï†ï
								toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote'],
								height: '500px',
								ckfinder: { uploadUrl: '/image/upload' }
							})
							.then(editor => {
								window.editor = editor;
								editor.enableReadOnlyMode('readOnly');
								const toolbarElement = editor.ui.view.toolbar.element;
							    toolbarElement.style.display = 'none';
							})
							.catch(error => {
								console.error("check: editor error => ", error);
							});

						//Í∏∞ÏïàÏûê Í∞í ÎÑ£Í∏∞
						document.querySelector("#drftEmpId").value = "${empVO.empId}";
						document.querySelector("#drftClsfName").value = "${empVO.clsfName}";
						document.querySelector("#drftNm").value = "${empVO.nm}";

						async function sanctnlnDetail() {
							try {
								const elctrnsanctnSn = document.querySelector("#elctrnsanctnSn").value;
								// Í≤∞Ïû¨ÏÑ† Í∞í ÎÑ£Í∏∞		
								const data = {
									"elctrnsanctnSn": elctrnsanctnSn
								}
								const response = await axios.post("/elctrnsanctn/getSanctnln", data);
								response.data.sanctnlnVOList.forEach(sanctnlnVO => {
									addApproverColumn(sanctnlnVO.empVO, sanctnlnVO.sanctnOrdr);
								})
								updateReferenceDisplay(response.data.drftRefrnVOList);
							} catch (error) {
								console.log("error => ", error);
							}
						}
						sanctnlnDetail();

						// Í≤∞Ïû¨Ïûê Ïó¥ Ï∂îÍ∞Ä Ìï®Ïàò
						function addApproverColumn(empVO, sanctnOrdr) {
							document.querySelector(".tr-sanctnln-ordr").appendChild(createTd(sanctnOrdr));
							document.querySelector(".tr-clsf").appendChild(createTd(empVO.clsfName));
							document.querySelector(".tr-nm").appendChild(createTd(empVO.nm));

							const empIdTd = createTd(empVO.empId);
							empIdTd.dataset.empId = empVO.empId;
							document.querySelector(".tr-empId").appendChild(empIdTd);
						}
						// td ÏÉùÏÑ± Ìó¨Ìçº Ìï®Ïàò
						function createTd(text) {
							const td = document.createElement("td");
							td.className = "data-cell";
							td.textContent = text;
							return td;
						}

						// Ï∞∏Ï°∞Ïûê Ï†ïÎ≥¥ ÌëúÏãú Ìï®Ïàò
						function updateReferenceDisplay(drftRefrnVOList) {
							const refDisplay = document.querySelector("#reference-display");

							if (drftRefrnVOList.length === 0) {
								refDisplay.textContent = "";
								refDisplay.dataset.refIds = "";
								return;
							}

							let referenceText = "";
							const refIds = [];

							drftRefrnVOList.forEach((drftRefrnVO, idx) => {
								const refId = drftRefrnVO.empId;
								const refName = drftRefrnVO.empVO.nm;

								refIds.push(refId);
								referenceText += (idx > 0 ? ", " : "") + refName;
							});

							refDisplay.textContent = referenceText;
							refDisplay.dataset.refIds = refIds.join(",");
						}


						// ÏàòÏ†ï Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
						document.querySelector("#editBtn")?.addEventListener("click", function () {

							//Î≤ÑÌäº Ï†ïÎ¶¨
							document.querySelector("#editBtn").style.display = "none";
							document.querySelector("#setSanctnlnBtn").removeAttribute("style");

							document.querySelector("#drftSj").removeAttribute("readonly");
							if (window.editor) {
								window.editor.disableReadOnlyMode('readOnly');
								
								const toolbarElement = window.editor.ui.view.toolbar.element;
							    toolbarElement.style.display = 'flex';
							}
						});

						// Í≤∞Ïû¨ÏÑ†ÏÑ§Ï†ï Î≤ÑÌäº ÌÅ¥Î¶≠
						document.querySelector("#setSanctnlnBtn").addEventListener("click", function () {
							// ÌÖåÏù¥Î∏îÏùò Î™®Îì† data-cell Ï†úÍ±∞
							document.querySelector(".tr-sanctnln-ordr").querySelectorAll(".data-cell").forEach(cell => cell.remove());
							document.querySelector(".tr-clsf").querySelectorAll(".data-cell").forEach(cell => cell.remove());
							document.querySelector(".tr-nm").querySelectorAll(".data-cell").forEach(cell => cell.remove());
							document.querySelector(".tr-empId").querySelectorAll(".data-cell").forEach(cell => cell.remove());
							// Ï∞∏Ï°∞ ÌÖåÏù¥Î∏îÎèÑ Ï¥àÍ∏∞Ìôî
							const refDisplay = document.querySelector("#reference-display");
							if (refDisplay) {
								refDisplay.textContent = "";
								refDisplay.dataset.refIds = "";
							}
						});

						// ==========================Î™®Îã¨ JS ÏãúÏûë==========================
						document.querySelectorAll('#deptEmpTree label').forEach(label => {
							label.addEventListener('click', function (e) {
								const forAttr = label.getAttribute('for');
								if (!forAttr) return;

								const prefix = "dept_";
								if (!forAttr.startsWith(prefix)) return;

								const deptCode = forAttr.substring(prefix.length);

								const empDiv = document.getElementById('empList_' + deptCode);
								if (!empDiv) return;

								if (empDiv.style.display === 'none' || empDiv.style.display === '') {
									empDiv.style.display = 'block';
								} else {
									empDiv.style.display = 'none';
								}
								e.preventDefault(); // label Í∏∞Î≥∏ ÌÅ¥Î¶≠ ÎèôÏûë Î∞©ÏßÄ
							});
						});

						// Î∂ÄÏÑú Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÅ¥Î¶≠ Ïãú Ìï¥Îãπ Î∂ÄÏÑú ÏßÅÏõê Ï≤¥ÌÅ¨Î∞ïÏä§ Ï†ÑÏ≤¥ ÏÑ†ÌÉù/Ìï¥Ï†ú
						document.querySelectorAll('.dept-check').forEach(deptCheck => {
							deptCheck.addEventListener('change', function (e) {
								const deptCode = e.target.dataset.dept;
								const empDiv = document.getElementById("empList_" + deptCode);
								if (!empDiv) return;

								const empChecks = empDiv.querySelectorAll('input[type="checkbox"]');
								empChecks.forEach(empChk => {
									empChk.checked = e.target.checked;
								});
							});
						});


						// Í≤∞Ïû¨ÏÑ† Ï∂îÍ∞Ä Î≤ÑÌäº
						document.querySelector("#sanctnlnAddBtn").addEventListener("click", function () {
							addEmpsToWrapper("sanctnln", "#sanctnlnWrapper");
						});

						// Ï∞∏Ï°∞ Ï∂îÍ∞Ä Î≤ÑÌäº
						document.querySelector("#referenceAddBtn").addEventListener("click", function () {
							addEmpsToWrapper("reference", "#referenceWrapper");
						});

						// ÏßÅÏõêÏùÑ ÏÑ†ÌÉùÎêú ÏòÅÏó≠Ïóê Ï∂îÍ∞ÄÌïòÎäî ÌÜµÌï© Ìï®Ïàò
						function addEmpsToWrapper(type, wrapperId) {
							const checkedEmpCheckboxes = document.querySelectorAll('.empVOList input[type="checkbox"]:checked');
							const wrapper = document.querySelector(wrapperId);

							checkedEmpCheckboxes.forEach(empChk => {
								const empId = empChk.id;
								const elementId = `\${type}_\${empId}`;

								// Ï§ëÎ≥µ Ï≤¥ÌÅ¨
								if (document.getElementById(elementId)) return;

								const empLabel = document.querySelector(`label[for="\${empId}"]`);
								const empName = empLabel ? empLabel.textContent.trim() : "";

								const empDiv = createEmpElement(elementId, empName, () => {
									wrapper.removeChild(empDiv);
									empChk.checked = false;

									// Í≤∞Ïû¨ÏÑ†Ïù∏ Í≤ΩÏö∞Îßå ÏàúÏÑú ÏóÖÎç∞Ïù¥Ìä∏
									if (type === "sanctnln") {
										updateOrderNumbers();
									}
								});

								wrapper.appendChild(empDiv);

								// Í≤∞Ïû¨ÏÑ†Ïù∏ Í≤ΩÏö∞ ÏàúÏÑú ÏóÖÎç∞Ïù¥Ìä∏
								if (type === "sanctnln") {
									updateOrderNumbers();
								}
							});
						}

						// ÏßÅÏõê ÏöîÏÜå ÏÉùÏÑ± Ìï®Ïàò
						function createEmpElement(id, empName, onRemove) {
							const empDiv = document.createElement("div");
							empDiv.id = id;
							empDiv.style.cssText = "margin-right:8px; padding:2px 5px; border:1px solid #aaa; border-radius:4px; display:inline-block; user-select:none;";

							// ÏàúÏÑúÎ•º ÌëúÏãúÌï† div (sanctnlnÏù∏ Í≤ΩÏö∞Îßå)
							const orderDiv = document.createElement("div");
							orderDiv.className = "sanctnlnOrdr";
							orderDiv.style.cssText = "display:inline; margin-right:4px; font-weight:bold;";
							orderDiv.textContent = ""; // ÎÇòÏ§ëÏóê updateOrderNumbersÏóêÏÑú ÏÑ§Ï†ï

							// ÏßÅÏõê Ïù¥Î¶ÑÏùÑ ÌëúÏãúÌï† div
							const nameDiv = document.createElement("div");
							nameDiv.className = "empName";
							nameDiv.style.cssText = "display:inline;";
							nameDiv.textContent = empName;

							// ÏÇ≠Ï†ú Î≤ÑÌäº
							const removeBtn = document.createElement("button");
							removeBtn.type = "button";
							removeBtn.className = "removeBtn";
							removeBtn.style.marginLeft = "4px";
							removeBtn.textContent = "x";
							removeBtn.addEventListener("click", (e) => {
								e.preventDefault();
								onRemove();
							});

							empDiv.appendChild(orderDiv);
							empDiv.appendChild(nameDiv);
							empDiv.appendChild(removeBtn);

							return empDiv;
						}

						// Í≤∞Ïû¨ÏÑ† ÏàúÏÑúÎ≤àÌò∏ ÏóÖÎç∞Ïù¥Ìä∏
						function updateOrderNumbers() {
							document.querySelectorAll("#sanctnlnWrapper > div").forEach((div, idx) => {
								let orderDiv = div.querySelector(".sanctnlnOrdr");

								if (!orderDiv) {
									orderDiv = document.createElement("div");
									orderDiv.className = "sanctnlnOrdr";
									orderDiv.style.cssText = "display:inline; margin-right:4px; font-weight:bold;";
									div.insertBefore(orderDiv, div.firstChild);
								}

								// [1], [2] ÌòïÌÉúÍ∞Ä ÏïÑÎãàÎùº 1, 2 ÌòïÌÉúÎ°ú Ï†ÄÏû•
								orderDiv.textContent = (idx + 1);
							});
						}

						//confirmBtn ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
						document.querySelector("#confirmBtn").addEventListener("click", function () {
							addSanctnlnToTable()
							document.querySelector("#setSanctnln [data-dismiss='modal']").click();
						});

						function addSanctnlnToTable() {
							const sanctnlnDivs = document.querySelectorAll("#sanctnlnWrapper > div");
							const referenceDivs = document.querySelectorAll("#referenceWrapper > div");

							// Í≤∞Ïû¨Ïûê Ï†ïÎ≥¥ Ï∂îÍ∞Ä
							sanctnlnDivs.forEach((div, index) => {
								const empInfo = parseEmpInfo(div);
								addApproverColumn(empInfo, index + 1);
							});

							// Ï∞∏Ï°∞Ïûê Ï†ïÎ≥¥ ÌëúÏãú
							updRfrnDisplay(referenceDivs);
						}

						function parseEmpInfo(div) {
							const empId = div.id.replace("sanctnln_", "");
							const empLabel = document.querySelector(`label[for="\${empId}"]`);
							const fullText = empLabel ? empLabel.textContent.trim() : "";

							const parts = fullText.split(/\s+/);
							const nm = parts[0] || "";
							const clsfName = parts[1] || "";

							console.log("empId: ", empId, "nm: ", nm, "clsfName: ", clsfName);

							return { empId, nm, clsfName };
						}

						function updRfrnDisplay(referenceDivs) {
							const refDisplay = document.querySelector("#reference-display");

							if (referenceDivs.length === 0) {
								refDisplay.textContent = "";
								refDisplay.dataset.refIds = "";
								return;
							}

							let referenceText = "";
							const refIds = [];

							referenceDivs.forEach((div, index) => {
								const refId = div.id.replace("reference_", "");
								const refName = div.querySelector(".empName")?.textContent.trim() || "";

								refIds.push(refId);
								referenceText += (index > 0 ? ", " : "") + refName;
							});

							refDisplay.textContent = referenceText;
							refDisplay.dataset.refIds = refIds.join(",");
						}
						// ==========================Î™®Îã¨ JS ÎÅù==========================

						//submitÎ≤ÑÌäº ÌÅ¥Î¶≠
						document.querySelector("#submitBtn")?.addEventListener("click", function () {
							if (window.editor) {
                                const editorData = window.editor.getData();
                                document.querySelector("#editor").value = editorData;
                            }

							const sanctnlnData = [];
                            const ordrCells = document.querySelectorAll(".tr-sanctnln-ordr .data-cell");
                            const empIdCells = document.querySelectorAll(".tr-empId .data-cell");
                            
                            ordrCells.forEach((cell, index) => {
                                const order = cell.textContent.trim();
                                const empId = empIdCells[index].getAttribute("data-emp-id") || empIdCells[index].textContent.trim();

                                sanctnlnData.push({ "sanctnOrdr": order, "empId": empId });
                            });
                            
                            document.querySelector("#sanctnlnList").value = JSON.stringify(sanctnlnData);

							const refDisplay = document.querySelector("#reference-display");
                            const refIds = refDisplay.dataset.refIds || "";  // "emp1,emp2,emp3" ÌòïÌÉú
							console.log("check : refIds => ", refIds);
                            
                            const referenceData = refIds ? refIds.split(",").map(id => ({ "empId": id.trim() })) : [];
                            document.querySelector("#referenceList").value = JSON.stringify(referenceData);
                            
							document.querySelector("#drftTmprstre").value = 0;

                            const form = document.querySelector("#elctrnsanctnForm");
                            form.action = "/elctrnsanctn/postElctrnsanctnFromTmpr";
                            form.method = "post";
                            form.submit();
						});// submitÎ≤ÑÌäº ÌÅ¥Î¶≠
						
						documet.querySelector()
					})
				</script>

				<body>
					<%@ include file="../include/header.jsp" %>

						<div class="jumbotron">
							<div class="container">
								<h1 class="display-3">Ï†ÑÏûê Í≤∞Ïû¨ ÏÉÅÏÑ∏</h1>								
							</div>
						</div>

						<!--/// body /// -->
						<form id="elctrnsanctnForm">
							<div>
								<h3>Í∏∞Î≥∏ ÏÑ§Ï†ï</h3>
								<input type="hidden" id="elctrnsanctnSn" name="elctrnsanctnSn" value="${elctrnsanctnVO.elctrnsanctnSn }">
								<table border="1">
									<tr>
										<td>Î¨∏ÏÑú Ï¢ÖÎ•ò</td>
										<td>${drftDocVO.elctrnsanctnManageVO.sanctnSecode}</td>
										<td>${drftDocVO.drftDocNm}</td>
										<td>Í∏∞ÏïàÏûê <input type="hidden" id="empId" name="empId" value="${empVO.empId}">
										</td>
										<td>${empVO.nm}</td>
									</tr>
									<tr>
										<td>Îì±Î°ù ÏùºÏãú</td>
										<td>
											<fmt:formatDate value="${elctrnsanctnVO.creatDt}" pattern="yyyy-MM-dd" />
										</td>
										<td>Í∏∞Ïïà ÏùºÏãú</td>
										<td>
											<fmt:formatDate value="${elctrnsanctnVO.drftDt}" pattern="yyyy-MM-dd" />
										</td>
										<td>
											${elctrnsanctnVO.drftTmprstreStts}
										</td>
									</tr>
								</table>
								<!-- Í∏∞Ïïà_Î¨∏ÏÑú -->
							</div>
														
							<c:if test="${elctrnsanctnVO.drftTmprstre == 1 && elctrnsanctnVO.empId == empVO.empId}">
								<div id="btns">
									<input type="button" id="editBtn" value="ÏàòÏ†ïÌïòÍ∏∞">
									<input type="button" id="submitBtn" value="Í∏∞ÏïàÌïòÍ∏∞">
									<input type="button" id="submitBtn" value="ÎØ∏Î¶¨Ïù∏ÏáÑÎ≥¥Í∏∞">
									<input type="button" id="deleteBtn" value="ÏÇ≠Ï†ú">
								</div>
							</c:if>
							
							<div>
								<h3>Í≤∞Ïû¨ÏÑ†</h3>
								<a href="#setSanctnln" data-toggle="modal" id="setSanctnlnBtn"
									class="btn btn-primary btn-sm setSanctnln" style="display: none;">Í≤∞Ïû¨ÏÑ†ÏÑ§Ï†ï</a>
								<div id="sanctnlnArea">
									${drftDocVO.drftDocFormat}									
								</div>
							</div>

							<div>
								<h3>ÏÉÅÏÑ∏ ÏûÖÎ†•</h3>
								<div id="drftCnArea">
									<p>Ï†úÎ™©</p>
									<input type="text" value="${elctrnsanctnVO.drftSj}" id="drftSj" name="drftSj" readonly="readonly">
									<p>Î≥∏Î¨∏</p>
									<textarea id="editor" name="drftCn">${elctrnsanctnVO.drftCn}</textarea>
								</div>
							</div>
							<input type="hidden" name="sanctnlnList" id="sanctnlnList"> 
							<input type="hidden" name="referenceList" id="referenceList">
							<input type="hidden" name="drftTmprstre" id="drftTmprstre">
						</form>
						

						<!-- /// body /// -->
						<!-- Í≤∞Ïû¨ÏÑ† Î™®Îã¨ -->
						<div class="modal" id="setSanctnln">
							<div class="modal-content">
								<!-- Î™®Îã¨ Ìó§Îçî -->
								<div class="modal-header">
									<h2>Í≤∞Ïû¨ÏÑ† ÏÑ§Ï†ï</h2>
									<button class="close-btn" data-dismiss="modal">&times;</button>
								</div>

								<!-- Î™®Îã¨ Î∞îÎîî -->
								<div class="modal-body">
									<!-- Ï°∞ÏßÅÎèÑ ÏòÅÏó≠ -->
									<div id="deptEmpSection">
										<div id="searchBox">
											<input type="text" placeholder="Ïù¥Î¶Ñ, Ï°∞ÏßÅ Í≤ÄÏÉâ">
											<button id="searchBtn">üîç</button>
											<button id="refreshBtn">üîÑ</button>
										</div>

										<div id="deptEmpTree">
											<c:forEach var="deptVO" items="${deptVOList}">
												<c:choose>
													<c:when
														test="${not empty deptVO.empVOList and deptVO.empVOList[0].nm != null}">
														<input type="checkbox" class="dept-check"
															id="dept_${deptVO.deptCode}"
															data-dept="${deptVO.deptCode}" />
														<label for="dept_${deptVO.deptCode}">${deptVO.deptNm
															}</label>
														<div class="empVOList" id="empList_${deptVO.deptCode}"
															style="display: none;">
															<c:forEach var="empVO" items="${deptVO.empVOList }">
																<input type="checkbox" id="${empVO.empId}" />
																<label for="${empVO.empId}">${empVO.nm}
																	${empVO.clsfName }</label>
																<br />
															</c:forEach>
														</div>
													</c:when>
													<c:otherwise>
														<input type="checkbox" class="dept-check"
															id="dept_${deptVO.deptCode}" data-dept="${deptVO.deptCode}"
															disabled />
														<label for="dept_${deptVO.deptCode}">${deptVO.deptNm
															}</label>
													</c:otherwise>
												</c:choose>
												<hr />
											</c:forEach>
										</div>
									</div>

									<!-- Í≤∞Ïû¨ Îã®Í≥Ñ Î≤ÑÌäº -->
									<div id="sanctnlnBtnSection">
										<button id="sanctnlnAddBtn">Í≤∞Ïû¨</button>
										<button id="referenceAddBtn">Ï∞∏Ï°∞</button>
									</div>

									<!-- ÏÑ†ÌÉùÎêú Í≤∞Ïû¨ÏÑ† ÏòÅÏó≠ -->
									<div id="sanctnlnSection">
										<div id="bkmkSanctnlnBox">
											<select id="bkmkSanctnlnSelect">
												<option>ÏûêÏ£º Ïì∞Îäî Í≤∞Ïû¨ÏÑ†</option>
											</select>
										</div>

										<div style="border: 1px solid black; height: 100px;" id="sanctnlnWrapper"></div>

										<!-- Ï∞∏Ï°∞ ÏòÅÏó≠ -->
										<div id="referenceSection">
											<label>Ï∞∏Ï°∞</label>
											<div style="border: 1px solid black; height: 100px;" id="referenceWrapper">
											</div>
										</div>
									</div>
								</div>

								<!-- Î™®Îã¨ Ìë∏ÌÑ∞ -->
								<div class="modal-footer">
									<button id="confirmBtn">ÌôïÏù∏</button>
									<button type="button" data-dismiss="modal">Close</button>
								</div>
							</div>
						</div>

						<%@ include file="../include/footer.jsp" %>
				</body>

				</html>