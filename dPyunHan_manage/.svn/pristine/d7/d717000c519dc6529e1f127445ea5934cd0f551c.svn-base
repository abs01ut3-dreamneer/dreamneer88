<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mapper.MtinspMapper">

    <select id="findMetersByMonth" parameterType="java.lang.String" resultType="mtinspVO">
        SELECT
            HSHLD_ID,
            IEM_NM,
            SUM(USGQTY) AS USGQTY  -- 사용량을 합산
        FROM
            MTINSP
        WHERE
            TO_CHAR(MTINSP_DT, 'YYYYMM') = #{billingMonth}
        GROUP BY
            HSHLD_ID, IEM_NM
    </select>

    <select id="getUsageHistory" resultType="pivotedmtinspvo" parameterType="map">
        SELECT
        mtinsp_dt,
        SUM(CASE WHEN iem_nm = '전기' THEN usgqty ELSE 0 END) AS electric_usage,
        SUM(CASE WHEN iem_nm = '수도' THEN usgqty ELSE 0 END) AS water_usage,
        SUM(CASE WHEN iem_nm = '가스' THEN usgqty ELSE 0 END) AS gas_usage
        FROM
        mtinsp
        WHERE
        TO_CHAR(mtinsp_dt, 'YYYYMM') = #{yyyymm}
        <if test="hshldId != null and hshldId != ''">
            AND hshld_id = #{hshldId}
        </if>
        GROUP BY
        mtinsp_dt
        ORDER BY
        mtinsp_dt
    </select>

    <select id="getNextMtinspPKs" parameterType="int" resultType="long">
        SELECT MTINSP_SEQ.NEXTVAL
        FROM DUAL
            CONNECT BY LEVEL &lt;= #{count}
    </select>

    <insert id="insertBatchMeterData" parameterType="list">
        INSERT ALL

        <foreach collection="list" item="item">
            INTO MTINSP (
            MTINSP_SN,    HSHLD_ID,     IEM_NM,       USGQTY,       MTINSP_DT     ) VALUES (
            #{item.MTINSP_SN}, #{item.HSHLD_ID},
            #{item.IEM_NM},
            #{item.USGQTY},
            #{item.MTINSP_DT, jdbcType=TIMESTAMP}
            )
        </foreach>

        SELECT * FROM DUAL
    </insert>
   	
   	<!-- 2025/11/19 KWH 
   		이동평균표준편차 검침 이상 분석 -->
   		 
   <!-- 전체 검침 데이터 조회 (이상치 분석용) -->
    <select id="getAllReadings" resultType="mtinspVO">
        SELECT 
            MTINSP_SN
            , HSHLD_ID
            , IEM_NM
            , USGQTY
            , TO_CHAR(MTINSP_DT, 'YYYY/MM/DD') AS mtinspDt
        FROM MTINSP
        ORDER BY MTINSP_DT ASC
    </select>
    
    <!-- 특정 세대의 검침 데이터 조회 -->
    <select id="getReadingsByHousehold" resultType="mtinspVO">
        SELECT 
            MTINSP_SN
            , HSHLD_ID
            , IEM_NM
            , USGQTY
            , TO_CHAR(MTINSP_DT, 'YYYY/MM/DD') AS mtinspDt
        FROM MTINSP
        WHERE HSHLD_ID = #{hshldId}
        ORDER BY MTINSP_DT ASC
    </select>
    
    <!-- 특정 검침 종류의 데이터 조회 -->
    <select id="getReadingsByType" resultType="mtinspVO">
        SELECT 
            MTINSP_SN
            , HSHLD_ID
            , IEM_NM
            , USGQTY AS
            , TO_CHAR(MTINSP_DT, 'YYYY/MM/DD') AS mtinspDt
        FROM MTINSP
        WHERE IEM_NM = #{iemNm}
        ORDER BY MTINSP_DT ASC
    </select>
    
    <!-- 스케줄러용 조회 쿼리 -->
    
    <!-- 특정 날짜의 검침 데이터 조회 -->
    <select id="getReadingsByDate" resultType="mtinspVO">
        SELECT 
            MTINSP_SN
            , HSHLD_ID
            , IEM_NM
            , USGQTY
            , TO_CHAR(MTINSP_DT, 'YYYY/MM/DD') AS mtinspDt
        FROM MTINSP
        WHERE TRUNC(MTINSP_DT) = TRUNC(#{date})
        ORDER BY MTINSP_DT ASC
    </select>
    
    <!-- 최근 N시간 이내의 검침 데이터 조회 -->
    <select id="getRecentReadings" resultType="mtinspVO">
        SELECT 
            MTINSP_SN
            , HSHLD_ID
            , IEM_NM 
            , USGQTY
            , TO_CHAR(MTINSP_DT, 'YYYY/MM/DD') AS mtinspDt
        FROM MTINSP
        WHERE MTINSP_DT >= SYSDATE - (#{hours} / 24)
        ORDER BY MTINSP_DT DESC
    </select>
    
    <!-- 기간별 검침 데이터 조회 -->
    <select id="getReadingsByDateRange" resultType="kr.or.ddit.vo.MtinspVO">
        SELECT 
            MTINSP_SN
            , HSHLD_ID
            , IEM_NM
            , USGQTY
            , TO_CHAR(MTINSP_DT, 'YYYY/MM/DD') AS mtinspDt
        FROM MTINSP
        WHERE TRUNC(MTINSP_DT) BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
                                   AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
        ORDER BY MTINSP_DT ASC
    </select>

    <select id="getHistoricalReadingsForAll" resultType="kr.or.ddit.vo.MtinspVO">
        SELECT
            HSHLD_ID,
            IEM_NM,
            TO_CHAR(MTINSP_DT, 'YYYY/MM/DD') AS mtinspDt,
            USGQTY
        FROM
            MTINSP
        WHERE
          -- MTINSP_DT가 종료일 이전이어야 함 (어제 날짜까지)
            MTINSP_DT &lt; #{endDate}
          AND
          -- MTINSP_DT가 (종료일 - (weeks * 7일)) 이후여야 함
            MTINSP_DT >= #{endDate} - (#{weeks} * 7)

        ORDER BY
            HSHLD_ID ASC, IEM_NM ASC, MTINSP_DT ASC
    </select>
</mapper>