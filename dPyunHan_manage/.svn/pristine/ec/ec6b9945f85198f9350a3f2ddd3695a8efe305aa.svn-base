package kr.or.ddit.controller;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import kr.or.ddit.config.BeanController;
import kr.or.ddit.service.CvplRceptService;
import kr.or.ddit.service.impl.CustomUser;
import kr.or.ddit.util.ArticlePage;
import kr.or.ddit.util.UploadController;
import kr.or.ddit.vo.CvplRceptVO;
import kr.or.ddit.vo.CvplVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@RequestMapping("/cvplRcept")
@Controller
public class CvplRceptController {

	@Autowired
	CvplRceptService cvplRceptService;

	@Autowired
	BeanController beanController;

	@Autowired
	UploadController uploadController;

	// 해당 부서의 민원 리스트
	@GetMapping("/list")
	public String list() {
	    return "cvplRcept/list"; // JSP 경로
	}
	@ResponseBody
	@GetMapping("/listAjax")
	public Map<String, Object> listAjax(CvplVO cvplVO, @AuthenticationPrincipal CustomUser customUser,
						@RequestParam(value = "currentPage", required = false, defaultValue = "1") int currentPage,
						@RequestParam(value = "keyword", required = false, defaultValue = "") String keyword,
						@RequestParam(value = "size", required = false, defaultValue = "5") int size,
						@RequestParam(value = "rceptSttus", required = false, defaultValue = "-1") int rceptSttus,
						@RequestParam(value = "startDate", required = false, defaultValue = "") String startDate,
						@RequestParam(value = "endDate", required = false, defaultValue = "") String endDate) {
		cvplVO.setEmpId(customUser.getEmpVO().getEmpId());
		
		//페이지네이션
		Map<String, Object> map = new HashMap<String, Object>();
		map.put("currentPage", currentPage);
		map.put("keyword", keyword);
		map.put("size", size);
		map.put("empId", cvplVO.getEmpId());
	    map.put("rceptSttus", rceptSttus);
	    map.put("startDate", startDate);
	    map.put("endDate", endDate);

		int total = this.cvplRceptService.getTotal(map);
		
		//AND E.EMP_ID = 샾{empId}
		//WHERE S.RNUM BETWEEN(샾{currentPage} * 5) - (5 - 1) AND (샾{currentPage} * 5)
		List<CvplVO> cvplVOList = this.cvplRceptService.list(map);
		
		ArticlePage<CvplVO> articlePage = new ArticlePage<CvplVO>(total, currentPage, size, cvplVOList, keyword);
		Map<String, Object> result = new HashMap<>();
		result.put("total", total);
		result.put("articlePage", articlePage);
		result.put("cvplVOList", cvplVOList);

		return result;
	}

	// 해당 민원의 상세 모달
	@ResponseBody
	@GetMapping("/cvplDetailAjax")
	public CvplVO cvplDetailAjax(@RequestParam("cvplSn") int cvplSn, CvplVO cvplVO) {
		cvplVO.setCvplSn(cvplSn);
		
		cvplVO = this.cvplRceptService.detail(cvplVO);

		return cvplVO;
	}
	
	// 해당 민원의 접수 페이지
	@GetMapping("/cvplRcept")
	public String cvplRcept(@RequestParam("cvplSn") int cvplSn, CvplVO cvplVO, Model model) {
		
		cvplVO = this.cvplRceptService.detail(cvplVO);
		
		model.addAttribute("cvplVO", cvplVO);
		
		return "cvplRcept/cvplRcept";
	}

	// 해당 민원 접수 실행
	@ResponseBody
	@PostMapping("/cvplRceptPost")
	public int cvplRceptPost(@ModelAttribute CvplRceptVO cvplRceptVO, @AuthenticationPrincipal CustomUser customUser) {
		cvplRceptVO.setEmpId(customUser.getEmpVO().getEmpId());
		
		int result = this.cvplRceptService.cvplRceptPost(cvplRceptVO);

		return result;
	}

	// 해당 민원 종결 실행
	@ResponseBody
	@PostMapping("/cvplEnPost")
	public int cvplEnPost(@ModelAttribute CvplRceptVO cvplRceptVO, @AuthenticationPrincipal CustomUser customUser) {
		cvplRceptVO.setEmpId(customUser.getEmpVO().getEmpId());
		
		int result = this.cvplRceptService.cvplEnPost(cvplRceptVO);

		return result;
	}
}
