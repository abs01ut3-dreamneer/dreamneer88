<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>

<%@ include file="../include/header.jsp"%>

<script src="/js/jquery-3.6.0.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

	// 테이블과 폼 요소 캐싱
	const tableBody = document.getElementById("cvplTableBody");			// 민원 리스트 테이블 본문 영역
	const pagingArea = document.getElementById("pagingAreaWrap");		// 페이지네이션 영역
	const form = document.getElementById("searchForm");					// 검색 폼
	const currentPageInput = document.getElementById("currentPage");	// 현재 페이지 hidden input
	
	// 초기 로딩 시 리스트 자동 조회 (0.3초 지연 후 실행)
	setTimeout(() => loadList(), 300);
	
	// 검색 이벤트 등록
	form.addEventListener("submit", e => {
		e.preventDefault();				// 기본 form submit 동작 차단
		currentPageInput.value = 1;		// 검색 시 항상 첫 페이지부터
		loadList();						// 리스트 재조회
	});

	// 초기화 버튼 클릭 시 폼 리셋
	document.getElementById("resetBtn").addEventListener("click", () => {
		form.reset();
		currentPageInput.value = 1;
		loadList();
	});

	// 리스트 데이터 로드 함수
	function loadList() {
		const params = new URLSearchParams(new FormData(form)).toString();
		
		// 로딩 표시
		tableBody.innerHTML = `
			<tr>
				<td colspan="7" class="text-center text-muted py-4">
					<div class="spinner-border text-primary" role="status">
						<span class="visually-hidden">Loading...</span>
					</div>
				</td>
			</tr>
		`;
		
		// 비동기 요청으로 리스트 조회 //List fetch
		fetch("/cvplRcept/listAjax?" + params)
			.then(res => res.json())
			.then(data => {
				renderTable(data.cvplVOList);			// 민원 리스트 렌더링
				renderPagination(data.articlePage);		// 페이지네이션 갱신
			})
			.catch(err => console.error("민원 리스트 요청 오류:", err));
	}

	// 테이블 렌더링
	function renderTable(list) {
		if (!list || list.length === 0) {
			tableBody.innerHTML = `
				<tr>
					<td colspan="7" class="text-center text-muted py-4">해당 조건에 맞는 민원이 없습니다.	</td>
				</tr>`;
			return;
		}
	
		const fragment = document.createDocumentFragment();
		const deptNm = {1: "행정", 2: "시설관리", 3: "소방안전", 4: "환경"};
		
		// 행 생성
		list.forEach(vo => {
			const row = document.createElement("tr");
			
			const statusText =
				vo.rceptSttus == 0 ? `<span style="color:gray;">대기 중</span>` :
				vo.rceptSttus == 1 ? `<span style="color:orange;">처리 중</span>` :
				`<span style="color:green;">완료</span>
			`;
			
			// 상태별 버튼 구성
			let actionBtns = `
				<button type="button" class="btn btn-outline-primary btn-sm detailBtn"
						data-cvplsn="\${vo.cvplSn}" data-bs-toggle="modal"
						data-bs-target="#cvplDetailModal">상세</button>
			`;
			
			// 접수 버튼 추가
			if (vo.rceptSttus == 0) {
				actionBtns += `
					<button type="button" class="btn btn-primary btn-sm ms-1" onclick="location.href='/cvplRcept/cvplRcept?cvplSn=\${vo.cvplSn}'">
						접수
					</button>
				`;
			}
			
			// 종결 버튼 추가
			else if (vo.rceptSttus == 1) {
				actionBtns += `
					<button type="button" class="btn btn-success btn-sm ms-1 endBtn" data-cvplrceptid="\${vo.cvplRceptId}">
						종결
					</button>
				`;
			}
			
			const deptName = deptNm[Number(vo.deptCode)];
			
			// 행 내용 채우기
			row.innerHTML = `
				<td>\${vo.cvplSn}</td>
				<td>\${vo.cvplSj}</td>
				<td>\${vo.mberId}</td>
				<td>\${vo.reqstDt ? vo.reqstDt.substring(0,10) : '-'}</td>
				<td>\${deptName}</td>
				<td>\${statusText}</td>
				<td>\${actionBtns}</td>
			`;
			
			fragment.appendChild(row);
		});
	
		// 기존 내용 교체
		tableBody.replaceChildren(fragment);
		
		// 상세보기 버튼 이벤트 등록
		tableBody.querySelectorAll(".detailBtn").forEach(btn => {
			btn.addEventListener("click", () => loadDetail(btn.dataset.cvplsn));
		});
	
		// 종결 버튼 이벤트 등록
		tableBody.querySelectorAll(".endBtn").forEach(btn => {
			btn.addEventListener("click", () => {
				const cvplRceptId = btn.dataset.cvplrceptid;
		    
				Swal.fire({
					title: "민원을 종결하시겠습니까?",
					icon: "warning",
					showCancelButton: true,
					confirmButtonText: "예",
					cancelButtonText: "아니오"
				}).then(result => {
					if (result.isConfirmed) {
						fetch("/cvplRcept/cvplEnPost", {
							method: "POST",
							headers: {"Content-Type": "application/x-www-form-urlencoded"},
							body: `cvplRceptId=\${cvplRceptId}`
						})
						.then(res => res.text())
						.then(result => {
							if (parseInt(result) > 0) {
								Swal.fire({
									icon: "success",
									title: "민원이 종결되었습니다.",
									timer: 1500,
									showConfirmButton: false
								});
								setTimeout(() => loadList(), 1500);
							} else {
								Swal.fire({
									icon: "warning",
									title: "종결 실패",
									timer: 1500,
									showConfirmButton: false
								});
							}
						})
						.catch(() => {
							Swal.fire({
								icon: "error",
								title: "서버 오류",
								timer: 1500,
								showConfirmButton: false
							});
						});
					}
				});
			});
		});
	}

	// 상세 조회 함수
	function loadDetail(cvplSn) {
		const modalContent = document.getElementById("modalContent");
		modalContent.innerHTML = `<p class="text-center text-muted">불러오는 중...</p>`;

		fetch("/cvplRcept/cvplDetailAjax?cvplSn=" + cvplSn)
			.then(res => res.json())
			.then(vo => {
				//첨부 이미지 영역 구성
				let fileHtml = "";
				if (vo.fileGroupVO && vo.fileGroupVO.fileDetailVOList && vo.fileGroupVO.fileDetailVOList.length > 0) {
					fileHtml = `
						<p><strong>첨부 이미지:</strong></p>
						<div style="display:flex; gap:10px; flex-wrap:wrap;">
					`;
					
					vo.fileGroupVO.fileDetailVOList.forEach(file => {
					const fileUrl = "/upload" + file.fileStrelc;
						if (['jpg','jpeg','png','gif','webp'].includes(file.fileExtsn?.toLowerCase())) {
							fileHtml += `<img src="\${fileUrl}" alt="\${file.fileOrginlNm || ''}" 
								style="width:100px;height:100px;object-fit:cover;border:1px solid #ccc;border-radius:5px;">
							`;
						}
					});
					fileHtml += `</div>`;
					
				} else {
					fileHtml = `<p class="text-muted">첨부 이미지가 없습니다.</p>`;
				}
				
				const deptNm = {1: "행정", 2: "시설관리", 3: "소방안전", 4: "환경"};
				const deptName = deptNm[Number(vo.deptCode)] || "미지정";
				
				//모달 내용 렌더링
				modalContent.innerHTML = `
					<div class="p-3">
						<h5 class="fw-bold mb-2">\${vo.cvplSj}</h5>
						<p><strong>작성자:</strong> \${vo.mberId}</p>
						<p><strong>요청일:</strong> \${vo.reqstDt ? vo.reqstDt.substring(0, 10) : '-'}</p>
						<p><strong>내용:</strong></p>
						<div class="border rounded p-3 bg-light mb-3">\${vo.cvplCn}</div>
						<p><strong>부서:</strong> \${deptName}</p><hr>
						<p>\${fileHtml}</p>
					</div>
				`;
			})
			.catch(err => {
				modalContent.innerHTML = `<p class="text-danger text-center">상세 정보를 불러오지 못했습니다.</p>`;
				console.error("상세조회 오류:", err);
			});
	}

	// 페이지네이션 렌더링
	function renderPagination(articlePage) {
		if (!pagingArea) return;							//페이지 영역 DOM이 없으면 바로 종료 (예외 처리)
		//서버에서 articlePage 객체가 없거나 내부에 pagingArea HTML 코드가 없으면 영역을 비움
		if (!articlePage || !articlePage.pagingArea) {
			pagingArea.innerHTML = "";
			return;
		}
		
		pagingArea.innerHTML = articlePage.pagingArea;		//서버에서 받은 페이징 HTML(articlePage.pagingArea)을 삽입
		
		//페이징 영역 내부의 링크 클릭 이벤트를 위임 처리 (a 태그 클릭 시 화면 이동 대신 goPage() 호출)
		pagingArea.onclick = (e) => {
			const target = e.target.closest("a");			// 클릭된 a 태그 탐색
			if (!target) return;							// a 태그가 아니면 무시
			e.preventDefault();								// 기본 링크 이동 방지
			// href 속성에서 currentPage=숫자 패턴 추출
			const href = target.getAttribute("href");
			const match = href.match(/currentPage=(\d+)/);
			if (match) goPage(match[1]);					//정규식으로 추출한 페이지 번호를 goPage()에 전달
		};
	}

	// 페이지 이동 처리
	function goPage(pageNo) {
		document.getElementById("currentPage").value = pageNo;				//선택된 페이지 번호를 hidden input에 반영
		const params = new URLSearchParams(new FormData(form)).toString();	//현재 검색 폼(form)의 모든 데이터(FormData)를 직렬화하여 쿼리스트링으로 변환
		
		//List fetch
		fetch("/cvplRcept/listAjax?" + params)
			.then(res => res.json())
			.then(data => {
				renderTable(data.cvplVOList);		// 민원 리스트 렌더링
				renderPagination(data.articlePage);	// 페이지네이션 갱신
			})
			.catch(err => console.error("페이지 이동 오류:", err));
	}
});

// 백업용 페이지네이션 함수
function renderPagination(articlePage) {
	setTimeout(() => {
		const pagingArea = document.getElementById("pagingAreaWrap");
		if (!pagingArea) return;
		if (!articlePage || !articlePage.pagingArea) {
			pagingArea.innerHTML = "";
			return;
		}
		
		const newPagingArea = pagingArea.cloneNode(false);
		newPagingArea.innerHTML = articlePage.pagingArea;
		pagingArea.replaceWith(newPagingArea);
		
		newPagingArea.addEventListener("click", e => {
			const target = e.target.closest("a");
			if (!target) return;
			e.preventDefault();
			const href = target.getAttribute("href");
			const match = href.match(/currentPage=(\d+)/);
			if (match) goPage(match[1]);
		});
	}, 0);
}
</script>

<h1 class="mb-4">민원 처리 페이지</h1>

<!-- 검색 영역 -->
<div class="card mb-3">
	<div class="card-body">
		<form id="searchForm" action="/cvplRcept/list" method="get" class="row g-2 align-items-end">
			<input type="hidden" name="currentPage" id="currentPage" value="${param.currentPage != null ? param.currentPage : 1}">
			<div class="col-md-3">
				<label class="form-label fw-bold">검색어</label>
				<input type="search"name="keyword" value="${param.keyword}" class="form-control" placeholder="제목 또는 작성자">
			</div>
			<div class="col-md-2">
				<label class="form-label fw-bold">처리 상태</label>
				<select name="rceptSttus" class="form-select">
					<option value="-1">전체</option>
					<option value="0">대기 중</option>
					<option value="1">처리 중</option>
					<option value="2">완료</option>
				</select>
			</div>
			<div class="col-md-2">
				<label class="form-label fw-bold">시작일</label>
				<input type="date"name="startDate" class="form-control">
			</div>
			<div class="col-md-2">
				<label class="form-label fw-bold">종료일</label>
				<input type="date"name="endDate" class="form-control">
			</div>
			<div class="col-md-1">
				<button type="submit" class="btn btn-primary w-100">검색</button>
			</div>
			<div class="col-md-1">
				<button type="button" id="resetBtn" class="btn btn-outline-secondary w-100">초기화</button>
			</div>
		</form>
	</div>
</div>

<!-- 리스트 영역 -->
<table class="table table-striped align-middle text-center">
	<thead class="table-darkr">
		<tr>
			<th>번호</th>
			<th>제목</th>
			<th>작성자</th>
			<th>요청일</th>
			<th>부서</th>
			<th>처리상태</th>
			<th>관리</th>
		</tr>
	</thead>
	<tbody id="cvplTableBody">
		<tr>
			<td colspan="7" class="text-center text-muted py-4">해당 조건에 맞는 민원이 없습니다.</td>
		</tr>
	</tbody>
</table>

<!-- 페이지네이션 -->
<div id="pagingAreaWrap" class="card-footer clearfix">
	${articlePage.pagingArea}
</div>

<!-- 상세 모달 -->
<div class="modal fade" id="cvplDetailModal" tabindex="-1"
	aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">민원 상세 정보</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"aria-label="Close"></button>
			</div>
			<div class="modal-body" id="modalContent">
				<p class="text-center text-muted">불러오는 중...</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
			</div>
		</div>
	</div>
</div>

<%@ include file="../include/footer.jsp"%>
