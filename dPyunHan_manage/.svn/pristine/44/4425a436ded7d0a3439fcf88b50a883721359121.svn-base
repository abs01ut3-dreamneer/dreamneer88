package kr.or.ddit.controller;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.net.http.HttpHeaders;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.http.HttpStatus;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.io.ByteArrayResource;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import jakarta.servlet.http.HttpSession;
import kr.or.ddit.service.BdderService;
import kr.or.ddit.service.BidPblancService;
import kr.or.ddit.service.CcpyManageService;
import kr.or.ddit.service.EmailService;
import kr.or.ddit.service.impl.CustomUser;
import kr.or.ddit.util.ArticlePage;
import kr.or.ddit.util.UploadController;
import kr.or.ddit.vo.BdderVO;
import kr.or.ddit.vo.BidPblancVO;
import kr.or.ddit.vo.CcpyManageVO;
import kr.or.ddit.vo.FileDetailVO;
import lombok.extern.slf4j.Slf4j;

@Controller
@Slf4j
@RequestMapping("/bdder")
public class BdderController {
	
	@Autowired
	private EmailService emailService;


	@Autowired
	BidPblancService bidPblancService;

	
	@Autowired
	CcpyManageService ccpyManageService;

	@Autowired
	UploadController uploadController;

	@Autowired
	BdderService bdderService;

	@GetMapping("/postBdder")
	public String postBidder(@RequestParam int bidPblancSn, HttpSession session, Model model,
			Authentication authentication, @AuthenticationPrincipal CustomUser customuser) {

		CcpyManageVO ccpyManageVO = customuser.getCcpyManageVO();
		List<FileDetailVO> ccpyfileDetailVOList = this.uploadController.getFileDetailVOList(ccpyManageVO.getFileGroupSn());

		BidPblancVO bidPblancVO = new BidPblancVO();
		bidPblancVO.setBidPblancSn(bidPblancSn);
		
		bidPblancVO = this.bidPblancService.getBidPblancVO(bidPblancVO);
		
		List<FileDetailVO> bidPblancFileDetailVOList = this.uploadController.getFileDetailVOList(bidPblancVO.getFileGroupSn());
		
		model.addAttribute("bidPblancVO", bidPblancVO);
		model.addAttribute("bidPblancFileDetailVOList", bidPblancFileDetailVOList);
		model.addAttribute("ccpyFileDetailVOList", ccpyfileDetailVOList);
		model.addAttribute("ccpyManageVO", ccpyManageVO);
		model.addAttribute("now", new Date());
		model.addAttribute("bidPblancVO", bidPblancVO);

		return "bdder/postBdder";
	}
	
	//PDF보이기
	@GetMapping("/previewFile")
	public ResponseEntity<?> previewFile(
	    @RequestParam long fileGroupSn,
	    @RequestParam int fileNo
	) {
	    try {
	        // 파일 존재 여부 확인
	        FileDetailVO fileDetailVO = this.uploadController.getFileDetail(fileGroupSn, fileNo);
	        log.info("check : previewFile / fileDetialVO => {} ", fileDetailVO);

	        if (fileDetailVO == null) {
	            return ResponseEntity.status(HttpStatus.NOT_FOUND)
	                .body("파일을 찾을 수 없습니다.");
	        }
	        
	        log.info("File Path 값: {}", fileDetailVO.getFileStrelc());
	        log.info("실제 파일 존재 여부: {}", new File(fileDetailVO.getFileStrelc()).exists());
	        String filePath = fileDetailVO.getFileAbsltStrelc();
	        File file = new File(filePath);
	        
	        if (!file.exists()) {
	            return ResponseEntity.status(HttpStatus.NOT_FOUND)
	                .body("파일 경로가 존재하지 않습니다.");
	        }
	        
	        FileInputStream fis = new FileInputStream(file);
	        byte[] fileContent = fis.readAllBytes();
	        fis.close();
	        
	        return ResponseEntity.ok()
	            .contentType(MediaType.APPLICATION_PDF)
	            .header("Content-Disposition", "inline; filename=\"" + fileDetailVO.getFileOrginlNm() + "\"")
	            .body(new ByteArrayResource(fileContent));
	            
	    } catch (FileNotFoundException e) {
	        e.printStackTrace();
	        return ResponseEntity.status(HttpStatus.NOT_FOUND).build();
	    } catch (IOException e) {
	        e.printStackTrace();
	        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
	    } catch (Exception e) {
	        e.printStackTrace();
	        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
	    }
	}


	@PostMapping("/postBdder")
	public String postBdder(
			BdderVO bdderVO,
			BidPblancVO bidPblancVO,
			CcpyManageVO ccpyManageVO
			) {
		bdderVO.setBidPblancSn(bidPblancVO.getBidPblancSn());
		bdderVO.setCcpyManageId(ccpyManageVO.getCcpyManageId());
		
		log.info("check : postBdder/bdderVO => {}", bdderVO);		
		int result = this.bdderService.postBdder(bdderVO);
		if(result>0) {
			return "bdder/getMyBdderList";
		}
		
		return "";
	}
	
	

	// 신청, 수정, 보안, 취하
	@GetMapping("/getMyBdderList")
	public String getMyBidderList(
			Model model,
			@RequestParam(required = false, defaultValue = "") String keyword,
			@RequestParam(required = false, defaultValue = "1") int currentPage,
			@AuthenticationPrincipal CustomUser customUser
			) {
		CcpyManageVO ccpyManageVO = customUser.getCcpyManageVO();
		int size = 10;

		Map<String, Object> map = new HashMap<>();
		map.put("currentPage", currentPage);
		map.put("keyword", keyword);
		map.put("ccpyManageId", ccpyManageVO.getCcpyManageId());

		List<BdderVO> myBdderVOList = this.bdderService.getMyBdderList(map);
		int total = this.bdderService.getTotal(map);

		ArticlePage<BdderVO> articlePage = new ArticlePage<BdderVO>(total, currentPage, size, myBdderVOList, keyword);

		model.addAttribute("articlePage", articlePage);
		return "bdder/getMyBdderList";
	}
	
	@GetMapping("/getBdder")
	public String getBdder(
			BdderVO bdderVO,
			Model model
			) {		
		bdderVO = this.bdderService.getBdder(bdderVO);
		
		CcpyManageVO ccpyManageVO = bdderVO.getCcpyManageVO();
		
		List<FileDetailVO> ccpyfileDetailVOList = this.uploadController.getFileDetailVOList(ccpyManageVO.getFileGroupSn());

		BidPblancVO bidPblancVO = bdderVO.getBidPblancVO();
		
		List<FileDetailVO> bidPblancFileDetailVOList = this.uploadController.getFileDetailVOList(bidPblancVO.getFileGroupSn());
		
		
		model.addAttribute("bidPblancFileDetailVOList", bidPblancFileDetailVOList);
		model.addAttribute("ccpyFileDetailVOList", ccpyfileDetailVOList);		
				
		model.addAttribute("bdderVO", bdderVO);
		return "bdder/getBdder";
	}
	
	@ResponseBody
	@PostMapping("/putBdder")
	public Map<String, Object> putBdder(
			BdderVO bdderVO,
			BidPblancVO bidPblancVO,
			CcpyManageVO ccpyManageVO
			){
		Map<String, Object> map = new HashMap<>();
		bidPblancVO = this.bidPblancService.getBidPblancVO(bidPblancVO);
		int res = this.bidPblancService.putBidPblanc(bidPblancVO);
		bdderVO = this.bdderService.getBdder(bdderVO);
		res = this.bdderService.putBdder(bdderVO);		
		ccpyManageVO = this.ccpyManageService.getCcpyManage(ccpyManageVO);
		
		try {
			boolean result = emailService.sendBidSelectionEmail(bdderVO);
			map.put("success", result);
			log.info("입찰 선정 이메일 발송: {}", bdderVO.getCcpyManageVO().getCcpyCmpnyNm());

		} catch (Exception e) {
			map.put("success", false);
			map.put("message", "❌ 에러: " + e.getMessage());
			log.error("입찰 선정 이메일 발송 실패", e);
		}		
		return map;
	}
	
}
