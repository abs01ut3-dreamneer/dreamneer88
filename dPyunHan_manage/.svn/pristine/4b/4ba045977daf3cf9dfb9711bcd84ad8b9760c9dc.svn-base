<%@ page language="java" contentType="text/html; charset=UTF-8" %>
	<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
		<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
			<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
				<!DOCTYPE html>
				<html>

				<head>

					<title> </title>
				</head>
				<script>
					document.addEventListener("DOMContentLoaded", function () {
						document.querySelectorAll("tr[data-widget='expandable-table']").forEach(row => {
							row.addEventListener("click", function (e) {
								const isExpanded = this.getAttribute('aria-expanded') === 'true';
								let fileGroupSn = "";
								if (!isExpanded) {
									fileGroupSn = this.querySelector("#fileGroupSn").value;
									console.log("check : fileGroupSn => ", fileGroupSn);
								}

								const data = {
									"fileGroupSn": fileGroupSn
								}

								fetch("/bdder/getFileDetailVOList", {
									method: "POST",
									headers: {
										"Content-type": "application/json;charset=UTF-8"
									},
									body: JSON.stringify(data)
								})
									.then(resp => {
										return resp.json();
									})
									.then(data => {
										console.log("check : data.fileDetailVOList => ", data.fileDetailVOList);

										if (data.fileDetailVOList) {
											displayFileList(this, data.fileDetailVOList);
										}
									})
									.catch(error => {
										console.log("check : error => ", error);
									})
							}); //addEventListner => click 
						}) // forEach

						const displayFileList = (elem, fileDetailVOList) => {
							const expandableBody = elem.nextElementSibling;
							const listGroupDiv = expandableBody.querySelector(".list-group");

							if (!fileDetailVOList || fileDetailVOList.length === 0) {
								listGroupDiv.innerHTML = '<p class="text-muted">첨부파일이 없습니다.</p>';
								return;
							}

							let str = '';
							fileDetailVOList.forEach(file => {
								str += `
                  <a href="/bidPblanc/download?fileGroupSn=\${file.fileGroupSn}&fileNo=\${file.fileNo}" 
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    target="_blank">
                      <div>
                          <i class="fa fa-file"></i>
                          <strong>\${file.fileOrginlNm}</strong>
                      </div>
                  </a>
                `;
							}) // end forEach
							listGroupDiv.innerHTML = str;
						}
					});
				</script>

				<body>
					<%@ include file="../include/header.jsp" %>

						<div class="jumbotron">
							<div class="container">
								<h1 class="display-3">내가 한 입찰들</h1>
							</div>
						</div>
						<!-- ${articlePage.content} -->
						<!--/// body /// -->
						<table class="table table-bordered table-hover">
							<thead>
								<tr>
									<th>순번</th>
									<th>입찰 제목</th>
									<th>입찰 지원일</th>
									<th>입찰 마감일</th>
									<th>선정 여부</th>
								</tr>
							</thead>
							<tbody>
								<c:forEach var="bdderVO" items="${articlePage.content}">
									<tr data-widget="expandable-table" aria-expanded="false">
										<td>${bdderVO.rnum}</td>
										<td>
											${bdderVO.bidPblancVO.bidSj}
											<input type="hidden" id="bdderSn" name="bdderSn" value="${bdderVO.bdderSn}">
											<input type="hidden" id="fileGroupSn" name="fileGroupSn" value="${bdderVO.fileGroupSn}">
										</td>
										<td>
											<!-- fmt -->
											<fmt:formatDate value="${bdderVO.bidSportDt}" pattern="yyyy년 MM월 dd일"/>
											
										</td>
										<td>
											<!-- fmt -->
											<fmt:formatDate value="${bdderVO.bidPblancVO.bidClosDtAsDate}" pattern="yyyy년 MM월 dd일"/>
											
										</td>
										<td>${bdderVO.bidAtAsStr}</td>
									</tr>
									<tr class="expandable-body d-none">
										<td colspan="5">
											<div class="card card-primary">
												<h4>입찰 상세</h4>
												<table class="table table-bordered">
													<tr>
														<th>
															입찰가액
															<input type="hidden" id="bdderSn" name="bdderSn" value="${bdderVO.bdderSn}">
														</th>
														<td>
															<!-- fmt -->
															<fmt:formatNumber value="${bdderVO.bidAmount}" type="currency"></fmt:formatNumber>
															
														</td>
														<th>보증금액</th>
														<td>
															<!-- fmt -->
															<fmt:formatNumber value="${bdderVO.bidGtn}" type="currency"></fmt:formatNumber>
														</td>
													</tr>
													<tr>
														<td>첨부 파일</td>
														<td colspan="3">
															<div class="list-group">

															</div>
														</td>
													</tr>
													<tr>
														<td colspan="4">
															<button type="button" class="btn-danger deleteBtn">입찰 취소</button>
															<button type="button" class="btn-warning postBtn">파일 추가</button>
														</td>
													</tr>
												</table>
											</div>
										</td>
									</tr>
								</c:forEach>
							</tbody>
						</table>

						<!-- /// body /// -->
						<%@ include file="../include/footer.jsp" %>
				</body>

				</html>