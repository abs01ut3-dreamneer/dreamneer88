<%@ page language="java" contentType="text/html; charset=UTF-8" %>
	<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
		<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
			<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
				<!DOCTYPE html>
				<html>

				<head>
					<title>전자결재 상세</title>

					<style>
						.cke_notification {
							display: none !important;
						}
					</style>

					<script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>

					<script>
						document.addEventListener("DOMContentLoaded", function () {
							let drftCnElement = document.querySelector("#drftCn");
							let drftCn = drftCnElement.value;
							//CKEDITOR
							let drftDt = document.querySelector("#drftDt").value;
							drftCn = drftCn.replace(
								'id="elctrnsanctnDrftDt">',
								'id="elctrnsanctnDrftDt">' + drftDt
							);
							drftCnElement.value = drftCn;

							if (window.CKEDITOR) {
								CKEDITOR.replace('drftCn', {
									height: '400px',
									allowedContent: true,
									contentsCss: '/css/contract.css',
									readOnly: true
								}, function (editor) {
									editor.setData(drftCn);
								});
							} else {
								console.warn('CKEditor 로드 안됨');
							}
							//CKEDITOR

							//PDF 미리보기
							const fileLinks = document.querySelectorAll(".list-group-item");
							fileLinks.forEach(link => {
								link.addEventListener("click", function (e) {
									e.preventDefault();
									const fileGroupSn = this.getAttribute("data-file-group-sn");
									const fileNo = this.getAttribute("data-file-no");
									const fileName = this.querySelector("span").textContent;
									const fileExtension = fileName.split('.').pop().toLowerCase();

									if (fileExtension === 'pdf') {
										// PDF 파일: 미리보기
										const previewUrl = `/bdder/previewFile?fileGroupSn=\${fileGroupSn}&fileNo=\${fileNo}`;
										window.open(previewUrl, 'pdfPreview', 'width=1000,height=800');
									} else {
										// 다른 파일: 다운로드
										const downloadUrl = `/bidPblanc/download?fileGroupSn=\${fileGroupSn}&fileNo=\${fileNo}`;
										window.location.href = downloadUrl;
									}
								});
							});
							//재상신버튼
							document.querySelector("#postReElctrnsanctn").addEventListener("click", function () {
								const elctrnsanctnSn = document.querySelector("#elctrnsanctnSn").value;
								location.href = "/elctrnsanctn/postReElctrnsanctn?elctrnsanctnSn=" + elctrnsanctnSn;
							});
						});
					</script>
				</head>

				<body>
					<%@ include file="../include/header.jsp" %>
						<!--/// body /// -->
						<div class="card card-primary">
							<div class="card-header">
								<h3 class="card-title">기안서 상세</h3>
								<div class="card-tools">
									<div class="input-group input-group-sm">
										<button type="button" class="bg-warning btn btn-sm" id="previewBtn">
											미리보기
										</button>
									</div>
								</div>
							</div>

							<form id="drftForm" method="post" enctype="multipart/form-data">
								<div class="card-body">
									<div class="card card-info">
										<div class="card-header">
											<h3 class="card-title" id="drftDocTitle">
												${elctrnsanctnVO.drftDocVO.elctrnsanctnManageVO.sanctnSecode}
												<span class="ml-2 mr-2 fs-4">|</span>
												${elctrnsanctnVO.drftDocVO.drftDocNm}
											</h3>
											<div class="card-tools">
												<c:choose>
													<c:when test="${elctrnsanctnVO.drftTmprstre==0}">
														<div>
															<c:choose>
																<c:when test="${elctrnsanctnVO.totSanctnStts=='대기'}">
																	<span class="badge badge-lg badge-secondary p-1"
																		style="font-size: 1rem;">${elctrnsanctnVO.totSanctnStts}</span>
																</c:when>
																<c:when test="${elctrnsanctnVO.totSanctnStts=='반려'}">
																	<span class="badge badge-lg badge-danger p-1"
																		style="font-size: 1rem;">${elctrnsanctnVO.totSanctnStts}</span>
																</c:when>
																<c:when test="${elctrnsanctnVO.totSanctnStts=='결재완료'}">
																	<span class="badge badge-lg badge-success p-1"
																		style="font-size: 1rem;">${elctrnsanctnVO.totSanctnStts}</span>
																</c:when>
																<c:otherwise>
																	<span class="badge badge-lg badge-light p-1"
																		style="font-size: 1rem;">${elctrnsanctnVO.totSanctnStts}</span>
																</c:otherwise>
															</c:choose>
															<span class="mr-2 ml-2 fs-4">|</span>
															<span class="badge badge-lg bg-light p-1"
																style="font-size: 0.9rem;">
																${elctrnsanctnVO.drftTmprstreStts}</span>
														</div>
													</c:when>
													<c:otherwise>
														<span class="badge badge-lg bg-warning p-1 mr-2"
															style="font-size: 0.9rem;">
															${elctrnsanctnVO.drftTmprstreStts}
														</span>
													</c:otherwise>
												</c:choose>
											</div>
										</div>

										<div class="card-body">
											<table class="table table-bordered table-sm">
												<tbody>
													<tr>
														<th class="text-center align-middle col-2 bg-light">제목</th>
														<td colspan="3">
															<span class="ml-2">
																${elctrnsanctnVO.drftSj}
															</span>
															<input type="hidden"
																value="${elctrnsanctnVO.elctrnsanctnSn}"
																id="elctrnsanctnSn" />
														</td>
													</tr>

													<tr>
														<th class="text-center align-middle col-2 bg-light">기안자</th>
														<td class="col-4 align-middle">
															<span class="ml-2">
																${elctrnsanctnVO.empVO.nm}
																${elctrnsanctnVO.empVO.clsfName}
															</span>
															<input type="hidden" name="empId" value="${empVO.empId}" />
														</td>
														<th class="text-center align-middle col-2 bg-light">생성일자</th>
														<td class="col-4">
															<span class="ml-2">
																<fmt:formatDate value='${elctrnsanctnVO.creatDt}'
																	pattern='yyyy-MM-dd' />
															</span>
															<c:if test="${not empty elctrnsanctnVO.drftDt}">
																<input type="hidden" id="drftDt"
																	value="<fmt:formatDate value='${elctrnsanctnVO.drftDt}' pattern='yyyy-MM-dd'/>" />
															</c:if>
														</td>
													</tr>

													<tr>
														<th colspan="4" class="bg-light">
															<div class="d-flex align-items-center">
																<span class="flex-grow-1 text-center">결재선</span>
															</div>
														</th>
													</tr>

													<tr>
														<td class="p-1" colspan="4" id="sanctnlnTd">
															<table
																class="table table-sm table-bordered sanctnln-table m-0">
																<thead>
																	<tr class="bg-lightblue disabled text-center">
																		<th class="col-1">순번</th>
																		<th class="col-2">직급</th>
																		<th class="col-3">성명</th>
																		<th class="col-2">부서</th>
																		<th class="col-2">결재상태</th>
																		<th class=>서명</th>
																	</tr>
																</thead>
																<tbody id="sanctnTableBody">
																	<c:forEach var="sanctnlnVO"
																		items="${elctrnsanctnVO.sanctnlnVOList}">
																		<tr class="text-center">
																			<td class="align-middle">
																				${sanctnlnVO.sanctnOrdr}</td>
																			<td class="align-middle">
																				${sanctnlnVO.empVO.clsfName}</td>
																			<td class="align-middle">
																				${sanctnlnVO.empVO.nm}</td>
																			<td class="align-middle">
																				${sanctnlnVO.empVO.deptVO.deptNm}</td>
																			<td class="align-middle">
																				<c:choose>
																					<c:when
																						test="${sanctnlnVO.sanctnSttus==1}">
																						<span style="color: blue;
																							font-weight: bold;">${sanctnlnVO.sanctnSttusAsSTr}</span>
																					</c:when>
																					<c:when
																						test="${sanctnlnVO.sanctnSttus==2}">
																						<span style="color: red;
																							font-weight: bold;">${sanctnlnVO.sanctnSttusAsSTr}</span>
																					</c:when>
																					<c:otherwise>
																						<span>${sanctnlnVO.sanctnSttusAsSTr}</span>
																					</c:otherwise>
																				</c:choose>
																			</td>
																			<td class="align-middle">
																				<c:if
																					test="${sanctnlnVO.sanctnSttus==1}">
																					<img class="img-fluid w-75"
																						src="/upload${sanctnlnVO.empVO.signVO.fileDetailVO.fileStrelc}">
																				</c:if>
																			</td>
																		</tr>
																	</c:forEach>
																</tbody>
																<tfoot>
																	<tr>
																		<th class="bg-light text-center">참조</th>
																		<td id="referenceTableFoot" colspan="5">
																			<c:forEach var="drftRefrnVO"
																				items="${elctrnsanctnVO.drftRefrnVOList}">
																				<span
																					class="badge badge-lg bg-light ml-2"
																					style="font-size: 0.9rem;">${drftRefrnVO.empVO.nm}
																					${drftRefrnVO.empVO.clsfName}</span>
																			</c:forEach>
																		</td>
																	</tr>
																	<c:if test="${elctrnsanctnVO.totSanctnStts=='반려'}">
																		<c:forEach var="sanctnlnVO"
																			items="${elctrnsanctnVO.sanctnlnVOList}">
																			<c:if test="${sanctnlnVO.sanctnSttus==2}">
																				<tr>
																					<th colspan="2"
																						class="bg-danger disabled align-middle text-center">
																						반려사유
																					</th>
																					<td colspan="4">
																						<textarea
																							class="form-control form-control-border mb-0"
																							style="resize: vertical;"
																							rows="2"
																							disabled>${sanctnlnVO.returnPrvonsh}</textarea>
																					</td>
																				</tr>
																			</c:if>
																		</c:forEach>
																	</c:if>
																</tfoot>
															</table>
														</td>
													</tr>
													<tr>
														<th class="text-center align-middle col-2 bg-light">첨부파일</th>
														<td colspan="3" class="p-1 align-middle">
															<c:choose>
																<c:when test="${empty fileDetailVOList}">
																	<div
																		class="d-flex justify-content-center align-items-center">
																		<p class="text-muted mb-0">첨부파일이 없습니다.</p>
																	</div>
																</c:when>
																<c:otherwise>
																	<!-- 파일 목록 -->
																	<div class="list-group">
																		<c:forEach var="file"
																			items="${fileDetailVOList}">
																			<a class="list-group-item list-group-item-action d-flex align-items-center"
																				data-file-group-sn="${file.fileGroupSn}"
																				data-file-no="${file.fileNo}"
																				style="cursor: pointer;">
																				<i class="fa fa-file mr-2"></i>
																				<span>${file.fileOrginlNm}</span>
																			</a>
																		</c:forEach>
																	</div>
																</c:otherwise>
															</c:choose>
														</td>
													</tr>
												</tbody>
											</table>
										</div>

									</div>
									<div>
										<!-- drftCn -->
										<textarea class="form-control cntrPost" name="drftCn" id="drftCn">
											${elctrnsanctnVO.drftCn}
										</textarea>
									</div>
								</div>
								<div class="card-footer d-flex">
									<a class="btn btn-warning btn-sm mr-1"
										href="/elctrnsanctn/getElctrnsanctnSentList">목록</a>
									<c:if test="${elctrnsanctnVO.drftTmprstre>0}">
										<div class="ml-auto">
											<button type="button" id="putElctrnsanctnFromTemp"
												class="btn btn-success btn-sm mr-1">수정</button>
											<button type="button" id="postElctrnsanctnFromTemp"
												class="btn btn-primary btn-sm">상신</button>
										</div>
									</c:if>
									<c:if test="${elctrnsanctnVO.totSanctnStts=='반려'}">
										<div class="ml-auto">
											<button type="button" id="postReElctrnsanctn"
												class="btn btn-info btn-sm">재상신</button>
										</div>
									</c:if>
								</div>
							</form>
						</div>
						<!-- /// body /// -->
						<%@ include file="../include/footer.jsp" %>

							<!-- pdv 다운로드 방식 필요 테이블 모양 -->
							<!-- <tr>
							<th rowspan="4">결재</th>
							<th>기안자</th>
							<c:forEach var="sanctnlnVO" items="${elctrnsanctnVO.sanctnlnVOList}">
								<td>결재자</td>
							</c:forEach>
						</tr>
						<tr>
							<td>
								${empVO.deptVO.deptNm}
							</td>						
							<c:forEach var="sanctnlnVO" items="${elctrnsanctnVO.sanctnlnVOList}">
								<td>${sanctnlnVO.empVO.deptVO.deptNm}</td>
							</c:forEach>
						</tr>
						<tr>
							<td>
								${empVO.nm} ${empVO.clsfName}
							</td>						
							<c:forEach var="sanctnlnVO" items="${elctrnsanctnVO.sanctnlnVOList}">
								<td>${sanctnlnVO.empVO.nm} ${sanctnlnVO.empVO.clsfName}</td>
							</c:forEach>
						</tr>						
						<tr>
							<td>
								상신								
							</td>
							<c:forEach var="sanctnlnVO" items="${elctrnsanctnVO.sanctnlnVOList}">
								<c:if test="${sanctnlnVO.sanctnSttusAsSTr=='반려'}">
									<td>
										<span style="color: red;">${sanctnlnVO.sanctnSttusAsSTr}</span>
									</td>
								</c:if>
								<c:if test="${sanctnlnVO.sanctnSttusAsSTr=='승인'}">
									<td>
										<img class="img-fluid w-75"
											src="/upload${sanctnlnVO.empVO.signVO.fileDetailVO.fileStrelc}">
									</td>
								</c:if>
							</c:forEach>
						</tr> -->
				</body>

				</html>