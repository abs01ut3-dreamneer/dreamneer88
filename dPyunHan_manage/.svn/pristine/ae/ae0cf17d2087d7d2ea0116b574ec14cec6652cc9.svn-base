<%@ page language="java" contentType="text/html; charset=UTF-8" %>
	<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
		<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
			<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
				<!DOCTYPE html>
				<html>

				<head>

					<title>입찰하기</title>
				</head>
				<style>
					/* 드래그앤드랍 스타일 */
					#fileList {
						height: 250px;
						border: 2px dashed #dee2e6;
						border-radius: 0.25rem;
						background-color: #f8f9fa;
						overflow-y: auto;
						padding: 15px;
						margin-bottom: 15px;
					}

					.file-item {
						display: flex;
						align-items: center;
						gap: 10px;
						background-color: white;
						border: 1px solid #dee2e6;
						border-radius: 0.25rem;
						padding: 10px;
						margin-bottom: 10px;
					}

					.file-info {
						flex: 1;
						min-width: 0;
					}

					.file-name {
						font-size: 14px;
						font-weight: 500;
						white-space: nowrap;
						overflow: hidden;
						text-overflow: ellipsis;
					}

					.btn-remove {
						padding: 15;
						color: red;
						cursor: pointer;
						border: none;
						background: none;
						font-size: 20px;
					}

					.btn-remove:hover {
						color: red;
						font-weight: bolder;
					}
				</style>
				<script>
					document.addEventListener("DOMContentLoaded", function () {

						//파일 업로드 및 드래그/드롭
						let uploadedFiles = [];
						const fileList = document.querySelector("#fileList");
						const fileUpload = document.querySelector("#fileUpload");

						function fover(event) {
							event.preventDefault();
							fileList.classList.add("bg-light");
						}

						function fleave(event) {
							event.preventDefault();
							fileList.classList.remove("bg-light");
						}

						function fdrop(event) {
							event.preventDefault();
							fileList.classList.remove("bg-light");

							const dataFiles = Array.from(event.dataTransfer.files);
							dataFiles.forEach(file => readOneFile(file));
						}

						function readOneFile(pFile) {
							if (uploadedFiles.some(f => f.name === pFile.name && f.size === pFile.size)) {
								alert("이미 추가된 파일입니다");
								return;
							}
							pFile.fileId = Date.now() + Math.random();
							uploadedFiles.push(pFile);
							displayFileItem(pFile);
						}

						function displayFileItem(file) {
							const fileItem = document.createElement("div");
							fileItem.className = "file-item";
							fileItem.dataset.fileId = file.fileId;
							fileItem.innerHTML = `
                <div class="file-info">
                    <div class="file-name" title="\${file.name}">\${file.name}</div>
                </div>
                <button type="button" class="btn-remove" onclick="removeFileItem(this)">×</button>
            `;
							fileList.appendChild(fileItem);
						}

						window.removeFileItem = function (btn) {
							const fileItem = btn.closest(".file-item");
							const fileId = fileItem.dataset.fileId;

							uploadedFiles = uploadedFiles.filter(f => f.fileId != fileId);

							fileItem.remove();
						};
						fileUpload.addEventListener("change", function (e) {
							Array.from(e.target.files).forEach(file => readOneFile(file));
						});

						window.fover = fover;
						window.fleave = fleave;
						window.fdrop = fdrop;
						// 파일 업로드 드래그&드랍 끝

						// 입찰금 change 이벤트
						const smallUnits = ["", "십", "백", "천"];
						const bigUnits = ["", "만", "억", "조"];

						function numberToKorean(amount) {
							const numbers = ["", "일", "이", "삼", "사", "오", "육", "칠", "팔", "구"];

							let result = "";
							const strAmount = amount.toString();
							const len = strAmount.length;

							for (let i = 0; i < len; i++) {
								const num = parseInt(strAmount.charAt(i));
								const position = len - i - 1; // 자리수
								const smallUnitPos = position % 4;
								const bigUnitPos = Math.floor(position / 4);

								if (num !== 0) {
									if (!(num === 1 && smallUnitPos > 0)) {
										result += numbers[num];
									}
									result += smallUnits[smallUnitPos];
								}

								if (smallUnitPos === 0 && bigUnitPos > 0) {
									result += bigUnits[bigUnitPos];
								}
							}

							return "금 " + result + "원";
						}

						//입찰금 한글 표시
						document.querySelector("#bidAmount").addEventListener("input", function () {
							const amount = parseInt(this.value);
							let displayBidAmountKrw = "";

							if (!isNaN(amount) && amount > 0) {
								displayBidAmountKrw = numberToKorean(amount);
							} else {
								displayBidAmountKrw = "0원"; // 또는 공백 ""
							}
							document.querySelector("#bidAmountKrw").innerText = displayBidAmountKrw;
						})

						// 보증금 표시
						document.querySelector("#bidAmount").addEventListener("change", function () {
							const amount = parseInt(this.value);

							let bidGtnRt = "${bidPblancVO.bidGtnRt}";
							let bidGtnValue = Math.floor(amount * bidGtnRt / 100);
							document.querySelector("#bidGtn").value = bidGtnValue;

							let displayBidGtnKrw = numberToKorean(bidGtnValue);
							document.querySelector("#bidGtnKrw").value = displayBidGtnKrw
						})

						//form submit
						document.querySelector("#bdderForm").addEventListener("submit", function (e) {
							e.preventDefault();

							const formData = new FormData();
							document.querySelectorAll(".bdderVO").forEach(elem => {
								let name = elem.getAttribute("name");
								let value = elem.value;

								// 빈 값은 제외
								if (value !== "" && value !== null && value !== undefined) {
									formData.append(name, value);
									console.log("check : name, value => " + name + ", " + value);
								}
							})

							uploadedFiles.forEach(file => {
								formData.append("uploadFiles", file);
							});
							// action="/bidPblanc/postBidPblanc" method="post"
							fetch("/bdder/postBdder", {
								method: "POST",
								body: formData
							})
								.then(response => {
									if (response.ok) {
										window.location.href = "/bdder/loginBdder";
										console.log("성공")
									} else {
										console.log("서버 오류")
									}
								})
								.catch(error => console.log("check : error => ", error));
						});
					});					
				</script>

				<body>
					<%@ include file="../include/header.jsp" %>

						<div class="jumbotron">
							<div class="container">
								<h1 class="display-3">입찰을 해보장</h1>
							</div>
						</div>
						<!--/// body /// -->
						<form id="bdderForm">
							<div class="card card-primary">
								<div class="card-header">
									<h3 class="card-title">입찰서</h3>
								</div>
								<!-- /.card-header -->
								<div class="card-body">
									<div class="form-group">
										<label for="bidSj">입찰명칭</label>
										<!-- 입찰명칭 표시 -->
										<p>${bidPblancVO.bidSj}</p>
										<input type="hidden" class="bdderVO" id="bidPblancSn" name="bidPblancSn"
											value="${bidPblancVO.bidPblancSn}">
									</div>
									<div class="form-group">
										<label for="bidAmount">입찰가액</label>
										<input type="number"
											class="form-control form-control-border border-width-2 bdderVO"
											id="bidAmount" name="bidAmount" placeholder="금액 입력(원)">
										<p id="bidAmountKrw"></p>
									</div>
									<div class="form-group">
										<label for="bidGtn">입찰보증금</label>
										<input type="text" class="form-control form-control-border border-width-2"
											id="bidGtnKrw" name="bidGtnKrw" readonly>
										<input type="hidden" class="bdderVO" name="bidGtn" id="bidGtn" readonly>
									</div>
									<div class="form-group">
										위와 같이 입찰보증금(입찰가격의 100분의 <!-- 입찰 보증금 율 표시-->${bidPblancVO.bidGtnRt} 이상)을 첨부하여
										입찰합니다.
										<!-- 2025 년     월     일 (입찰당일 날짜 표시) -->
										<h3>
											<fmt:formatDate value="${now}" pattern="yyyy년 MM월 dd일" />
										</h3>
									</div>
								</div>
							</div>
							<!-- /.card-header -->
							<div class="card card-primary">
								<div class="card-header">
									<h3 class="card-title">입찰자</h3>
								</div>
								<!-- /.card-body -->
								<div class="card-body">
									<div class="form-group">
										<label for="exampleInputtext1">상호 (성명)</label>
										<input type="text" class="form-control bdderVO" name="bdderCmpnyNm"
											id="bdderCmpnyNm" placeholder="회사 (명)">
									</div>
									<div class="form-group">
										<label for="exampleInputtext1">대표자</label>
										<input type="text" class="form-control bdderVO" name="bdderNm" id="bdderNm"
											placeholder="대표자 (명)">
									</div>
									<div class="form-group">
										<label for="exampleInputtext1">사업자 등록 번호</label>
										<input type="text" class="form-control bdderVO" name="bdderBizrno"
											id="bdderBizrno" placeholder="사업자 등록 번호 10자리 표기 (000-000-0000)">
									</div>
									<div class="form-group">
										<label for="exampleInputtext1">사업장 주소</label>
										<input type="text" class="form-control bdderVO" name="bdderAdres"
											id="bdderAdres" placeholder="">
									</div>
									<div class="form-group">
										<label for="exampleInputtext1">전화번호</label>
										<input type="text" class="form-control bdderVO" name="bdderTelno"
											id="bdderTelno"
											placeholder="연락처 11자리 또는 10자리 표기 (000-0000-0000 또는 000-000-0000)">
									</div>
									<div class="form-group">
										<label for="exampleInputtext1">Email 주소</label>
										<input type="email" class="form-control bdderVO" name="bdderEmail"
											id="bdderEmail" placeholder="입찰 내역 확인 시 필요">
									</div>
									<div class="form-group">
										<label for="exampleInputPassword1">비밀번호</label>
										<input type="password" class="form-control bdderVO" name="bdderPassword"
											id="bdderPassword" placeholder="입찰 내역 확인 시 필요">
									</div>
									<div class="form-group">
										<label for="fileUpload"> <i class="fas fa-file-upload"></i>
											파일 첨부
										</label>
										<div id="fileList" ondragover="fover(event)" ondragleave="fleave(event)"
											ondrop="fdrop(event)" style="cursor: pointer;" title="파일을 여기에 드래그하세요"></div>
										<div class="custom-file">
											<input type="file" class="custom-file-input" id="fileUpload"
												name="uploadFiles" multiple> <label class="custom-file-label"
												for="fileUpload">파일 선택</label>
										</div>
									</div>
								</div>
								<!-- /.card-body -->

								<div class="card-footer">
									<span>D-편한아파트 관리사무소장 귀중</span>
									<button type="submit" class="btn btn-primary">Submit</button>
								</div>
							</div>
						</form>
						<!-- /// body /// -->
						<%@ include file="../include/footer.jsp" %>
				</body>

				</html>