package kr.or.ddit.controller;

import java.io.IOException;
import java.net.URLEncoder;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.io.FileSystemResource;
import org.springframework.core.io.Resource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import jakarta.servlet.http.HttpServletRequest;
import kr.or.ddit.service.BidPblancService;
import kr.or.ddit.util.ArticlePage;
import kr.or.ddit.util.UploadController;
import kr.or.ddit.vo.BidPblancVO;
import kr.or.ddit.vo.FileDetailVO;
import lombok.extern.slf4j.Slf4j;

@Controller
@RequestMapping("/bidPblanc")
@Slf4j
public class BidPblancController {

	@Autowired
	UploadController uploadController;
	
	@Autowired
	BidPblancService bidPblancService;


	@GetMapping("/getBidPblancList")
	public String getBidPblancList(
			Model model,
			@RequestParam(required = false, defaultValue = "") String keyword,
			@RequestParam(required = false, defaultValue = "1") int currentPage 
			) {
		int size = 10;
		
		Map<String, Object> map = new HashMap<>();
		map.put("currentPage", currentPage);
		map.put("keyword", keyword);
		
		int total = this.bidPblancService.getTotal(map);
		
		List<BidPblancVO> bidPblancVOList = this.bidPblancService.getBidPblancList(map);
		
		ArticlePage<BidPblancVO> articlePage = new ArticlePage<BidPblancVO>(total, currentPage, size, bidPblancVOList, keyword);
		
		model.addAttribute("articlePage", articlePage);
		
		return "bidPblanc/getBidPblancList";
	}

	@GetMapping("/postBidPblanc")
	public String postBidPblanc() {

		return ("bidPblanc/postBidPblanc");
	}

	@PostMapping("/postBidPblanc")
	public Map<String, Object> postBidPblanc(
			BidPblancVO bidPblancVO,
			// formData로 보내기때문에 RequestBody 불필요
			@RequestParam("uploadFiles") MultipartFile[] uploadFiles
			) {
		log.info("check : postBidPblanc/bidPblancVO => {}", bidPblancVO);
		
		long fileGroupSn = this.uploadController.multiImageUpload(uploadFiles);
		bidPblancVO.setFileGroupSn(fileGroupSn);
		
		int result = this.bidPblancService.postBidPblanc(bidPblancVO);
		
		Map<String, Object> map = new HashMap<>();
		return map;
	}
	
	// post : /bidPblanc/getFileDetailVOList
	@ResponseBody
	@PostMapping("/getFileDetailVOList")
	public Map<String, Object> getFileDetailVOList(
			@RequestBody BidPblancVO bidPblancVO
			//@RequestBody : 클라이언트가 HTTP 바디에 JSON 등 객체 직렬화(stringify)된 데이터를 보낼 때 사용합니다.
			){
		log.info("check : bidPblancVO => {}", bidPblancVO);
		
		bidPblancVO = this.bidPblancService.getBidPblancVO(bidPblancVO);
		
		Long fileGroupSn = bidPblancVO.getFileGroupSn();
		
		log.info("check : fileGroupSn => {}", fileGroupSn);
		List<FileDetailVO> fileDetailVOList = this.uploadController.getFileDetailVOList(fileGroupSn);
		
		Map<String, Object> map = new HashMap<>();
		
		map.put("result", 1);
		map.put("fileDetailVOList", fileDetailVOList);
		return map;
	}
	
	// 다운로드!!!
	@GetMapping("/download")
	public ResponseEntity<Resource> downloadFile(
	    @RequestParam("fileGroupSn") long fileGroupSn,
	    @RequestParam("fileNo") int fileNo,
	    HttpServletRequest request
	) throws IOException {
	    log.info("파일 다운로드: fileGroupSn={}, fileNo={}", fileGroupSn, fileNo);
	    
	    // DB에서 파일 정보 조회
	    FileDetailVO fileDetailVO = this.uploadController.getFileDetail(fileGroupSn, fileNo);
	    
	    if (fileDetailVO == null) {
	        throw new IllegalArgumentException("파일을 찾을 수 없습니다.");
	    }
	    
	    // 저장된 파일 경로
	    Path filePath = Paths.get(fileDetailVO.getFileAbsltStrelc());
	    log.info("check : filePath => {}", filePath);
	    Resource resource = new FileSystemResource(filePath);
	    
	    if (!resource.exists()) {
	        throw new IllegalArgumentException("파일이 존재하지 않습니다.");
	    }
	    
	    // 원본 파일명 (브라우저에서 보여줄 이름)
	    String originalFileName = fileDetailVO.getFileOrginlNm();
	    
	    // 한글 파일명 인코딩
	    String encodedFileName = URLEncoder.encode(originalFileName, "UTF-8").replaceAll("\\+", "%20");
	    
	    return ResponseEntity.ok()
	        .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename*=UTF-8''" + encodedFileName)
	        .header(HttpHeaders.CONTENT_TYPE, fileDetailVO.getFileMime())
	        .body(resource);
	}
}
