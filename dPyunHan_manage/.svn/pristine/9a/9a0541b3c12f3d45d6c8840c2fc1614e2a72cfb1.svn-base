<%@ page language="java" contentType="text/html; charset=UTF-8" %>
  <%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
    <%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
      <%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
        <!DOCTYPE html>
        <html>

        <head>

          <title></title>
        </head>

        <script type="text/javascript">
          document.addEventListener("DOMContentLoaded", function () {

            document.querySelectorAll("tr[data-widget='expandable-table']").forEach(row => {
              row.addEventListener("click", function (e) {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                let bidPblancSn = "";
                if (!isExpanded) {
                  bidPblancSn = this.querySelector("#bidPblancSn").value;
                  console.log("check : bidPblancSn => ", bidPblancSn);
                }

                const data = {
                  "bidPblancSn": bidPblancSn
                }

                fetch("/bidPblanc/getFileDetailVOList", {
                  method: "POST",
                  headers: {
                    "Content-type": "application/json;charset=UTF-8"
                  },
                  body: JSON.stringify(data)
                })
                  .then(resp => {
                    return resp.json();
                  })
                  .then(data => {
                    console.log("check : data.fileDetailVOList => ", data.fileDetailVOList);

                    if (data.fileDetailVOList) {
                      displayFileList(this, data.fileDetailVOList);
                    }
                  })
                  .catch(error => {
                    console.log("check : error => ", error);
                  })
              }); //addEventListner => click 
            }) // forEach

            const displayFileList = (elem, fileDetailVOList) => {
              const expandableBody = elem.nextElementSibling;
              const listGroupDiv = expandableBody.querySelector(".list-group");

              if (!fileDetailVOList || fileDetailVOList.length === 0) {
                listGroupDiv.innerHTML = '<p class="text-muted">첨부파일이 없습니다.</p>';
                return;
              }

              let str = '';
              fileDetailVOList.forEach(file => {
                str += `
                  <a href="/bidPblanc/download?fileGroupSn=\${file.fileGroupSn}&fileNo=\${file.fileNo}" 
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    target="_blank">
                      <div>
                          <i class="fa fa-file"></i>
                          <strong>\${file.fileOrginlNm}</strong>
                      </div>
                  </a>
                `;
              }) // end forEach
              listGroupDiv.innerHTML = str;
            }
            //입찰하기
            document.querySelectorAll(".postBdder").forEach(btn => {
              btn.addEventListener("click", function () {
                const bidPblancSn = this.getAttribute("data-bidPblancSn");
                location.href = "/bdder/postBdder?bidPblancSn=" + bidPblancSn;
              })
            })
          });
        </script>

        <body>
          <%@ include file="../include/header.jsp" %>

            <div class="jumbotron">
              <div class="container">
                <h1 class="display-3">입찰 공고 게시판</h1>
                <!-- 
                 document.querySelector("#postBidPblanc").addEventListener("click", function () {
              location.href = "/bidPblanc/postBidPblanc";
            });
                -->
                <button type="button" onclick="location.href='/bdder/loginBdder'">내가 한 입찰 내역보기</button>
                <button type="button" onclick="location.href='/bidPblanc/postBidPblanc'">입찰 공고하기</button>

              </div>
            </div>
            <!--/// body /// -->
            <div class="card-body">
              <table class="table table-bordered table-hover">
                <thead>
                  <tr>
                    <th>순번</th>
                    <th>입찰 상태</th>
                    <th>입찰 제목</th>
                    <th>낙찰 방법</th>
                    <th>공고 일시</th>
                  </tr>
                </thead>
                <tbody>
                  <c:forEach var="bidPblancVO" items="${articlePage.content}">
                    <tr data-widget="expandable-table" aria-expanded="false">
                      <td>${bidPblancVO.rnum}<input type="hidden" name="bidPblancSn" id="bidPblancSn"
                          value="${bidPblancVO.bidPblancSn}">
                      </td>
                      <td>${bidPblancVO.bidSttusAsStr}</td>
                      <td>${bidPblancVO.bidSj}</td>
                      <td>${bidPblancVO.scsbMthAsStr}</td>
                      <td>
                        <fmt:formatDate value="${bidPblancVO.pblancDt}" pattern="yyyy-MM-dd HH:MM" />
                      </td>
                    </tr>
                    <tr class="expandable-body d-none">
                      <td colspan="5">
                        <div class="card card-primary">
                          <!-- /.card-body -->
                          <h4>입찰공고 상세</h4>
                          <table class="table table-bordered">
                            <tr>
                              <th>신용평가 제출 여부</th>
                              <td>${bidPblancVO.cdltPresentnAtAsStr}</td>
                              <th>관리 실적증명서 제출 여부</th>
                              <td>${bidPblancVO.acmsltproofPresentnAtAsStr}</td>
                            </tr>
                            <tr>
                              <th>현장 설명 여부</th>
                              <td>${bidPblancVO.sptdcAtAsStr}</td>
                              <th>입찰 마감일</th>
                              <td>
                                <fmt:formatDate value="${bidPblancVO.bidClosDtAsDate}" pattern="yyyy-MM-dd HH:MM" />
                              </td>
                            </tr>
                            <tr>
                              <th>현장설명 일시</th>
                              <td>
                                <fmt:formatDate value="${bidPblancVO.sptdcDtAsDate}" pattern="yyyy-MM-dd HH:MM" />
                              </td>
                              <th>현장설명 장소</th>
                              <td>${bidPblancVO.sptdcPlace}</td>
                            </tr>
                            <tr>
                              <th>입찰 보증금 %</th>
                              <td colspan="3">${bidPblancVO.bidGtnRt}%</td>
                            </tr>
                            <tr>
                              <th>내용</th>
                              <td colspan="3">${bidPblancVO.bidCn}</td>
                            </tr>
                            <tr>
                              <th>첨부 파일</th>
                              <td colspan="3">
                                <!-- 첨부 파일 자리 -->
                                <div class="list-group"></div>
                              </td>
                            </tr>
                            <tr>
                              <td colspan="4">
                                <button class="postBdder" data-bidPblancSn="${bidPblancVO.bidPblancSn}">입찰 하기</button>
                              </td>
                            </tr>
                          </table>
                          <!-- /.card-body -->
                        </div>
                      </td>
                    </tr>
                  </c:forEach>
                </tbody>
              </table>
            </div>
            <div>${articlePage.pagingArea}</div>
            <!-- /// body /// -->
            <%@ include file="../include/footer.jsp" %>
        </body>

        </html>