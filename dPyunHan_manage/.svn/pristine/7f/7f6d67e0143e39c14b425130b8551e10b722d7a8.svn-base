<%@ page language="java" contentType="text/html; charset=UTF-8" %>
	<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
		<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
			<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
				<!DOCTYPE html>
				<html>

				<head>

					<title></title>
				</head>

				<script type="text/javascript">
					document.addEventListener("DOMContentLoaded", function () {
						document.querySelector("#uploadFile").addEventListener("change", function () {
							const fileInput = document.querySelector('#uploadFile');

							

							const formData = new FormData();
							formData.append('uploadFiles', fileInput.files[0]);

							fetch('/ccpyManage/postBizLicense', {
								method: 'POST',
								body: formData
							})
								.then(response => {
									if (response.ok) {
										console.log("check : postBizLicense => 성공");
									}
									return response.json()
								})
								.then(data => {
									console.log("check : data.ccpyManageVO =>", data.ccpyManageVO);
									document.getElementById('ccpyCmpnyNm').value = data.ccpyManageVO.ccpyCmpnyNm || '';
									document.getElementById('ccpyBizrno').value = data.ccpyManageVO.ccpyBizrno || '';
									document.getElementById('ccpyRprsntvNm').value = data.ccpyManageVO.ccpyRprsntvNm || '';
									document.getElementById('ccpyAdres').value = data.ccpyManageVO.ccpyAdres || '';
									document.getElementById('ccpyTelno').value = data.ccpyManageVO.ccpyTelno || '';

									// 개업연월일 처리 (날짜 형식)
									if (data.ccpyManageVO.ccpyOpbizDe) {
										
										const date = new Date(data.ccpyManageVO.ccpyOpbizDe);
										console.log("check : date => ", date);
										document.getElementById('ccpyOpbizDe').value =
											date.toISOString().split('T')[0];
									}
									console.log("check : data.ccpyManageVO.bizcndIndutyVOList => ", data.ccpyManageVO.bizcndIndutyVOList);
									// 업태/업종 처리 (배열)
									if (data.ccpyManageVO.bizcndIndutyVOList &&
										data.ccpyManageVO.bizcndIndutyVOList.length > 0) {
										createBizcndIndutyInputs(data.ccpyManageVO.bizcndIndutyVOList);
									}
								})
								.catch(error => {
									console.log("error => ", error);
								});
						});

						function createBizcndIndutyInputs(bizcndIndutyList) {
							const container = document.getElementById('bizcndIndutyContainer');
							container.innerHTML = '';  // 기존 내용 제거

							bizcndIndutyList.forEach((item, index) => {
								// 카드 div 생성
								const cardDiv = document.createElement('div');
								cardDiv.className = 'form-row mb-3';
								cardDiv.innerHTML = `
													<div class="col-md-6">
														<label>업태 ${index + 1}</label>
														<input type="text" 
															class="form-control" 
															name="bizcndIndutyVOList[\${index}].bizcndNm"
															value="\${item.bizcndNm || ''}">
													</div>
													<div class="col-md-6">
														<label>업종 \${index + 1}</label>
														<input type="text" 
															class="form-control" 
															name="bizcndIndutyVOList[\${index}].indutyNm"
															value="\${item.indutyNm || ''}">
													</div>
												`;

								container.appendChild(cardDiv);
							});
						}
					});
				</script>

				<body>
					<%@ include file="../include/header.jsp" %>

						<div class="card card-primary">
							<div class="card-header">
								<h3 class="card-title">업체 등록</h3>
							</div>
							<!-- /.card-header -->
							<!-- form start -->
							<form action="/ccpyManage/postCcpyManage" method="post" enctype="multipart/form-data">
								<div class="card-body">
									<div class="form-group">
										<label for="ccpyCmpnyNm">이메일주소</label>
										<input type="email" class="form-control" name="ccpyEmail" id="ccpyEmail"
											placeholder="로그인시 사용할 이메일 주소를 입력해주세요.">
									</div>
									<div class="form-group">
										<label for="ccpyCmpnyNm">비밀번호</label>
										<input type="password" class="form-control" name="ccpyPassword"
											id="ccpyPassword">
									</div>
									<div class="form-group">
										<label for="ccpyCmpnyNm">업체 명</label>
										<input type="text" class="form-control" name="ccpyCmpnyNm" id="ccpyCmpnyNm">
									</div>
									<div class="form-group">
										<label for="">사업자 등록 번호</label>
										<input type="text" class="form-control" name="ccpyBizrno" id="ccpyBizrno">
									</div>
									<div class="form-group">
										<label for="ccpyRprsntvNm">대표자 명</label>
										<input type="text" class="form-control" name="ccpyRprsntvNm" id="ccpyRprsntvNm">

									</div>
									<div class="form-group">
										<label for="">주소</label>
										<input type="text" class="form-control" name="ccpyAdres" id="ccpyAdres">
									</div>
									<div class="form-group">
										<label for="ccpyTelno">전화번호</label>
										<input type="text" class="form-control" name="ccpyTelno" id="ccpyTelno">
									</div>
									<div class="form-group">
										<label for="">개업연월일</label>
										<input type="date" class="form-control" name="ccpyOpbizDe" id="ccpyOpbizDe">
									</div>
									<div class="form-group">
										<label>업태/업종</label>
										<div id="bizcndIndutyContainer">
											
										</div>
								</div>
								<div class="ocr-section">
									<p>
										사업자등록증 사진을 업로드하면 자동으로 정보가 입력됩니다.
									</p>
									<div class="form-group">
										<label>사업자등록증 이미지</label>
										<label class="file-input-label">
											파일 선택
											<input type="file" id="uploadFile" name="uploadFile" accept="image/*"
												required>
										</label>
										<div class="file-name" id="fileName"></div>
									</div>
								</div>

						</div>
						<!-- /.card-body -->

						<div class="card-footer">
							<button type="submit" class="btn btn-primary">Submit</button>
						</div>
						</form>
						</div>

						<!-- /// body /// -->
						<%@ include file="../include/footer.jsp" %>
				</body>

				</html>