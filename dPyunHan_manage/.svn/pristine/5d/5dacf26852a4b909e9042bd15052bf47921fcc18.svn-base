<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mapper.MtinspMapper">

    <select id="findMetersByMonth" parameterType="java.lang.String" resultType="mtinspVO">
        SELECT
            HSHLD_ID,
            IEM_NM,
            SUM(USGQTY) AS TOTAL_USGQTY  -- 사용량을 합산
        FROM
            MTINSP
        WHERE
            TO_CHAR(MTINSP_DT, 'YYYYMM') = #{billingMonth}
        GROUP BY
            HSHLD_ID, IEM_NM
    </select>

    <select id="getUsageHistory" resultType="mtinspVO" parameterType="map">
        SELECT
        MTINSP_DT,
        IEM_NM,
        USGQTY,
        HSHLD_ID
        FROM
        MTINSP

        <where>
            <if test="hshldId != null and hshldId != ''">
                HSHLD_ID = #{hshldId}
            </if>
            <if test="searchMonth != null and searchMonth != ''">
                AND TO_CHAR(MTINSP_DT, 'YYYY-MM') = #{searchMonth}
            </if>
        </where>

        ORDER BY
        MTINSP_DT ASC, IEM_NM ASC
    </select>
   	
   	<!-- 2025/11/19 KWH 
   		이동평균표준편차 검침 이상 분석 -->
   		 
   <!-- 전체 검침 데이터 조회 (이상치 분석용) -->
    <select id="getAllReadings" resultType="mtinspVO">
        SELECT 
            MTINSP_SN
            , HSHLD_ID
            , IEM_NM
            , USGQTY
            , TO_CHAR(MTINSP_DT, 'YYYY/MM/DD') AS mtinspDt
        FROM MTINSP
        ORDER BY MTINSP_DT ASC
    </select>
    
    <!-- 특정 세대의 검침 데이터 조회 -->
    <select id="getReadingsByHousehold" resultType="mtinspVO">
        SELECT 
            MTINSP_SN
            , HSHLD_ID
            , IEM_NM
            , USGQTY
            , TO_CHAR(MTINSP_DT, 'YYYY/MM/DD') AS mtinspDt
        FROM MTINSP
        WHERE HSHLD_ID = #{hshldId}
        ORDER BY MTINSP_DT ASC
    </select>
    
    <!-- 특정 검침 종류의 데이터 조회 -->
    <select id="getReadingsByType" resultType="mtinspVO">
        SELECT 
            MTINSP_SN
            , HSHLD_ID
            , IEM_NM
            , USGQTY AS
            , TO_CHAR(MTINSP_DT, 'YYYY/MM/DD') AS mtinspDt
        FROM MTINSP
        WHERE IEM_NM = #{iemNm}
        ORDER BY MTINSP_DT ASC
    </select>
    
    <!-- 스케줄러용 조회 쿼리 -->
    
    <!-- 특정 날짜의 검침 데이터 조회 -->
    <select id="getReadingsByDate" resultType="mtinspVO">
        SELECT 
            MTINSP_SN
            , HSHLD_ID
            , IEM_NM
            , USGQTY
            , TO_CHAR(MTINSP_DT, 'YYYY/MM/DD') AS mtinspDt
        FROM MTINSP
        WHERE TRUNC(MTINSP_DT) = TO_DATE(#{date}, 'YYYY-MM-DD')
        ORDER BY MTINSP_DT ASC
    </select>
    
    <!-- 최근 N시간 이내의 검침 데이터 조회 -->
    <select id="getRecentReadings" resultType="mtinspVO">
        SELECT 
            MTINSP_SN
            , HSHLD_ID
            , IEM_NM 
            , USGQTY
            , TO_CHAR(MTINSP_DT, 'YYYY/MM/DD') AS mtinspDt
        FROM MTINSP
        WHERE MTINSP_DT >= SYSDATE - (#{hours} / 24)
        ORDER BY MTINSP_DT DESC
    </select>
    
    <!-- 기간별 검침 데이터 조회 -->
    <select id="getReadingsByDateRange" resultType="kr.or.ddit.vo.MtinspVO">
        SELECT 
            MTINSP_SN
            , HSHLD_ID
            , IEM_NM
            , USGQTY
            , TO_CHAR(MTINSP_DT, 'YYYY/MM/DD') AS mtinspDt
        FROM MTINSP
        WHERE TRUNC(MTINSP_DT) BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
                                   AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
        ORDER BY MTINSP_DT ASC
    </select>
</mapper>