package kr.or.ddit.controller;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

import org.json.simple.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import kr.or.ddit.service.CcpyManageService;
import kr.or.ddit.service.OcrService;
import kr.or.ddit.util.UploadController;
import kr.or.ddit.vo.CcpyManageVO;
import lombok.extern.slf4j.Slf4j;

@Controller
@Slf4j
@RequestMapping("/ccpyManage")
public class CcpyManageController {
	
	@Autowired
    private BCryptPasswordEncoder bCryptPasswordEncoder;
	
	@Autowired
	CcpyManageService ccpyManageController;
	
	@Autowired
	UploadController uploadController;
	
	@Autowired
    private OcrService ocrService;
    
	@GetMapping("/postCcpyManage")
	public String putCcpyManage() {
		
		return "ccpyManage/postCcpyManage";
	}
	
	@ResponseBody
	@PostMapping("/postBizLicense")
	public Map<String, Object> postBizLicense (
			@RequestParam("uploadFiles") MultipartFile uploadFile
			){
		CcpyManageVO ccpyManageVO = null;
	    String savedFilePath = null;
		
		Map<String, Object> map = new HashMap<>();
		
		try {
			savedFilePath = this.uploadController.uploadFile(uploadFile);
			JSONObject ocrResult = ocrService.processBizLicenseOcr(savedFilePath);
			ccpyManageVO = ocrService.extractCcpyManageVO(ocrResult);
		} catch (IOException e) {
			e.printStackTrace();
		} catch (Exception e) {
			e.printStackTrace();
		}
		
		map.put("ccpyManageVO", ccpyManageVO);
		
		return map;
	}
	
	@PostMapping("/postCcpyManage")
	public String postCcpyManage(
			CcpyManageVO ccpyManageVO,
			@RequestParam(value = "uploadFile", required = false) MultipartFile[] uploadFile
			) {
		long fileGroupSn = this.uploadController.multiImageUpload(uploadFile);
		ccpyManageVO.setFileGroupSn(fileGroupSn);
		
		String encodedPassword = bCryptPasswordEncoder.encode(ccpyManageVO.getCcpyPassword());
		ccpyManageVO.setCcpyPassword(encodedPassword);
		
		log.info("check : ccpyManageVO => {}", ccpyManageVO);
		int result = this.ccpyManageController.postCcpyManageVO(ccpyManageVO);
		
		return "redirect:ccpyManage/wait";
	}
}
