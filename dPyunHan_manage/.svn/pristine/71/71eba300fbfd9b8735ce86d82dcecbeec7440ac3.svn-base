<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mapper.CmmntyMapper">

<!-- 나혜선 추가 시작 -->
<resultMap id="empMap" type="EmpVO">
 <result property="empId" column="EMP_ID" />
 <result property="nm" column="NM" />
 <result property="deptCode" column="DEPT_CODE" />
</resultMap>
<!-- 나혜선 추가 끝 -->

<!-- 나혜선 시작 -->

<!-- DB에서 시설 리스트 조회 -->

<sql id="where2">
  <if test="keyword != null and keyword != ''">
    AND (
         CMMNTY_NM LIKE '%' || #{keyword} || '%'
      OR CMMNTY_CHCKSTTUS LIKE '%' || #{keyword} || '%'
    )
</if>
</sql>


<!-- db로부터 커뮤니티 리스트 목록 조회 -->
<select id="cmmntylist" resultType="CmmntyVO">
WITH T AS(
SELECT ROW_NUMBER() OVER(ORDER BY cmmnty_sn ASC) AS row_num,
    cmmnty_sn,
    cmmnty_nm,
    tot_aceptnc_nmpr,
    cmmnty_opn_vwpoint,
    cmmnty_clos_vwpoint,
    resve_mxmm_nmpr,
    resve_mxmm_time,
    cmmnty_chcksttus,
    cmmnty_chck_dt
FROM
    cmmnty
WHERE 1 = 1
<include refid="where2"></include>
)
SELECT T.cmmnty_sn, T.cmmnty_nm, T.cmmnty_chcksttus, T.cmmnty_chck_dt, T.cmmnty_opn_vwpoint, T.cmmnty_clos_vwpoint
FROM T
WHERE T.row_num BETWEEN ((#{currentPage}*10) - (10 - 1)) AND (#{currentPage} * 10)

</select>


<!-- 전체 행의 수 -->
<select id="getTotal2" resultType="int">
 SELECT COUNT(*)
   FROM CMMNTY
  WHERE 1 =1
  <include refid="where2"></include>
</select>

<!-- 모달 상태 변경 값 db 저장 -->
<update id="cmmntyupdatePost" parameterType="CmmntyVO">
UPDATE CMMNTY 
SET CMMNTY_CHCKSTTUS = #{cmmntyChcksttus},
    CMMNTY_CHCK_DT = #{cmmntyChckDt}
WHERE CMMNTY_SN = #{cmmntySn}
</update>

<!-- 모달 상태값 변경 전 db값 조회 -->
<select id="detail" resultType="CmmntyVO">
SELECT CMMNTY_SN, CMMNTY_NM, CMMNTY_CHCKSTTUS, CMMNTY_CHCK_DT
 FROM CMMNTY
WHERE CMMNTY_SN = #{cmmntySn}
</select>


<!-- 커뮤니티 리스트 행의 갯수 조회 -->
<select id="selectManageCount" parameterType="int" resultType="int">
SELECT COUNT(*)
FROM FCLTY_MANAGE
WHERE CMMNTY_SN = #{cmmntySn}
</select>

<!-- 커뮤니티 리스트 행 2개 이상 시 이전 행 점검완료 처리 -->
<update id="updateManage" parameterType="CmmntyVO">
UPDATE FCLTY_MANAGE A
SET A.FCLTYMANAGE_CHCKSTTUS = '점검완료'
WHERE A.FCLTY_MANAGE_SN IN (
  SELECT FCLTY_MANAGE_SN
  FROM FCLTY_MANAGE B
  WHERE B.CMMNTY_SN = #{cmmntySn}
  AND B.FCLTY_MANAGE_SN <![CDATA[<]]> (
      SELECT MAX(C.FCLTY_MANAGE_SN)
      FROM FCLTY_MANAGE C
      WHERE C.CMMNTY_SN = #{cmmntySn}
  )
)
</update>

<!-- 커뮤니티 리스트 행이 2개 이상 시 마지막 행 커뮤니티 상태 동기화 -->
<update id="updateManageRecent" parameterType="CmmntyVO">

UPDATE FCLTY_MANAGE A
SET A.FCLTYMANAGE_CHCKSTTUS = (
   SELECT C.CMMNTY_CHCKSTTUS
   FROM CMMNTY C
   WHERE C.CMMNTY_SN = A.CMMNTY_SN
   )
WHERE A.FCLTY_MANAGE_SN=(
  SELECT MAX(B.FCLTY_MANAGE_SN)
  FROM FCLTY_MANAGE B
  WHERE A.CMMNTY_SN = B.CMMNTY_SN
)
AND A.CMMNTY_SN = #{cmmntySn}
</update>

<!-- 커뮤니티 리스트 행의 갯수 2개 미만 시 -->

<update id="updateManage2" parameterType="CmmntyVO">
UPDATE FCLTY_MANAGE A
SET A.FCLTYMANAGE_CHCKSTTUS = (
    SELECT B.CMMNTY_CHCKSTTUS
    FROM CMMNTY B
    WHERE B.CMMNTY_SN = A.CMMNTY_SN
)
WHERE(
 SELECT COUNT(*)
 FROM FCLTY_MANAGE C
 WHERE C.CMMNTY_SN = A.CMMNTY_SN
) <![CDATA[<]]> 2
AND A.CMMNTY_SN = #{cmmntySn}
</update>

<!-- 나혜선 끝 -->

<!-- 나혜선 추가 시작-->

<select id="empList" resultMap="empMap">

SELECT
    emp_id,
    nm,
    dept_code
FROM
    emp
where dept_code=2 

</select>


<!-- 나혜선 추가 끝-->


</mapper>