<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mapper.BidPblancMapper">
	
	<sql id="where">
		<if test="keyword != null and keyword != ''">
    		and (BID_SJ like '%' || #{keyword} || '%')
    	</if>
	</sql>
	
	<insert id="postBidPblanc" parameterType="bidPblancVO">
		<selectKey resultType="int" order="BEFORE" keyProperty="bidPblancSn">
			SELECT NVL(MAX(BID_PBLANC_SN), 0)+1 FROM BID_PBLANC
		</selectKey>
		INSERT INTO BID_PBLANC (
			BID_PBLANC_SN,
			BID_SJ,
			SCSB_MTH,
			BID_CN,
			PBLANC_DT,
			BID_CLOS_DT,
			BID_STTUS,
			ELCTRNSANCTN_SN,
			CDLT_PRESENTN_AT,
			ACMSLTPROOF_PRESENTN_AT,
			FILE_GROUP_SN,
			SPTDC_AT,
			SPTDC_DT,
			SPTDC_PLACE
			, BID_GTN_RT
		) VALUES (
			#{bidPblancSn},
			#{bidSj},
			#{scsbMth},
			#{bidCn},
			SYSDATE,
			#{bidClosDt},
			NULLIF(#{bidSttus}, 0),
			NULLIF(#{elctrnsanctnSn}, 0),
			#{cdltPresentnAt},
			#{acmsltproofPresentnAt},
			#{fileGroupSn},
			#{sptdcAt},
			#{sptdcDt},
			#{sptdcPlace},
			#{bidGtnRt}
		)
	</insert>
	
	<select id="getTotal" resultType="int" parameterType="hashMap">
			select count(*)
				from BID_PBLANC
				where 1 = 1
				<include refid="where"></include>
	</select>
	
	<resultMap type="bidPblancVO" id="bidPblancVOMap">
		<result property="rnum" column="RNUM"/>
		<result property="bidGtnRt" column="BID_GTN_RT"/>
		<result property="cdltPresentnAt" column="CDLT_PRESENTN_AT"/>
		<result property="acmsltproofPresentnAt" column="ACMSLTPROOF_PRESENTN_AT"/>
		<result property="fileGroupSn" column="FILE_GROUP_SN"/>
		<result property="sptdcAt" column="SPTDC_AT"/>
		<result property="sptdcDt" column="SPTDC_DT"/>
		<result property="sptdcPlace" column="SPTDC_PLACE"/>
		<result property="bidPblancSn" column="BID_PBLANC_SN"/>
		<result property="bidSj" column="BID_SJ"/>
		<result property="scsbMth" column="SCSB_MTH"/>
		<result property="bidCn" column="BID_CN"/>
		<result property="pblancDt" column="PBLANC_DT"/>
		<result property="bidClosDt" column="BID_CLOS_DT"/>
		<result property="bidSttus" column="BID_STTUS"/>
		<result property="elctrnsanctnSn" column="ELCTRNSANCTN_SN"/>
		<collection property="bdderVOList" resultMap="bdderVOMap"></collection>
	</resultMap>
	
	<resultMap type="bdderVO" id="bdderVOMap">
		<result property="ccpyManageId" column="CCPY_MANAGE_ID"/>
		<result property="bidGtn" column="BID_GTN"/>
		<result property="bdderSn" column="BDDER_SN"/>
		<result property="bidSportDt" column="BID_SPORT_DT"/>
		<result property="bidAmount" column="BID_AMOUNT"/>
		<result property="bidPblancSn" column="BID_PBLANC_SN"/>
		<result property="bidAt" column="BID_AT"/>
		<association property="ccpyManageVO" resultMap="ccpyManageVOMap"></association>
	</resultMap>
	
	<resultMap type="ccpyManageVO" id="ccpyManageVOMap">
		<result property="ccpyRegistdt" column="CCPY_REGISTDT"/>
		<result property="ccpySttus" column="CCPY_STTUS"/>
		<result property="ccpyManageId" column="CCPY_MANAGE_ID"/>
		<result property="ccpyCmpnyNm" column="CCPY_CMPNY_NM"/>
		<result property="ccpyAdres" column="CCPY_ADRES"/>
		<result property="ccpyTelno" column="CCPY_TELNO"/>
		<result property="ccpyRprsntvNm" column="CCPY_RPRSNTV_NM"/>
		<result property="ccpyBizrno" column="CCPY_BIZRNO"/>
		<result property="ccpyEmail" column="CCPY_EMAIL"/>
		<result property="ccpyPassword" column="CCPY_PASSWORD"/>
		<result property="fileGroupSn" column="CCPY_FILE_GROUP_SN"/>
		<result property="ccpyOpbizDe" column="CCPY_OPBIZ_DE"/>
	</resultMap>
	
	<select id="getBidPblancList" resultMap="bidPblancVOMap" parameterType="hashMap">
		<include refid="commonMapper.pageHeader"></include>
		        SELECT 	a.BID_PBLANC_SN
		        		, a.BID_SJ
		        		, a.SCSB_MTH
		        		, a.BID_CN
		        		, a.PBLANC_DT
		        		, a.BID_CLOS_DT
		        		, a.BID_STTUS
		        		, a.ELCTRNSANCTN_SN
		        		, a.CDLT_PRESENTN_AT
		        		, a.ACMSLTPROOF_PRESENTN_AT
		        		, a.FILE_GROUP_SN
		        		, a.SPTDC_AT
		        		, a.SPTDC_DT
		        		, a.SPTDC_PLACE
		        		, BID_GTN_RT,
		        		b.BDDER_SN, 
		        		b.BID_SPORT_DT, 
		        		b.BID_AMOUNT, 
		        		b.BID_AT, 
		        		b.BID_GTN, 
		        		b.CCPY_MANAGE_ID
		        		, c.CCPY_CMPNY_NM
		        		, c.CCPY_ADRES
		        		, c.CCPY_TELNO
		        		, c.CCPY_RPRSNTV_NM
		        		, c.CCPY_BIZRNO
		        		, c.CCPY_EMAIL
		        		, c.CCPY_PASSWORD
		        		, c.FILE_GROUP_SN as CCPY_FILE_GROUP_SN
		        		, c.CCPY_OPBIZ_DE
		        		, c.CCPY_STTUS
		        		, c.CCPY_REGISTDT
		        	FROM  bid_pblanc a
			        left outer join bdder b on(a.BID_PBLANC_SN = b.BID_PBLANC_SN)
			        left outer join ccpy_manage c on(c.CCPY_MANAGE_ID = b.CCPY_MANAGE_ID)  
		        	where 1=1
		        	<include refid="where"></include>
		        	order by a.bid_pblanc_sn desc
		<include refid="commonMapper.pageFooter"></include>
	</select>
	
	<select id="getBidPblancListAsEmp" resultMap="bidPblancVOMap" parameterType="hashMap">
		<include refid="commonMapper.pageHeader"></include>
		        SELECT 	a.BID_PBLANC_SN
		        		, a.BID_SJ
		        		, a.SCSB_MTH
		        		, a.BID_CN
		        		, a.PBLANC_DT
		        		, a.BID_CLOS_DT
		        		, a.BID_STTUS
		        		, a.ELCTRNSANCTN_SN
		        		, a.CDLT_PRESENTN_AT
		        		, a.ACMSLTPROOF_PRESENTN_AT
		        		, a.FILE_GROUP_SN
		        		, a.SPTDC_AT
		        		, a.SPTDC_DT
		        		, a.SPTDC_PLACE
		        		, BID_GTN_RT,
		        		b.BDDER_SN, 
		        		b.BID_SPORT_DT, 
		        		b.BID_AMOUNT, 
		        		b.BID_AT, 
		        		b.BID_GTN, 
		        		b.CCPY_MANAGE_ID
		        		, c.CCPY_CMPNY_NM
		        		, c.CCPY_ADRES
		        		, c.CCPY_TELNO
		        		, c.CCPY_RPRSNTV_NM
		        		, c.CCPY_BIZRNO
		        		, c.CCPY_EMAIL
		        		, c.CCPY_PASSWORD
		        		, c.FILE_GROUP_SN as CCPY_FILE_GROUP_SN
		        		, c.CCPY_OPBIZ_DE
		        		, c.CCPY_STTUS
		        		, c.CCPY_REGISTDT
		        	FROM  bid_pblanc a
			        left outer join bdder b on(a.BID_PBLANC_SN = b.BID_PBLANC_SN)
			        inner join ccpy_manage c on(c.CCPY_MANAGE_ID = b.CCPY_MANAGE_ID)  
		        	where 1=1
		        	<include refid="where"></include>
		        	order by a.bid_pblanc_sn desc
		<include refid="commonMapper.pageFooter"></include>
	</select>
	
	<select id="getBidPblancVO" parameterType="bidPblancVO" resultType="bidPblancVO">
		select 	*
			from bid_pblanc 
			where bid_pblanc_sn = #{bidPblancSn}
	</select>
	
	<!-- 정문페이지에 글3개 셀렉해오기(나혜선) -->
	<select id="maingateget" resultType="BidPblancVO">
	SELECT
	    bid_pblanc_sn,
	    bid_sj,
	    scsb_mth,
	    bid_cn,
	    pblanc_dt,
	    bid_clos_dt,
	    bid_sttus,
	    elctrnsanctn_sn,
	    cdlt_presentn_at,
	    acmsltproof_presentn_at,
	    file_group_sn,
	    sptdc_at,
	    sptdc_dt,
	    sptdc_place,
	    bid_gtn_rt
	FROM
	  (SELECT
	    bid_pblanc_sn,
	    bid_sj,
	    scsb_mth,
	    bid_cn,
	    pblanc_dt,
	    bid_clos_dt,
	    bid_sttus,
	    elctrnsanctn_sn,
	    cdlt_presentn_at,
	    acmsltproof_presentn_at,
	    file_group_sn,
	    sptdc_at,
	    sptdc_dt,
	    sptdc_place,
	    bid_gtn_rt
	  FROM
	    bid_pblanc
	ORDER BY pblanc_dt DESC)
	WHERE ROWNUM <![CDATA[<=]]> 5		
	</select>
	
	<update id="putBidPblanc" parameterType="bidPblancVO">
		update BID_PBLANC
		set BID_STTUS = 2
		where BID_PBLANC_SN = #{bidPblancSn}
	</update>
</mapper>