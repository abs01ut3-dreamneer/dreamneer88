<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>

<!DOCTYPE html>
<html lang="ko">
<!-- 우편번호 daum api -->
<!-- 주소검색 script 시작 -->
<script
	src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
let baseAddress = "";

function sample4_execDaumPostcode() {
  new daum.Postcode({
    oncomplete: function (data) {
      // 도로명/지번 중 선택된 주소만 사용 (우편번호 제외)
      baseAddress = (data.userSelectedType === 'R') ? data.roadAddress : data.jibunAddress;

      // 기본주소만 먼저 세팅
      const adresInput = document.getElementById("adres");
      adresInput.value = baseAddress;

      // 상세주소가 이미 써져 있다면 같이 합쳐서 보여주기
      combineAddress();
    }
  }).open();
}
// 상세주소 입력을 기본주소 뒤에 합쳐서 adres에 세팅
function combineAddress() {
  const detail = document.getElementById("adresDetail").value.trim();
  const adresInput = document.getElementById("adres");
  const base = baseAddress || adresInput.value.split(/\s{2,}|$/)[0].trim();

  adresInput.value = detail ? (base + " " + detail).trim() : base;
}

// 상세주소 타이핑할 때마다 합치기
document.addEventListener("DOMContentLoaded", function () {
  const detailInput = document.getElementById("adresDetail");
  if (detailInput) {
    detailInput.addEventListener("input", combineAddress);
  }

});
//주소검색 script끝

</script>
<script type="text/javascript">
    function addrCheck() {
        if($("#zipCode").val() == '' && $("#streetAdr").val() == ''){
            alert("우편번호를 클릭하여 주소를 검색해주세요.");
            $("#zipCode").focus();
        }
    }
</script>


<!-- /// header 시작  -->
<%@ include file="../include/header.jsp"%>
<!-- /// header 끝 /// -->
<!-- body시작은 header 에서부터  -->


<%-- ${emp2VO} --%>
<h2>${emp2VO.nm}님 안녕하세요</h2>
<th>직원사진</th>
<td>프로필

	<div id="imgPreview" style="width: 50%;"></div>
<td>개발용FILE_GROUP_SN: ${emp2VO.fileGroupSn}

	<form id="frmSubmit" action="/emp/empEdit" method="post"
		enctype="multipart/form-data">
		<td><c:forEach var="myImg"
				items="${emp2VO.empFileVOs.fileDetailVOList}">
				<li><img src="/upload${myImg.fileStrelc}"
					alt="${myImg.fileOrginlNm}"
					style="width: 120px; border-radius: 6px;"></li>
			</c:forEach> <input id="img" type="file" name="uploadFiles" placeholder="직원 이미지" />
			<input id="empPassword" type="hidden" name="empPassword"
			value="${emp2VO.empPassword}" /> <input id="nm" type="hidden"
			name="nm" value="${emp2VO.nm}" /> <input id="clsf" type="hidden"
			name="clsf" value="${emp2VO.clsf}" /> <input id="salary"
			type="hidden" name="salary" value="${emp2VO.salary}" />

			<div class="card-body table-responsive p-0">
				<table class="table table-hover text-nowrap">
					<tbody>
						<tr>
							<td>이름</td>
							<td>${emp2VO.nm}</td>
						</tr>
						<tr>
							<td>전화번호</td>
							<td><input id="telno" type="text" name="telno"
								value="${emp2VO.telno}" /></td>
						</tr>
						<tr>
							<td>생년월일</td>
							<td><input id="brthdy" type="text" name="brthdy"
								value="${emp2VO.brthdy}" placeholder="8자리숫자입력" /></td>
						</tr>
						<tr>
							<td>이메일</td>
							<td><input id="email" type="text" name="email"
								value="${emp2VO.email}" /></td>

						</tr>
						<tr>
							<td>주소</td>
							<td><input type="text" id="adres" name="adres"
								placeholder="주소를 클릭하여 검색하세요" value="${emp2VO.adres}" readonly
								onclick="sample4_execDaumPostcode()"> <!-- 상세주소: 동/호, 건물명 등 -->
								<input type="text" id="adresDetail" placeholder="상세주소 (동/호)"></td>
						</tr>
						<tr>
							<td>부서</td>
							<td><select id="deptCode" name="deptCode">
									<option value="1"
										<c:if test="${emp2VO.deptCode == 1}">selected</c:if>>관리사무실</option>
									<option value="2"
										<c:if test="${emp2VO.deptCode == 2}">selected</c:if>>시설</option>
									<option value="3"
										<c:if test="${emp2VO.deptCode == 3}">selected</c:if>>경비</option>
							</select></td>
						</tr>

						<tr>
							<td>재직상태</td>
							<td><label> <input type="radio" name="enabled"
									value="1" <c:if test="${emp2VO.enabled == 1}">checked</c:if> />
									재직
							</label> <label> <input type="radio" name="enabled" value="2"
									<c:if test="${emp2VO.enabled == 2}">checked</c:if> /> 휴직
							</label> <label> <input type="radio" name="enabled" value="3"
									<c:if test="${emp2VO.enabled == 3}">checked</c:if> /> 퇴사
							</label></td>
						</tr>
					</tbody>
				</table>
			</div> <!-- 	</td> --> <%-- 	<td><input id="nm" type="text" name="nm" value="${emp2VO.nm}" /></td> --%>
			<!-- 	<td><input id="telno" type="text" name="telno" --> <%-- 		value="${emp2VO.telno}" /></td> --%>
			<!-- 	<td><input id="empPassword" type="text" name="empPassword" -->
			<%-- 		value="${emp2VO.empPassword}" /></td> --%> <!-- 	<td><input id="email" type="text" name="email" -->
			<%-- 		value="${emp2VO.email}" /></td> --%> <!-- 	<td><input id="adres" type="text" name="adres" -->
			<%-- 		value="${emp2VO.adres}" /></td> --%> <!-- 	<td><input id="brthdy" type="text" name="brthdy" -->
			<%-- 		value="${emp2VO.brthdy}" /></td> --%> <!-- 	<td><input id="salary" type="text" name="salary" -->
			<%-- 		value="${emp2VO.salary}" /></td> --%> <!-- 	<td><input id="deptCode" type="text" name="deptCode" -->
			<%-- 		value="${emp2VO.deptCode}" /></td> --%> <!-- 	<td><input id="enabled" type="text" name="enabled" -->
			<%-- 		value="${emp2VO.enabled}" /></td> --%>
			<button type="submit"
				class="btn btn-block bg-gradient-success btn-lg">수정하기</button>
	</form> <!-- <ul> --> <%-- 	<li>직원ID: ${emp2VO.empId}</li> --%> <%-- 	<li>이름: ${emp2VO.nm}</li> --%>
	<%-- 	<li>부서코드: ${emp2VO.deptCode}</li> --%> <!-- </ul> -->

	<hr />

	<h3>인감</h3> <!-- 서명관리 버튼 -->
	<button type="button" class="btn btn-app bg-secondary"
		data-toggle="modal" data-target="#signModal">서명관리</button> <!-- 서명 수정 모달 -->
	<div class="modal fade" id="signModal" tabindex="-1" role="dialog"
		aria-labelledby="signModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content" id="signModalContent">
				<div class="modal-header">
					<h4 class="modal-title" id="signModalLabel">인감 수정모달</h4>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">×</span>
					</button>
				</div>

				<!-- 모달 안에 multipart/form-data 폼 -->
				<form id="signForm" enctype="multipart/form-data">
					<div class="modal-body">
						<!-- 현재 서명 이미지(있을 때만) -->
						<c:if test="${not empty signVO and not empty signVO.fileDetailVO}">
							<img id="currentSignImg"
								src="/upload${signVO.fileDetailVO.fileStrelc}"
								alt="${signVO.fileDetailVO.fileOrginlNm}"
								style="width: 120px; border-radius: 6px; margin-bottom: 10px;">
						</c:if>

						<!-- 업로드 인풋 & 미리보기 -->
						<div class="form-group">
							<label for="SignImg">도장 이미지</label> <input id="SignImg"
								type="file" name="uploadFiles" class="form-control-file" />
						</div>
						<div>이미지미리보기영역</div>
						<div id="SignImgPreview" style="width: 120px; border-radius: 6px;"></div>

						<!-- 서버로 보낼 값. (개발끝나면 hidden처리할거엥) -->
						<input type="text" name="empId" value="${signVO.empId}">
						<c:if test="${not empty signVO and not empty signVO.signId}">
							<input type="text" name="signId" value="${signVO.signId}">
						</c:if>
						<c:if test="${not empty emp2VO and not empty emp2VO.fileGroupSn}">
							<input type="text" name="fileGroupSn"
								value="${emp2VO.fileGroupSn}">
						</c:if>
						<c:if test="${not empty signVO and not empty signVO.uploadFiles}">
							<input type="text" name="uploadFiles"
								value="${signVO.uploadFiles}">
						</c:if>
					</div>

					<div class="modal-footer justify-content-between">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<!-- 저장 버튼에 id 부여 -->
						<button type="button" id="btnSubmit" class="btn btn-primary">Save
							changes</button>
						<!-- ======================= 인감 생성 버튼 ======================= -->
						<form method="post" action="/emp/insertSign">
							<!-- 이미 Sign테이블에 signId가 있다면 serviceImpl에서 반환처리해서 반응이 없어요 -->
							<button type="submit" class="btn btn-app bg-success">인감
								생성</button>
						</form>
						<!-- ============================================================= -->
					</div>
				</form>
			</div>
		</div>
	</div> <a href="/emp/empMyPage/${empId}">수정취소</a> <%@ include
		file="../include/footer.jsp"%> <!-- /// footer 끝 /// -->





	<script>
					//프로필이미지 미리보기
					//e : onchange 이벤트 객체
					document.addEventListener("DOMContentLoaded", function () {
						const fileInput = document.getElementById("img");
						fileInput.addEventListener("change", function (e) {
							handleImgFileSelect(e, "imgPreview");
						});

						//1. handleImgFileSelect(e,"#img");
						function handleImgFileSelect(t, targetId) {
							//1. 이벤트가 발생 된 타겟 안에 들어있는 이미지 파일들을 가져와보자
							const files = t.target.files;

							//2. 이미지가 여러개가 있을 수 있으므로 이미지들을 각각 분리해서 배열로 만듦
							//files : {개똥이.jpg, 개똥삼.jpg, 개똥오.jpg}
							//fileArr : [개똥이.jpg, 개똥삼.jpg, 개똥오.jpg]
							const fileArr = Array.prototype.slice.call(files);

							//preview를 초기화하고
							const container = document.getElementById(targetId);
							if (!container)
								return;
							container.innerHTML = "";

							fileArr.forEach(function (f) {
								//이미지 파일이 아닌 경우 이미지 미리보기 실패 처리
								if (!f.type.match("image.*")) {
									alert("이미지 확장자만 가능합니다");
									//함수 종료
									return;
								}

								//이미지 객체를 읽을 자바스크립트의 reader 객체 생성
								const reader = new FileReader();

								//e : reader가 이미지 객체를 읽는 이벤트
								reader.onload = function (e) {
									const imgl = document.createElement("img");

									//e.target : f(이미지 객체)
									//e.target.result : reader가 이미지를 다 읽은 결과
									imgl.src = e.target.result; // data URL

									container.appendChild(imgl);
								}

								//reader객체로 f(파일 한 개)를 읽음
								reader.readAsDataURL(f);

								//p 사이에 이미지가 렌더링되어 화면에 보임
								//객체.append : 누적, .html : 새로고침, .innerHTML : J/S
							});//end forEach

							/*[참고]******
							arr.forEach(function(str,idx){
								console.log("str : " + str);
							});
							
							$.each(arr,function(idx,str){
								console.log("str[" + idx + "] : " + str);
							});
							 */

						}//end handleImgFileSelect
					});//프로필이미지 미리보기 끝




					//서명 미리보기 시작
					//t : onchange 이벤트 객체
					document.addEventListener("DOMContentLoaded", function () {
						const SignFileInput = document.getElementById("SignImg");
						SignFileInput.addEventListener("change", function (t) {
							handleImgFileSelect(t, "SignImgPreview");
						});

						//1. handleImgFileSelect(e,"#img");
						function handleImgFileSelect(t, targetId) {
							//1. 이벤트가 발생 된 타겟 안에 들어있는 이미지 파일들을 가져와보자
							const files = t.target.files;

							//2. 이미지가 여러개가 있을 수 있으므로 이미지들을 각각 분리해서 배열로 만듦
							//files : {개똥이.jpg, 개똥삼.jpg, 개똥오.jpg}
							//fileArr : [개똥이.jpg, 개똥삼.jpg, 개똥오.jpg]
							const fileArr = Array.prototype.slice.call(files);

							//preview를 초기화하고
							const container = document.getElementById(targetId);
							if (!container)
								return;
							container.innerHTML = "";

							fileArr.forEach(function (f) {
								//이미지 파일이 아닌 경우 이미지 미리보기 실패 처리(MIME타입)
								if (!f.type.match("image.*")) {
									alert("이미지 확장자만 가능합니다");
									//함수 종료
									return;
								}

								// reader 객체 생성
								const reader = new FileReader();

								//reader가 이미지 객체를 읽는 이벤트
								reader.onload = function (t) {
									const img2 = document.createElement("img");

									//e.target : ㅅ(이미지 객체)
									//e.target.result : reader가 이미지를 다 읽은 결과
									img2.src = t.target.result; // data URL

									container.appendChild(img2);
								}

								//reader객체로 f(파일 한 개)를 읽음
								reader.readAsDataURL(f);

							});//end forEach

						}//end handleImgFileSelect
					});//서명 미리보기 끝















					//Fetch로 데이터전송하기 (사인 이미지만 보냄)
					/*DOMContentLoaded이벤트 
					트리가 다 만들어진 후에 돔에 접근이 가능하기때문에, 돔이 생성되기전 돔을
						조작하는 자바스크립트 코드가 실행되어 원하지 않는 결과를 내는것을 막을 수 있음
					DOMContentLoaded 이벤트가 load이벤트보다 앞서 발생
					 */
					document.addEventListener("DOMContentLoaded", function () {
						//확인버튼 처리
						//<button type="button" id="btnSubmit" class="btn btn-primary">확인</button>
						const submitInput = document.querySelector("#btnSubmit");

						submitInput.addEventListener("click", function () {
							const signForm = document.querySelector("#signForm");
							const formData = new FormData(signForm);

							//아이디, 상품명, 가격, 개요 + 다중이미지파일들 추가
							//ItemVO(itemId=1, itemName=삼성태블릿, price=120000, description=쓸만함
							//	, pictureUrl=/2025/09/08/asdldfksj_개똥이.jpg, uploadFile=
							// 	 formData.append("deptCode",document.querySelector("input[name='deptCode']").value);
							// 	 formData.append("enabled",document.querySelector("input[name='enabled']").value);

							// name 속성이 'uploadFiles'인 <input> 요소를 선택
							// Vanilla JS는 DOM 요소를 직접 반환하므로, 배열 인덱스 [0]이 필요 없음
							const fileElement = document.querySelector("input[name='uploadFiles']");

							// 선택된 파일 목록을 가져옴 (jQuery: fileElement[0].files)
							// <input type="file"> 요소의 .files 속성은 FileList 객체를 반환
							const files = fileElement.files;

							for (const file of files) {
								formData.append("uploadFiles", file);
							}

							//formData 확인
							for (const [key, value] of formData.entries()) {
								console.log(key, value);
							};

							// 			참고 : 첨부파일이 없을 때(JSON Object)
							// 			fetch("/api/articles",{
							// 				method:"POST",
							// 				headers:{
							// 					"Content-Type":"application/json",
							// 				},
							// 				body:JSON.stringify(data)
							// 			})

							//fetch API를 사용하여 /item2/editPostAjax 엔드포인트로 POST 요청을 보냄
							//첨부파일이 있을 때(formData)
							fetch("/emp/empSignEdit", {// Spring Controller의 매핑 주소
								method: "post",//HTTP 메서드 설정
								body: formData,// 2. 요청 본문 설정 (FormData 객체를 그대로 사용)
							})
								.then(response => {
									// HTTP 상태 코드 확인 (4xx, 5xx 에러를 잡아내기 위함)
									if (!response.ok) {
										throw new Error(`HTTP error! Status: \${response.status}`);
										

									}
									// dataType: "json" 처리: 응답 본문을 JSON 객체로 파싱함
									return response.json();
								})
								.then(result => {
									//map.put("result", result);
									//result{"result":"1"}
									console.log("result : ", result);

									// 필요한 성공 후 로직을 여기에 작성
									// 예: alert("성공!");
								})
								.catch(error => {
									console.error("Fetch 요청 오류 발생:", error);
								});
						});

						//vanillaJS
						const SignFileInput = document.querySelector("input[name='uploadFiles']");

						fileInput.addEventListener("change", function (e) {
							handleImgFileSelect(e, "imgPreview");
						});
					});





				</script>